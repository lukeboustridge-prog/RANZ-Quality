---
phase: 13-programme-enrolment
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/app/api/admin/programme/route.ts
  - src/app/api/admin/programme/[id]/route.ts
  - src/app/(admin)/admin/programme/page.tsx
  - src/app/(admin)/layout.tsx
  - src/app/api/admin/stats/route.ts
autonomous: true

must_haves:
  truths:
    - "RANZ admin can see a list of all enrolment applications with status filters"
    - "RANZ admin can approve a PENDING application (sets status to ACTIVE, activeSince, anniversaryDate)"
    - "RANZ admin can reject a PENDING application (sets status to WITHDRAWN with notes)"
    - "RANZ admin can suspend an ACTIVE or RENEWAL_DUE enrolment (sets status to SUSPENDED with reason)"
    - "RANZ admin can reinstate a SUSPENDED enrolment (sets status back to ACTIVE)"
    - "Admin dashboard stats include programme enrolment counts"
  artifacts:
    - path: "src/app/api/admin/programme/route.ts"
      provides: "GET list of enrolments with filtering"
      exports: ["GET"]
    - path: "src/app/api/admin/programme/[id]/route.ts"
      provides: "PATCH endpoint for status changes (approve/reject/suspend/reinstate)"
      exports: ["PATCH"]
    - path: "src/app/(admin)/admin/programme/page.tsx"
      provides: "Admin enrolment management page"
    - path: "src/app/(admin)/layout.tsx"
      provides: "Updated admin nav with Programme link"
      contains: "Programme"
  key_links:
    - from: "src/app/(admin)/admin/programme/page.tsx"
      to: "/api/admin/programme"
      via: "fetch GET for list"
      pattern: "fetch.*api/admin/programme"
    - from: "src/app/(admin)/admin/programme/page.tsx"
      to: "/api/admin/programme/[id]"
      via: "fetch PATCH for status changes"
      pattern: "fetch.*api/admin/programme.*method.*PATCH"
    - from: "src/app/api/admin/programme/[id]/route.ts"
      to: "prisma.programmeEnrolment.update"
      via: "database update"
      pattern: "prisma\\.programmeEnrolment\\.update"
---

<objective>
Build the RANZ admin interface for reviewing, approving, rejecting, suspending, and reinstating programme enrolments so that RANZ administrators can manage the full enrolment lifecycle.

Purpose: RANZ admin is the gatekeeper for programme membership. Without admin review and status management, applications would remain permanently in PENDING state and the programme has no governance.

Output: Admin enrolment list page, status change API endpoints, admin nav updated, admin dashboard stats include programme data.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-programme-enrolment/13-01-SUMMARY.md
@src/app/(admin)/layout.tsx
@src/app/(admin)/admin/page.tsx
@src/app/(admin)/admin/members/page.tsx
@src/app/api/admin/stats/route.ts
@src/lib/audit-log.ts
@src/lib/notifications.ts
@src/types/index.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin API endpoints for enrolment management</name>
  <files>
    src/app/api/admin/programme/route.ts
    src/app/api/admin/programme/[id]/route.ts
  </files>
  <action>
    1. Create src/app/api/admin/programme/route.ts:
       - GET endpoint that requires Clerk auth with ranz:admin or ranz:auditor role check
       - Use the same admin role-check pattern as other admin API routes (check user publicMetadata.role)
       - Query all ProgrammeEnrolment records with:
         - include: { organization: { select: { id, name, tradingName, nzbn, certificationTier, complianceScore, email, city } } }
         - Support ?status= query param to filter by status (optional)
         - Support ?search= query param for org name search (optional)
         - Order by: PENDING first (most actionable), then by appliedAt desc
       - Return JSON array of enrolments with org details

    2. Create src/app/api/admin/programme/[id]/route.ts:
       - PATCH endpoint requiring ranz:admin role (NOT ranz:auditor -- auditors can view but not modify)
       - Accept JSON body with Zod validation:
         ```typescript
         const schema = z.object({
           action: z.enum(["approve", "reject", "suspend", "reinstate"]),
           notes: z.string().max(500).optional(),
           reason: z.string().max(500).optional(), // For suspend
         });
         ```
       - Action handlers:
         - **approve**: Require current status is PENDING. Set status=ACTIVE, activeSince=now(), anniversaryDate=now()+1year, reviewedAt=now(), reviewedBy=userId, reviewNotes=notes. Log ENROL_APPROVE audit event. Send PROGRAMME_STATUS_CHANGE notification to org.
         - **reject**: Require current status is PENDING. Set status=WITHDRAWN, reviewedAt=now(), reviewedBy=userId, reviewNotes=notes. Log ENROL_REJECT audit event. Send PROGRAMME_STATUS_CHANGE notification to org.
         - **suspend**: Require current status is ACTIVE or RENEWAL_DUE. Set status=SUSPENDED, suspendedAt=now(), suspendedBy=userId, suspendedReason=reason. Log ENROL_SUSPEND audit event. Send PROGRAMME_STATUS_CHANGE notification to org.
         - **reinstate**: Require current status is SUSPENDED. Set status=ACTIVE, suspendedAt=null, suspendedBy=null, suspendedReason=null. Log ENROL_REINSTATE audit event. Send PROGRAMME_STATUS_CHANGE notification to org.
       - For notifications, use createNotification from @/lib/notifications with:
         - type: "PROGRAMME_STATUS_CHANGE"
         - channel: "EMAIL" (in-app also if supported)
         - organizationId: enrolment.organizationId
         - title: "RoofWright Programme Status Update"
         - message: Contextual message based on action (e.g., "Your RoofWright programme application has been approved")
         - actionUrl: "/programme"
       - Return updated enrolment with 200 status

    IMPORTANT: Validate that the enrolment exists and belongs to a valid org. Return 404 if not found. Return 400 if status transition is invalid (e.g., trying to approve an already ACTIVE enrolment).
  </action>
  <verify>
    Run `pnpm typecheck` passes.
    Run `pnpm build` succeeds.
    Manually test: curl or API client can POST approve/reject/suspend/reinstate.
  </verify>
  <done>
    GET /api/admin/programme returns list of all enrolments with org details, supports status and search filters.
    PATCH /api/admin/programme/[id] handles approve/reject/suspend/reinstate with proper status validation.
    All status changes are logged to audit trail.
    Notifications sent to org on status changes.
    Invalid transitions return 400.
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin enrolment page, nav update, and dashboard stats</name>
  <files>
    src/app/(admin)/admin/programme/page.tsx
    src/app/(admin)/layout.tsx
    src/app/api/admin/stats/route.ts
  </files>
  <action>
    1. Create src/app/(admin)/admin/programme/page.tsx:
       - "use client" component (admin layout is client-side)
       - Follow the pattern from admin/members/page.tsx (fetch on mount, search, filters, table display)
       - Header: "Programme Enrolments" with count badge
       - Filter bar: Status dropdown (All, Pending, Active, Renewal Due, Suspended, Withdrawn) + Search input
       - Table/cards showing each enrolment with:
         - Organization name, trading name, tier badge, city
         - Application date (appliedAt)
         - Current status with color-coded badge (same colors as dashboard: PENDING=yellow, ACTIVE=green, RENEWAL_DUE=amber, SUSPENDED=red, WITHDRAWN=slate)
         - Anniversary date (if active)
         - Compliance score
       - Action buttons per row based on current status:
         - PENDING: "Approve" (green) + "Reject" (red) buttons
         - ACTIVE/RENEWAL_DUE: "Suspend" (red) button
         - SUSPENDED: "Reinstate" (green) button
         - WITHDRAWN: no actions
       - Clicking action opens a confirmation dialog (use window.confirm or a simple modal) with optional notes/reason textarea
       - On action success: refetch the list, show success message
       - Use existing UI components: Card, Badge, Button, Input, Select

    2. Update src/app/(admin)/layout.tsx:
       - Add "Programme" to the navigation array after "Members":
         ```
         { name: "Programme", href: "/admin/programme", icon: Award }
         ```
       - Import Award from lucide-react

    3. Update src/app/api/admin/stats/route.ts:
       - Add programme enrolment stats to the response:
         ```typescript
         programme: {
           total: number,
           pending: number,
           active: number,
           renewalDue: number,
           suspended: number,
         }
         ```
       - Query using prisma.programmeEnrolment.groupBy or count with where clauses
       - Add this to the existing stats response object (do not break existing stats shape)
  </action>
  <verify>
    Run `pnpm typecheck` passes.
    Run `pnpm build` succeeds.
    Admin nav shows "Programme" link.
    /admin/programme page renders enrolment list.
    Admin dashboard shows programme stats.
  </verify>
  <done>
    Admin nav includes "Programme" with Award icon.
    /admin/programme page shows filterable list of all enrolments.
    Admin can approve PENDING applications (sets ACTIVE, activeSince, anniversaryDate).
    Admin can reject PENDING applications (sets WITHDRAWN).
    Admin can suspend ACTIVE/RENEWAL_DUE enrolments (sets SUSPENDED with reason).
    Admin can reinstate SUSPENDED enrolments (sets ACTIVE).
    Admin dashboard /admin shows programme enrolment counts.
    All actions trigger audit log entries and org notifications.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm build` succeeds
3. Admin nav shows Programme link
4. /admin/programme loads with enrolment list
5. Approve/reject/suspend/reinstate actions work via API
6. Admin dashboard stats include programme data
7. Audit logs created for all status changes
</verification>

<success_criteria>
- RANZ admin can view all enrolment applications with filtering
- All 4 status transition actions work (approve, reject, suspend, reinstate)
- Status transitions are validated (no invalid state changes)
- Audit trail logs all admin actions
- Notifications sent to affected organizations
- Admin dashboard includes programme stats
</success_criteria>

<output>
After completion, create `.planning/phases/13-programme-enrolment/13-02-SUMMARY.md`
</output>
