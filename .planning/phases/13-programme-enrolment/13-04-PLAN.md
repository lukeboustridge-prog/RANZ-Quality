---
phase: 13-programme-enrolment
plan: 04
type: execute
wave: 3
depends_on: ["13-01", "13-02"]
files_modified:
  - src/app/api/cron/notifications/route.ts
  - docs/member-guide.md
  - docs/admin-guide.md
autonomous: true

must_haves:
  truths:
    - "Cron job checks for upcoming programme anniversaries and sends 90/60/30-day renewal reminders"
    - "Renewal reminders set the renewalAlert flags to prevent duplicate sends"
    - "ACTIVE enrolments transition to RENEWAL_DUE when within 90 days of anniversary"
    - "User documentation covers programme enrolment for both members and admins"
  artifacts:
    - path: "src/app/api/cron/notifications/route.ts"
      provides: "Cron with programme renewal check"
      contains: "checkProgrammeRenewals"
    - path: "docs/member-guide.md"
      provides: "Member-facing programme documentation"
      contains: "RoofWright Programme"
    - path: "docs/admin-guide.md"
      provides: "Admin-facing programme management documentation"
      contains: "Programme Enrolment Management"
  key_links:
    - from: "src/app/api/cron/notifications/route.ts"
      to: "prisma.programmeEnrolment"
      via: "query for upcoming anniversaries"
      pattern: "programmeEnrolment.*findMany"
    - from: "src/app/api/cron/notifications/route.ts"
      to: "createNotification"
      via: "sends PROGRAMME_RENEWAL notifications for 90/60/30-day alerts"
      pattern: "createNotification.*PROGRAMME_RENEWAL"
---

<objective>
Integrate programme renewal reminders into the existing notification cron job and update user documentation to cover the programme enrolment workflow.

Purpose: The cron job is the proactive safety net -- it ensures organisations are reminded before their annual renewal is due, preventing accidental lapses. Documentation completes the user experience so members and admins understand the programme workflow without guessing.

Output: Updated cron job with renewal checks, updated member guide, updated admin guide.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-programme-enrolment/13-01-SUMMARY.md
@.planning/phases/13-programme-enrolment/13-02-SUMMARY.md
@src/app/api/cron/notifications/route.ts
@src/lib/notifications.ts
@docs/member-guide.md
@docs/admin-guide.md
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Programme renewal check in notification cron job</name>
  <files>
    src/app/api/cron/notifications/route.ts
  </files>
  <action>
    1. Add a renewal check function to src/app/api/cron/notifications/route.ts:
       - Create async function `checkProgrammeRenewals(): Promise<number>` (follows existing pattern like checkInsuranceExpiries)
       - Query programmeEnrolments where status is ACTIVE and anniversaryDate is within 90 days from now:
         ```typescript
         const now = new Date();
         const in90Days = new Date(now.getTime() + 90 * 24 * 60 * 60 * 1000);

         const enrolments = await db.programmeEnrolment.findMany({
           where: {
             status: "ACTIVE",
             anniversaryDate: { lte: in90Days, gt: now },
           },
           include: { organization: { select: { id: true, name: true, email: true } } },
         });
         ```
       - For each enrolment, check which alerts haven't been sent:
         - 90-day: anniversaryDate - now <= 90 days AND renewalAlert90Sent is false
         - 60-day: anniversaryDate - now <= 60 days AND renewalAlert60Sent is false
         - 30-day: anniversaryDate - now <= 30 days AND renewalAlert30Sent is false
       - For each triggered alert:
         - Call createNotification with type: "PROGRAMME_RENEWAL", channel: "EMAIL"
         - Title: "RoofWright Programme Renewal Reminder"
         - Message: "Your RoofWright programme membership is due for renewal in {X} days (on {anniversaryDate}). Please ensure your organisation remains compliant."
         - actionUrl: "/programme"
         - organizationId: enrolment.organizationId
         - Update the corresponding renewalAlertXXSent flag to true
         - Also update status to RENEWAL_DUE if <= 90 days and currently ACTIVE (this is the status transition that triggers the visual change on dashboard and verification page)
       - Return count of notifications sent

    2. Integrate into the cron GET handler:
       - Add `programmeRenewals: 0` to the results object
       - Add step: `results.programmeRenewals = await checkProgrammeRenewals();`
       - Place this after the document review check (step 5) and before audit scheduling (step 6)
       - Add programmeRenewals to the response JSON
  </action>
  <verify>
    Run `pnpm typecheck` passes.
    Run `pnpm build` succeeds.
    Cron route file compiles and includes checkProgrammeRenewals in the flow.
  </verify>
  <done>
    Cron job checks for programme anniversaries within 90 days.
    Sends renewal reminders at 90, 60, and 30-day intervals via createNotification.
    Sets renewalAlertXXSent flags to prevent duplicate notifications.
    Transitions ACTIVE to RENEWAL_DUE status when within 90 days of anniversary.
  </done>
</task>

<task type="auto">
  <name>Task 2: Documentation updates for member and admin guides</name>
  <files>
    docs/member-guide.md
    docs/admin-guide.md
  </files>
  <action>
    1. Update docs/member-guide.md:
       - Add a "RoofWright Programme" section (place after the CAPA section and before FAQ/troubleshooting):
         - How to find the Programme page in the sidebar (Award icon)
         - How to apply for enrolment (navigate to /programme, click "Apply to Enrol", fill optional message, submit)
         - What the status badges mean:
           - Pending Review: Application submitted, awaiting RANZ admin review
           - Active: Enrolled in the programme, badge visible on dashboard and public verification
           - Renewal Due: Annual renewal approaching, action may be needed
           - Suspended: Enrolment paused by RANZ admin, contact RANZ for details
         - That renewal reminders are sent at 90, 60, and 30 days before anniversary date
         - That the programme badge appears on the dashboard when enrolled
         - That ACTIVE membership is visible on the public verification page

    2. Update docs/admin-guide.md:
       - Add a "Programme Enrolment Management" section (place after the Members section):
         - How to access the Programme page in admin nav (Award icon under Members)
         - How to review pending applications (filter by Pending status)
         - How to approve an application (click Approve, add optional notes -- sets status to Active with 1-year anniversary)
         - How to reject an application (click Reject, add notes -- sets status to Withdrawn)
         - How to suspend an active enrolment (click Suspend, provide reason)
         - How to reinstate a suspended enrolment (click Reinstate)
         - That all status changes are logged in the audit trail
         - That organisations receive email notifications on status changes
         - That renewal reminders are sent automatically at 90/60/30 days
         - Dashboard stats section includes programme enrolment counts
  </action>
  <verify>
    docs/member-guide.md contains "RoofWright Programme" section with status descriptions.
    docs/admin-guide.md contains "Programme Enrolment Management" section with all workflows.
  </verify>
  <done>
    Member guide documents the programme application flow, status badges, renewal reminders, and dashboard badge.
    Admin guide documents the enrolment management workflow including approve/reject/suspend/reinstate with audit logging.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm build` succeeds
3. Cron endpoint includes programme renewal check
4. docs/member-guide.md has "RoofWright Programme" section
5. docs/admin-guide.md has "Programme Enrolment Management" section
</verification>

<success_criteria>
- Cron job sends renewal reminders at 90/60/30 days before anniversary
- ACTIVE enrolments transition to RENEWAL_DUE at 90 days before anniversary
- Alert flags prevent duplicate notification sends
- Member guide covers programme application, statuses, and renewal reminders
- Admin guide covers full enrolment management lifecycle
</success_criteria>

<output>
After completion, create `.planning/phases/13-programme-enrolment/13-04-SUMMARY.md`
</output>
