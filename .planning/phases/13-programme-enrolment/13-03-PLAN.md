---
phase: 13-programme-enrolment
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/components/dashboard/programme-badge.tsx
  - src/app/(dashboard)/dashboard/page.tsx
  - src/app/verify/[businessId]/page.tsx
  - src/app/api/cron/notifications/route.ts
  - src/lib/notifications.ts
  - docs/member-guide.md
  - docs/admin-guide.md
autonomous: true

must_haves:
  truths:
    - "Dashboard displays RoofWright programme status badge prominently when enrolled"
    - "Public verification page shows RoofWright programme status for enrolled organisations"
    - "Cron job checks for upcoming programme anniversaries and sends 90/60/30-day renewal reminders"
    - "Renewal reminders set the renewalAlert flags to prevent duplicate sends"
    - "User documentation updated to cover programme enrolment"
  artifacts:
    - path: "src/components/dashboard/programme-badge.tsx"
      provides: "Programme status badge component"
      contains: "ProgrammeBadge"
    - path: "src/app/(dashboard)/dashboard/page.tsx"
      provides: "Dashboard with programme badge integrated"
      contains: "ProgrammeBadge"
    - path: "src/app/verify/[businessId]/page.tsx"
      provides: "Public verification showing programme status"
      contains: "RoofWright"
    - path: "src/app/api/cron/notifications/route.ts"
      provides: "Cron with programme renewal check"
      contains: "checkProgrammeRenewals"
  key_links:
    - from: "src/app/(dashboard)/dashboard/page.tsx"
      to: "src/components/dashboard/programme-badge.tsx"
      via: "component import and render"
      pattern: "import.*ProgrammeBadge"
    - from: "src/app/api/cron/notifications/route.ts"
      to: "prisma.programmeEnrolment"
      via: "query for upcoming anniversaries"
      pattern: "programmeEnrolment.*findMany"
    - from: "src/app/verify/[businessId]/page.tsx"
      to: "prisma.organization"
      via: "include programmeEnrolment in query"
      pattern: "programmeEnrolment"
---

<objective>
Add the RoofWright programme badge to the member dashboard, show programme status on the public verification page, and integrate renewal reminders into the existing notification cron job.

Purpose: Programme visibility is the user-facing payoff -- members see their status prominently, the public can verify it, and the system proactively reminds organisations before their annual renewal is due. This completes the full enrolment lifecycle.

Output: Dashboard badge component, updated verification page, cron renewal checks, updated user docs.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-programme-enrolment/13-01-SUMMARY.md
@src/app/(dashboard)/dashboard/page.tsx
@src/app/verify/[businessId]/page.tsx
@src/app/api/cron/notifications/route.ts
@src/lib/notifications.ts
@src/components/dashboard/compliance-score.tsx
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dashboard programme badge and public verification update</name>
  <files>
    src/components/dashboard/programme-badge.tsx
    src/app/(dashboard)/dashboard/page.tsx
    src/app/verify/[businessId]/page.tsx
  </files>
  <action>
    1. Create src/components/dashboard/programme-badge.tsx:
       - Server Component (NOT "use client" -- it receives data as props from the server page)
       - Props: `{ enrolment: { status: ProgrammeEnrolmentStatus; activeSince: Date | null; anniversaryDate: Date | null } | null }`
       - If enrolment is null: render nothing (org hasn't applied yet) -- return null
       - If enrolment exists, render a prominent badge/card:
         - ACTIVE status: Green banner/card with Award icon, "RoofWright Programme Member" title, "Active since {date}" subtitle, with a subtle shield/checkmark graphic. This should be visually prominent -- it's the programme's key value indicator.
         - PENDING status: Yellow/amber card, "RoofWright Programme - Application Pending", "Your application is under review"
         - RENEWAL_DUE status: Amber/orange card with warning icon, "RoofWright Programme - Renewal Due", "Your annual renewal is due on {anniversaryDate}"
         - SUSPENDED status: Red card, "RoofWright Programme - Suspended", link to /programme for details
         - WITHDRAWN: Do not render (return null)
       - Use Tailwind classes, Card from @/components/ui/card, Badge from @/components/ui/badge
       - Import Award, CheckCircle, AlertTriangle, XCircle from lucide-react as status icons
       - Format dates with date-fns format()

    2. Update src/app/(dashboard)/dashboard/page.tsx:
       - Add programmeEnrolment to the Organization include query:
         ```typescript
         programmeEnrolment: {
           select: { status: true, activeSince: true, anniversaryDate: true }
         }
         ```
       - Import ProgrammeBadge from @/components/dashboard/programme-badge
       - Render ProgrammeBadge at the TOP of the dashboard content (before StatsCards), passing organization.programmeEnrolment as the enrolment prop
       - This makes the programme status the FIRST thing the org admin sees

    3. Update src/app/verify/[businessId]/page.tsx:
       - Add programmeEnrolment to the db.organization.findUnique include:
         ```typescript
         programmeEnrolment: {
           select: { status: true, activeSince: true, anniversaryDate: true }
         }
         ```
       - After the "Verification Banner" section (the green "Verified RANZ Member" card), add a "RoofWright Programme" section:
         - Only show if programmeEnrolment exists AND status is ACTIVE or RENEWAL_DUE
         - Render a card with Award icon, "RoofWright Quality Programme" title
         - Show "Active Member" badge (green) for ACTIVE status
         - Show "Member since {activeSince formatted}" text
         - Brief description: "This business participates in the RANZ RoofWright Quality Programme, demonstrating commitment to advanced roofing standards and ongoing professional development."
         - Do NOT show programme info if status is PENDING, SUSPENDED, or WITHDRAWN (these are internal states)
       - Use the same Card/CardContent/Badge patterns already in the verify page
  </action>
  <verify>
    Run `pnpm typecheck` passes.
    Run `pnpm build` succeeds.
    Dashboard shows programme badge when enrolment exists.
    Verify page shows RoofWright section for ACTIVE enrolments.
    Verify page does NOT show programme section for non-enrolled orgs.
  </verify>
  <done>
    ProgrammeBadge component renders status-appropriate badge with correct colors and icons.
    Dashboard displays programme badge prominently at top of page.
    Public verification page shows "RoofWright Quality Programme" card for ACTIVE/RENEWAL_DUE orgs.
    Non-enrolled or PENDING/SUSPENDED orgs do not show programme info on public page.
  </done>
</task>

<task type="auto">
  <name>Task 2: Renewal notification cron and documentation updates</name>
  <files>
    src/app/api/cron/notifications/route.ts
    src/lib/notifications.ts
    docs/member-guide.md
    docs/admin-guide.md
  </files>
  <action>
    1. Add a renewal check function to src/app/api/cron/notifications/route.ts:
       - Create async function `checkProgrammeRenewals(): Promise<number>` (follows existing pattern like checkInsuranceExpiries)
       - Query programmeEnrolments where status is ACTIVE and anniversaryDate is within 90 days from now:
         ```typescript
         const now = new Date();
         const in90Days = new Date(now.getTime() + 90 * 24 * 60 * 60 * 1000);

         const enrolments = await db.programmeEnrolment.findMany({
           where: {
             status: "ACTIVE",
             anniversaryDate: { lte: in90Days, gt: now },
           },
           include: { organization: { select: { id: true, name: true, email: true } } },
         });
         ```
       - For each enrolment, check which alerts haven't been sent:
         - 90-day: anniversaryDate - now <= 90 days AND renewalAlert90Sent is false
         - 60-day: anniversaryDate - now <= 60 days AND renewalAlert60Sent is false
         - 30-day: anniversaryDate - now <= 30 days AND renewalAlert30Sent is false
       - For each triggered alert:
         - Call createNotification with type: "PROGRAMME_RENEWAL", channel: "EMAIL"
         - Title: "RoofWright Programme Renewal Reminder"
         - Message: "Your RoofWright programme membership is due for renewal in {X} days (on {anniversaryDate}). Please ensure your organisation remains compliant."
         - actionUrl: "/programme"
         - organizationId: enrolment.organizationId
         - Update the corresponding renewalAlertXXSent flag to true
         - Also update status to RENEWAL_DUE if <= 90 days and currently ACTIVE (this is the status transition that triggers the visual change)
       - Return count of notifications sent

    2. Integrate into the cron GET handler:
       - Add `programmeRenewals: 0` to the results object
       - Add step: `results.programmeRenewals = await checkProgrammeRenewals();`
       - Place this after the document review check (step 5) and before audit scheduling (step 6)
       - Add programmeRenewals to the response JSON

    3. Update docs/member-guide.md:
       - Add a "RoofWright Programme" section explaining:
         - How to find the Programme page in the sidebar
         - How to apply for enrolment
         - What the status badges mean (Pending, Active, Renewal Due, Suspended)
         - That renewal reminders are sent at 90, 60, and 30 days before anniversary
         - That the programme badge appears on the dashboard when enrolled

    4. Update docs/admin-guide.md:
       - Add a "Programme Enrolment Management" section explaining:
         - How to access the Programme page in admin nav
         - How to review and approve/reject applications
         - How to suspend and reinstate enrolments
         - What the different statuses mean
         - That renewal reminders are sent automatically
  </action>
  <verify>
    Run `pnpm typecheck` passes.
    Run `pnpm build` succeeds.
    Cron route file compiles and includes checkProgrammeRenewals in the flow.
    docs/member-guide.md contains "RoofWright Programme" section.
    docs/admin-guide.md contains "Programme Enrolment Management" section.
  </verify>
  <done>
    Cron job checks for programme anniversaries within 90 days.
    Sends renewal reminders at 90, 60, and 30-day intervals.
    Sets renewalAlertXXSent flags to prevent duplicate notifications.
    Transitions ACTIVE to RENEWAL_DUE status when within 90 days of anniversary.
    Member guide documents the programme application flow and status badges.
    Admin guide documents the enrolment management workflow.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm build` succeeds
3. Dashboard shows programme badge for enrolled orgs
4. Dashboard shows nothing for non-enrolled orgs
5. Public verification shows RoofWright section for ACTIVE orgs
6. Cron endpoint includes programme renewal check
7. Documentation updated for both member and admin guides
</verification>

<success_criteria>
- Dashboard prominently displays RoofWright programme status badge
- Public verification page shows programme membership for ACTIVE/RENEWAL_DUE orgs
- Cron job sends renewal reminders at 90/60/30 days before anniversary
- ACTIVE enrolments transition to RENEWAL_DUE at 90 days before anniversary
- Alert flags prevent duplicate notification sends
- User-facing documentation is complete
</success_criteria>

<output>
After completion, create `.planning/phases/13-programme-enrolment/13-03-SUMMARY.md`
</output>
