---
phase: 13-programme-enrolment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/types/index.ts
  - src/app/api/programme/apply/route.ts
  - src/app/(dashboard)/programme/page.tsx
  - src/app/(dashboard)/programme/apply/page.tsx
  - src/components/layout/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "ProgrammeEnrolment model exists in database with all required status states"
    - "Org admin can navigate to programme page and submit an enrolment application"
    - "Application creates a ProgrammeEnrolment record with PENDING status and sets appliedAt"
    - "TypeScript types and labels exist for ProgrammeEnrolmentStatus"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "ProgrammeEnrolment model with status enum"
      contains: "model ProgrammeEnrolment"
    - path: "src/types/index.ts"
      provides: "ProgrammeEnrolmentStatus type and labels"
      contains: "ProgrammeEnrolmentStatus"
    - path: "src/app/api/programme/apply/route.ts"
      provides: "POST endpoint for enrolment application"
      exports: ["POST"]
    - path: "src/app/(dashboard)/programme/page.tsx"
      provides: "Programme status page for org admins"
    - path: "src/app/(dashboard)/programme/apply/page.tsx"
      provides: "Application form page"
  key_links:
    - from: "src/app/(dashboard)/programme/apply/page.tsx"
      to: "/api/programme/apply"
      via: "fetch POST on form submit"
      pattern: "fetch.*api/programme/apply"
    - from: "src/app/api/programme/apply/route.ts"
      to: "prisma.programmeEnrolment"
      via: "database create"
      pattern: "prisma\\.programmeEnrolment\\.create"
    - from: "src/components/layout/sidebar.tsx"
      to: "/programme"
      via: "navigation array entry"
      pattern: "href.*programme"
---

<objective>
Create the ProgrammeEnrolment database model, TypeScript types, and the org-facing application flow so that organization admins can apply to enrol their business in the RoofWright programme.

Purpose: This is the foundation for all Phase 13 work. The schema and types must exist before admin review, notifications, or public verification can be built. The application form is the entry point for the entire programme workflow.

Output: Prisma migration applied, types exported, application form and API working, sidebar navigation updated.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@prisma/schema.prisma
@src/types/index.ts
@src/components/layout/sidebar.tsx
@src/app/(dashboard)/layout.tsx
@src/lib/db.ts
@src/lib/audit-log.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prisma schema, migration, and TypeScript types</name>
  <files>
    prisma/schema.prisma
    src/types/index.ts
  </files>
  <action>
    1. Add ProgrammeEnrolmentStatus enum to prisma/schema.prisma:
       ```
       enum ProgrammeEnrolmentStatus {
         PENDING
         ACTIVE
         RENEWAL_DUE
         SUSPENDED
         WITHDRAWN
       }
       ```

    2. Add ProgrammeEnrolment model to prisma/schema.prisma (place after the Testimonial model section):
       ```
       model ProgrammeEnrolment {
         id             String @id @default(cuid())
         organizationId String @unique  // One enrolment per org

         // Status tracking
         status ProgrammeEnrolmentStatus @default(PENDING)

         // Application
         appliedAt    DateTime  @default(now())
         appliedBy    String    // Clerk user ID of applicant

         // Review
         reviewedAt   DateTime?
         reviewedBy   String?   // Clerk user ID of RANZ admin
         reviewNotes  String?   // Admin notes on decision

         // Active period (annual)
         activeSince  DateTime?  // When first approved (or reactivated)
         anniversaryDate DateTime? // Annual renewal date (set to activeSince + 1 year)

         // Renewal tracking
         renewalAlert90Sent Boolean @default(false)
         renewalAlert60Sent Boolean @default(false)
         renewalAlert30Sent Boolean @default(false)

         // Suspension
         suspendedAt    DateTime?
         suspendedBy    String?
         suspendedReason String?

         // Timestamps
         createdAt DateTime @default(now())
         updatedAt DateTime @updatedAt

         organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

         @@index([status])
         @@index([anniversaryDate])
       }
       ```

    3. Add `programmeEnrolment ProgrammeEnrolment?` relation to the Organization model's relations section (after `approvedSuppliers`).

    4. Add `PROGRAMME_RENEWAL` and `PROGRAMME_STATUS_CHANGE` to the NotificationType enum in schema.prisma AND to the AuditAction enum (add `ENROL_APPLY`, `ENROL_APPROVE`, `ENROL_REJECT`, `ENROL_SUSPEND`, `ENROL_REINSTATE`).

    5. Run `pnpm prisma db push` to apply schema changes (NOT migrate -- this project uses db push per existing pattern with Neon).

    6. In src/types/index.ts:
       - Add `ProgrammeEnrolmentStatus` type:
         ```typescript
         export type ProgrammeEnrolmentStatus =
           | "PENDING"
           | "ACTIVE"
           | "RENEWAL_DUE"
           | "SUSPENDED"
           | "WITHDRAWN";
         ```
       - Add `PROGRAMME_ENROLMENT_STATUS_LABELS` constant:
         ```typescript
         export const PROGRAMME_ENROLMENT_STATUS_LABELS: Record<ProgrammeEnrolmentStatus, string> = {
           PENDING: "Pending Review",
           ACTIVE: "Active",
           RENEWAL_DUE: "Renewal Due",
           SUSPENDED: "Suspended",
           WITHDRAWN: "Withdrawn",
         };
         ```
       - Add `PROGRAMME_RENEWAL` and `PROGRAMME_STATUS_CHANGE` to the NotificationType union type.
       - Add `PROGRAMME_RENEWAL: "Programme Renewal Reminder"` and `PROGRAMME_STATUS_CHANGE: "Programme Status Changed"` to NOTIFICATION_TYPE_LABELS.
       - Add `ENROL_APPLY`, `ENROL_APPROVE`, `ENROL_REJECT`, `ENROL_SUSPEND`, `ENROL_REINSTATE` to AuditAction type.

    IMPORTANT: Do NOT remove or modify any existing types/enums -- only append new values.
  </action>
  <verify>
    Run `pnpm prisma db push` succeeds without errors.
    Run `pnpm typecheck` passes.
    Confirm ProgrammeEnrolment model exists in generated Prisma client.
  </verify>
  <done>
    ProgrammeEnrolment table exists in database with all columns.
    ProgrammeEnrolmentStatus enum has 5 states (PENDING, ACTIVE, RENEWAL_DUE, SUSPENDED, WITHDRAWN).
    TypeScript types and labels are exported from src/types/index.ts.
    NotificationType includes PROGRAMME_RENEWAL and PROGRAMME_STATUS_CHANGE.
    AuditAction includes all 5 enrolment actions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Application form, API endpoint, programme page, and sidebar nav</name>
  <files>
    src/app/api/programme/apply/route.ts
    src/app/(dashboard)/programme/page.tsx
    src/app/(dashboard)/programme/apply/page.tsx
    src/components/layout/sidebar.tsx
    src/lib/notifications.ts
  </files>
  <action>
    1. Create src/app/api/programme/apply/route.ts:
       - POST endpoint that requires Clerk auth (import auth from @clerk/nextjs/server)
       - Validate user has orgId, resolve Organization from clerkOrgId
       - Check user role is OWNER or ADMIN (reject STAFF with 403)
       - Check no existing ProgrammeEnrolment for this org (return 409 if exists and not WITHDRAWN)
       - Create ProgrammeEnrolment with status PENDING, appliedAt now, appliedBy userId
       - Log to audit trail using logAuditEvent from @/lib/audit-log with action ENROL_APPLY
       - Return 201 with the created enrolment record
       - Use Zod for any request body validation (application may include a brief message/motivation from org -- optional `message` field stored in reviewNotes temporarily)

    2. Create src/app/(dashboard)/programme/page.tsx:
       - Server Component (async function)
       - Import auth from @clerk/nextjs/server, redirect if no orgId
       - Query Organization with include: { programmeEnrolment: true }
       - If no enrolment exists: show "RoofWright Programme" info card with programme benefits description and a "Apply to Enrol" button linking to /programme/apply
       - If enrolment exists: show status card with current status badge (use PROGRAMME_ENROLMENT_STATUS_LABELS), dates (appliedAt, activeSince, anniversaryDate), and contextual message based on status:
         - PENDING: "Your application is under review by RANZ"
         - ACTIVE: "Your organisation is enrolled in the RoofWright programme" + show anniversary date
         - RENEWAL_DUE: "Your annual renewal is due" + show anniversary date
         - SUSPENDED: "Your enrolment has been suspended" + show reason
         - WITHDRAWN: show "Apply to Enrol" button again (allow re-application)
       - Use existing Card, CardContent, CardHeader, CardTitle, Badge, Button components from @/components/ui
       - Status badge colors: PENDING=yellow, ACTIVE=green, RENEWAL_DUE=amber, SUSPENDED=red, WITHDRAWN=slate

    3. Create src/app/(dashboard)/programme/apply/page.tsx:
       - "use client" component
       - Simple application form with:
         - Organisation name (pre-filled, read-only -- fetched from /api/organizations/current or passed via server)
         - Optional message/motivation textarea (max 500 chars)
         - Submit button that POSTs to /api/programme/apply
         - On success: redirect to /programme with success toast/message
         - On 409: show "Already applied" message
         - On error: show error message
       - Use existing form patterns from the codebase (Input, Textarea, Button, Label from @/components/ui)

    4. Update src/components/layout/sidebar.tsx:
       - Add "Programme" nav item to the navigation array, positioned after "CAPA" and before the secondaryNavigation:
         ```
         { name: "Programme", href: "/programme", icon: Award }
         ```
       - Import Award from lucide-react (represents certification/programme membership well)

    5. Update src/lib/notifications.ts:
       - Add PROGRAMME_RENEWAL and PROGRAMME_STATUS_CHANGE to ALL four notification preference mapping objects:
         - NOTIFICATION_TYPE_TO_EMAIL_PREF: PROGRAMME_RENEWAL -> "emailCompliance", PROGRAMME_STATUS_CHANGE -> null (always send)
         - NOTIFICATION_TYPE_TO_SMS_PREF: PROGRAMME_RENEWAL -> "smsCritical", PROGRAMME_STATUS_CHANGE -> "smsCritical"
         - NOTIFICATION_TYPE_TO_ORG_EMAIL_PREF: PROGRAMME_RENEWAL -> "emailComplianceAlerts", PROGRAMME_STATUS_CHANGE -> "emailSystemAlerts"
         - NOTIFICATION_TYPE_TO_ORG_SMS_PREF: PROGRAMME_RENEWAL -> "smsInsuranceAlerts", PROGRAMME_STATUS_CHANGE -> "smsCriticalAlerts"
       This is needed now to prevent TypeScript errors since the NotificationType union was expanded.
  </action>
  <verify>
    Run `pnpm typecheck` passes with no errors.
    Run `pnpm build` succeeds.
    Navigate to /programme in the dashboard sidebar -- link appears.
    Visit /programme -- shows programme info or current enrolment status.
  </verify>
  <done>
    Sidebar shows "Programme" nav item with Award icon between CAPA and Help.
    /programme page renders programme info card with "Apply to Enrol" button when no enrolment exists.
    /programme/apply page renders application form.
    POST /api/programme/apply creates ProgrammeEnrolment with PENDING status, logs audit event.
    After applying, /programme shows PENDING status with "under review" message.
    Notification type mappings updated -- no TypeScript errors from expanded union.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm build` succeeds
3. Database has ProgrammeEnrolment table (verify via `pnpm db:studio`)
4. Sidebar shows Programme link
5. /programme page renders correctly
6. Application form submits and creates DB record
</verification>

<success_criteria>
- ProgrammeEnrolment model exists in database with 5 status states
- Org admin can navigate to /programme and apply to enrol
- Application creates PENDING record with audit log entry
- TypeScript types and notification mappings are complete
- Build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-programme-enrolment/13-01-SUMMARY.md`
</output>
