---
phase: 02-dashboard-real-time-updates
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - src/app/(dashboard)/insurance/_components/policy-form.tsx
  - src/app/(dashboard)/documents/_components/approval-actions.tsx
  - src/app/(dashboard)/staff/_components/verify-button.tsx
  - src/components/ui/loading-button.tsx
autonomous: true

must_haves:
  truths:
    - "User sees loading spinner when submitting insurance form"
    - "User sees loading spinner when approving document"
    - "User sees loading spinner when verifying LBP"
    - "Buttons are disabled during pending state to prevent double submission"
  artifacts:
    - path: "src/components/ui/loading-button.tsx"
      provides: "Reusable button with loading state"
      exports: ["LoadingButton"]
  key_links:
    - from: "policy-form.tsx"
      to: "useTransition"
      via: "React hook import"
      pattern: "useTransition"
    - from: "approval-actions.tsx"
      to: "useTransition"
      via: "React hook import"
      pattern: "useTransition"
---

<objective>
Add loading states to mutation forms using React's useTransition hook for immediate user feedback

Purpose: Success Criteria #5 for Phase 2 specifies "Member sees spinner/loading state during recalculation (not stale data)". After Plans 01 and 02 wire up dimension indicators and revalidatePath, users need visual feedback that their action is being processed.

Output:
- Insurance form shows "Adding..." spinner during submission
- Document approval shows "Approving..." spinner during action
- LBP verification shows "Verifying..." spinner during API call
- All buttons disabled during pending state to prevent double submission
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-dashboard-real-time-updates/02-RESEARCH.md
@.planning/phases/02-dashboard-real-time-updates/02-01-SUMMARY.md
@.planning/phases/02-dashboard-real-time-updates/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reusable LoadingButton component</name>
  <files>src/components/ui/loading-button.tsx</files>
  <action>
Create a reusable LoadingButton component that wraps the existing button with loading state support.

```typescript
"use client";

import { forwardRef } from "react";
import { Loader2 } from "lucide-react";
import { Button, ButtonProps } from "@/components/ui/button";
import { cn } from "@/lib/utils";

export interface LoadingButtonProps extends ButtonProps {
  loading?: boolean;
  loadingText?: string;
}

export const LoadingButton = forwardRef<HTMLButtonElement, LoadingButtonProps>(
  ({ children, loading, loadingText, disabled, className, ...props }, ref) => {
    return (
      <Button
        ref={ref}
        disabled={disabled || loading}
        className={cn(className)}
        {...props}
      >
        {loading ? (
          <>
            <Loader2 className="mr-2 h-4 w-4 animate-spin" />
            {loadingText || children}
          </>
        ) : (
          children
        )}
      </Button>
    );
  }
);

LoadingButton.displayName = "LoadingButton";
```

This component:
- Extends existing Button component with loading prop
- Shows Loader2 spinner icon when loading
- Automatically disables when loading
- Allows custom loadingText or falls back to children
- Uses forwardRef for form compatibility
  </action>
  <verify>
Component file exists: ls src/components/ui/loading-button.tsx
TypeScript compiles: npx tsc --noEmit shows no errors
  </verify>
  <done>
LoadingButton component created with loading spinner and auto-disable functionality
  </done>
</task>

<task type="auto">
  <name>Task 2: Add useTransition to insurance form</name>
  <files>src/app/(dashboard)/insurance/_components/policy-form.tsx</files>
  <action>
First, check if this file exists. If not, look for the insurance form component in the insurance page or related files.

Find the insurance form component and add useTransition:

1. Import useTransition and LoadingButton:
   ```typescript
   import { useTransition } from "react";
   import { LoadingButton } from "@/components/ui/loading-button";
   ```

2. Add useTransition hook at top of component:
   ```typescript
   const [isPending, startTransition] = useTransition();
   ```

3. Wrap the form submission in startTransition:
   ```typescript
   const handleSubmit = async (e: React.FormEvent) => {
     e.preventDefault();
     startTransition(async () => {
       // existing fetch/form submission logic
       const response = await fetch('/api/insurance', {
         method: 'POST',
         body: formData,
       });
       // ... handle response
     });
   };
   ```

4. Replace submit button with LoadingButton:
   ```typescript
   <LoadingButton
     type="submit"
     loading={isPending}
     loadingText="Adding Policy..."
   >
     Add Insurance Policy
   </LoadingButton>
   ```

If the form uses a different pattern (e.g., react-hook-form with action), adapt accordingly while still using useTransition for the pending state.

Note: If no client component exists for insurance form, check if form is in the page.tsx directly. If it's a Server Component form, consider whether to convert part to client component or use a different approach for loading states.
  </action>
  <verify>
useTransition imported and used in insurance form
LoadingButton used for submit
grep "useTransition" in insurance form file shows import and usage
  </verify>
  <done>
Insurance form shows loading spinner during submission and button is disabled
  </done>
</task>

<task type="auto">
  <name>Task 3: Add useTransition to document approval and LBP verification</name>
  <files>src/app/(dashboard)/documents/_components/approval-actions.tsx, src/app/(dashboard)/staff/_components/verify-button.tsx</files>
  <action>
Find the document approval component and LBP verification button. Apply same pattern as Task 2:

**Document Approval (likely in documents/[id]/ or documents/_components/):**
1. Import useTransition and LoadingButton
2. Add `const [isPending, startTransition] = useTransition();`
3. Wrap approve/reject API calls in startTransition
4. Use LoadingButton with loading={isPending} loadingText="Approving..."

**LBP Verification (likely in staff/[id]/ or staff/_components/):**
1. Import useTransition and LoadingButton
2. Add `const [isPending, startTransition] = useTransition();`
3. Wrap verify API call in startTransition
4. Use LoadingButton with loading={isPending} loadingText="Verifying..."

Steps to find components:
```bash
# Find approval-related components
grep -rn "approve" src/app/\(dashboard\)/documents/ --include="*.tsx" | head -10

# Find verify-related components
grep -rn "verify" src/app/\(dashboard\)/staff/ --include="*.tsx" | head -10
```

If components are in different locations than specified in files_modified, update those files instead.

If these are Server Components with form actions, the pattern differs:
- Use useFormStatus from react-dom for form submit buttons
- Or convert action buttons to client components with useTransition
  </action>
  <verify>
Document approval shows loading state:
grep -r "useTransition\|isPending" src/app/\(dashboard\)/documents/

LBP verification shows loading state:
grep -r "useTransition\|isPending" src/app/\(dashboard\)/staff/
  </verify>
  <done>
Document approval and LBP verification buttons show loading spinners during API calls
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. LoadingButton component exists:
   ```bash
   ls src/components/ui/loading-button.tsx
   ```

2. useTransition used in mutation forms:
   ```bash
   grep -r "useTransition" src/app/\(dashboard\)/
   ```

3. TypeScript compiles:
   ```bash
   npx tsc --noEmit 2>&1 | grep -E "(error|Error)" | head -5 || echo "No errors"
   ```

4. Manual verification:
   - Submit insurance form - should see "Adding Policy..." spinner
   - Approve document - should see "Approving..." spinner
   - Verify LBP - should see "Verifying..." spinner
   - Buttons disabled during pending state
</verification>

<success_criteria>
- LoadingButton component created and exported
- Insurance form uses useTransition with isPending state
- Document approval uses useTransition with isPending state
- LBP verification uses useTransition with isPending state
- All mutation buttons show spinner and are disabled during pending
</success_criteria>

<output>
After completion, create `.planning/phases/02-dashboard-real-time-updates/02-03-SUMMARY.md`
</output>
