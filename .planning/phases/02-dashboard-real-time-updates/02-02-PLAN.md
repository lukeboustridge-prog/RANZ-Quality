---
phase: 02-dashboard-real-time-updates
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/insurance/route.ts
  - src/app/api/documents/[id]/approve/route.ts
  - src/app/api/staff/[id]/verify-lbp/route.ts
  - src/app/api/staff/[id]/route.ts
  - src/app/api/staff/route.ts
autonomous: true

must_haves:
  truths:
    - "Insurance upload triggers dashboard revalidation"
    - "Document approval triggers dashboard revalidation"
    - "LBP verification triggers dashboard revalidation"
    - "Staff changes trigger dashboard revalidation"
    - "All mutations use canonical compliance-v2.ts for scoring"
  artifacts:
    - path: "src/app/api/insurance/route.ts"
      provides: "Insurance POST with canonical scoring and revalidatePath"
      contains: "revalidatePath"
    - path: "src/app/api/documents/[id]/approve/route.ts"
      provides: "Document approval with revalidatePath"
      contains: "revalidatePath"
    - path: "src/app/api/staff/[id]/verify-lbp/route.ts"
      provides: "LBP verification with revalidatePath"
      contains: "revalidatePath"
  key_links:
    - from: "src/app/api/insurance/route.ts"
      to: "updateOrganizationComplianceScore"
      via: "import from @/lib/compliance-v2"
      pattern: "import.*updateOrganizationComplianceScore.*from.*compliance-v2"
    - from: "src/app/api/insurance/route.ts"
      to: "dashboard cache"
      via: "revalidatePath call"
      pattern: "revalidatePath\\(['\"]/(dashboard|\\(dashboard\\)).*['\"]\\)"
---

<objective>
Wire all compliance-affecting mutation endpoints to use canonical scoring and revalidatePath for immediate dashboard updates

Purpose: Requirement DASH-02 specifies compliance score updates in real-time when documents, insurance policies, or staff credentials change. Currently, mutations update the database but don't invalidate the dashboard cache, so users see stale data. Additionally, the insurance route (lines 135-175) has an inline updateComplianceScore function that doesn't use the canonical compliance-v2.ts algorithm.

Output:
- Insurance route uses updateOrganizationComplianceScore from compliance-v2.ts (not inline function)
- All mutation endpoints call revalidatePath('/dashboard') after successful mutations
- Dashboard updates immediately when user uploads insurance, approves document, or verifies LBP
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-dashboard-real-time-updates/02-RESEARCH.md
@src/lib/compliance-v2.ts
@src/app/api/insurance/route.ts
@src/app/api/documents/[id]/approve/route.ts
@src/app/api/staff/[id]/verify-lbp/route.ts
@src/app/api/staff/[id]/route.ts
@src/app/api/staff/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix insurance route to use canonical scoring and add revalidatePath</name>
  <files>src/app/api/insurance/route.ts</files>
  <action>
This file has a critical issue: lines 135-175 contain an inline updateComplianceScore function that doesn't match the canonical compliance-v2.ts algorithm (it uses simplified 40/30/30 weighting instead of the 50/25/15/10 weighting with detailed calculations).

Replace the inline function with proper imports and calls:

1. Add imports at top of file:
   ```typescript
   import { revalidatePath } from "next/cache";
   import { updateOrganizationComplianceScore } from "@/lib/compliance-v2";
   ```

2. In the POST handler, after creating the policy (around line 114), replace:
   ```typescript
   await updateComplianceScore(organization.id);
   return NextResponse.json(policy);
   ```
   With:
   ```typescript
   await updateOrganizationComplianceScore(organization.id);
   revalidatePath('/dashboard');
   return NextResponse.json(policy);
   ```

3. DELETE the entire inline updateComplianceScore function (lines 135-175). This function:
   - Uses wrong weights (40/30/30 vs canonical 50/25/15/10)
   - Only checks for PL/PI insurance, not full coverage requirements
   - Doesn't calculate detailed breakdown
   - Must be removed to ensure single source of truth

The canonical updateOrganizationComplianceScore from compliance-v2.ts:
- Uses correct CATEGORY_WEIGHTS (documentation: 0.5, insurance: 0.25, personnel: 0.15, audit: 0.1)
- Calculates detailed breakdown for each dimension
- Checks tier-specific insurance requirements from INSURANCE_REQUIREMENTS
- Updates organization.complianceScore in database
  </action>
  <verify>
File no longer contains inline updateComplianceScore function:
grep -c "async function updateComplianceScore" src/app/api/insurance/route.ts returns 0

Imports are correct:
grep "updateOrganizationComplianceScore" src/app/api/insurance/route.ts shows import
grep "revalidatePath" src/app/api/insurance/route.ts shows import

TypeScript compiles: npx tsc --noEmit shows no errors
  </verify>
  <done>
Insurance route uses canonical updateOrganizationComplianceScore and calls revalidatePath('/dashboard') after creating policy
  </done>
</task>

<task type="auto">
  <name>Task 2: Add revalidatePath to document approval route</name>
  <files>src/app/api/documents/[id]/approve/route.ts</files>
  <action>
This file already imports updateOrganizationComplianceScore and calls it after approval (line 130). However, it's missing revalidatePath to invalidate the dashboard cache.

1. Add import at top of file:
   ```typescript
   import { revalidatePath } from "next/cache";
   ```

2. In the PUT handler, after calling updateOrganizationComplianceScore (around line 130-131), add revalidatePath:
   ```typescript
   if (action === "approve") {
     await approveVersion(targetVersionId, userId);
     await updateOrganizationComplianceScore(document.organizationId);
     revalidatePath('/dashboard');
     return NextResponse.json({ message: "Document approved" });
   }
   ```

The POST handler (submit for approval) doesn't change compliance score, so no revalidation needed there.
The reject action doesn't change compliance score either, so only approve needs revalidation.
  </action>
  <verify>
revalidatePath imported and called:
grep "revalidatePath" src/app/api/documents/[id]/approve/route.ts shows both import and call

TypeScript compiles: npx tsc --noEmit shows no errors
  </verify>
  <done>
Document approval route calls revalidatePath('/dashboard') after approving document
  </done>
</task>

<task type="auto">
  <name>Task 3: Add revalidatePath to LBP verification and staff routes</name>
  <files>src/app/api/staff/[id]/verify-lbp/route.ts, src/app/api/staff/[id]/route.ts, src/app/api/staff/route.ts</files>
  <action>
Add revalidatePath to all staff-related mutation endpoints:

**src/app/api/staff/[id]/verify-lbp/route.ts:**
Already imports updateOrganizationComplianceScore and calls it. Add:
1. Import: `import { revalidatePath } from "next/cache";`
2. After updateOrganizationComplianceScore call (around line 50), add:
   ```typescript
   revalidatePath('/dashboard');
   ```

**src/app/api/staff/[id]/route.ts:**
Check if this file has PUT/DELETE handlers that modify staff credentials. If so:
1. Import: `import { revalidatePath } from "next/cache";`
2. Import: `import { updateOrganizationComplianceScore } from "@/lib/compliance-v2";`
3. After any mutation that affects LBP status or staff count, call both:
   ```typescript
   await updateOrganizationComplianceScore(member.organizationId);
   revalidatePath('/dashboard');
   ```

**src/app/api/staff/route.ts:**
If this file has POST handler for adding new staff:
1. Import: `import { revalidatePath } from "next/cache";`
2. Import: `import { updateOrganizationComplianceScore } from "@/lib/compliance-v2";`
3. After creating new member, call both (personnel count affects compliance):
   ```typescript
   await updateOrganizationComplianceScore(organization.id);
   revalidatePath('/dashboard');
   ```

Note: Read each file first to understand current structure before modifying.
  </action>
  <verify>
Each file has revalidatePath:
grep -l "revalidatePath" src/app/api/staff/**/*.ts shows all modified files

TypeScript compiles: npx tsc --noEmit shows no errors
  </verify>
  <done>
All staff-related mutation endpoints call updateOrganizationComplianceScore and revalidatePath('/dashboard')
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Inline function removed from insurance route:
   ```bash
   grep -c "async function updateComplianceScore" src/app/api/insurance/route.ts
   # Should return 0
   ```

2. All mutation endpoints have revalidatePath:
   ```bash
   grep -r "revalidatePath.*dashboard" src/app/api/insurance/ src/app/api/documents/*/approve/ src/app/api/staff/
   # Should show hits in all mutation files
   ```

3. TypeScript compiles:
   ```bash
   npx tsc --noEmit 2>&1 | grep -E "(error|Error)" | head -5 || echo "No errors"
   ```

4. Canonical scoring used everywhere:
   ```bash
   grep -r "updateOrganizationComplianceScore" src/app/api/
   # Should show imports in insurance, documents/approve, staff files
   ```
</verification>

<success_criteria>
- Insurance route POST uses updateOrganizationComplianceScore from compliance-v2.ts (inline function deleted)
- Insurance route POST calls revalidatePath('/dashboard')
- Document approve route calls revalidatePath('/dashboard')
- LBP verify route calls revalidatePath('/dashboard')
- Staff creation/modification routes call revalidatePath('/dashboard')
- No duplicate compliance scoring implementations remain in API routes
</success_criteria>

<output>
After completion, create `.planning/phases/02-dashboard-real-time-updates/02-02-SUMMARY.md`
</output>
