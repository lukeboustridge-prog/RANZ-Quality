---
phase: 09-organization-profile
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "Organization model has logoKey field for logo storage"
    - "Organization model has description field for company description"
    - "OrganizationNotificationPreference model exists for org-level notification settings"
    - "Database migration runs successfully without errors"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Organization profile fields and notification preference model"
      contains: "logoKey"
    - path: "prisma/schema.prisma"
      provides: "OrganizationNotificationPreference model"
      contains: "model OrganizationNotificationPreference"
  key_links:
    - from: "OrganizationNotificationPreference"
      to: "Organization"
      via: "organizationId foreign key"
      pattern: "organizationId String @unique"
---

<objective>
Add database schema support for organization profile fields and notification preferences.

Purpose: Foundation for Phase 9 - Organization can store logo, description, and control notification preferences
Output: Updated Prisma schema with new fields and model, successful migration
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-organization-profile/09-RESEARCH.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Prisma Schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add two fields to the existing Organization model (after the `city` field, before the Relations comment):

```prisma
  // Profile
  description String?  // Company description for public verification
  logoKey     String?  // R2 storage key for company logo
```

Add a new model for organization notification preferences (after the existing NotificationPreference model, before the Report model):

```prisma
// ============================================================================
// Organization Notification Preferences
// ============================================================================

model OrganizationNotificationPreference {
  id             String @id @default(cuid())
  organizationId String @unique

  // Email routing preferences
  emailEnabled          Boolean @default(true)
  emailInsuranceAlerts  Boolean @default(true)
  emailAuditAlerts      Boolean @default(true)
  emailComplianceAlerts Boolean @default(true)
  emailSystemAlerts     Boolean @default(true)

  // SMS routing preferences
  smsEnabled         Boolean @default(false)
  smsInsuranceAlerts Boolean @default(true)
  smsAuditAlerts     Boolean @default(false)
  smsCriticalAlerts  Boolean @default(true)

  // Override contact for org-level notifications
  notificationEmail String?  // If different from org.email
  notificationPhone String?  // For SMS notifications

  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}
```

Add the relation back-reference in the Organization model relations section:
```prisma
  notificationPreference OrganizationNotificationPreference?
```

This should be added in the Organization model's relations section, after the testimonials relation and before createdAt.
  </action>
  <verify>Run `npx prisma validate` - should show "schema is valid"</verify>
  <done>Schema contains logoKey, description fields on Organization and OrganizationNotificationPreference model with all specified fields</done>
</task>

<task type="auto">
  <name>Task 2: Generate and Apply Migration</name>
  <files>prisma/migrations/*</files>
  <action>
Run Prisma migration to apply the schema changes:

```bash
npx prisma migrate dev --name add_org_profile_and_notification_prefs
```

This will:
1. Create a new migration file with the schema changes
2. Apply the migration to the development database
3. Regenerate the Prisma client with new types

After migration, verify the Prisma client has the new types by checking that `db.organizationNotificationPreference` exists in TypeScript intellisense.

If the migration fails due to existing data constraints, the migration should handle it gracefully since both new Organization fields are nullable and the new model has no required data.
  </action>
  <verify>
1. `npx prisma migrate status` shows no pending migrations
2. `npx prisma db pull --print` shows the new fields
3. The dev server starts without Prisma errors: `npm run dev` (check first 10 seconds of output)
  </verify>
  <done>Migration applied, Prisma client regenerated, new fields and model available in database</done>
</task>

</tasks>

<verification>
1. Schema validation passes
2. Migration completed successfully
3. New fields visible in Prisma Studio: `npx prisma studio` (optional visual check)
4. TypeScript compilation succeeds with new model types
</verification>

<success_criteria>
- Organization model has logoKey and description optional fields
- OrganizationNotificationPreference model exists with all email and SMS preference fields
- One-to-one relationship established between Organization and OrganizationNotificationPreference
- No breaking changes to existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/09-organization-profile/09-01-SUMMARY.md`
</output>
