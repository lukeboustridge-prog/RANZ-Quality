---
phase: 09-organization-profile
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/app/api/organizations/current/notifications/route.ts
  - src/components/settings/notification-settings.tsx
  - src/app/(dashboard)/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "Org admin can configure which notification types the organization receives"
    - "Org admin can choose notification channels (email, SMS, or both) for organization alerts"
    - "Notification preferences are persisted to database"
    - "Default preferences are created on first access"
  artifacts:
    - path: "src/app/api/organizations/current/notifications/route.ts"
      provides: "GET/PATCH endpoints for organization notification preferences"
      exports: ["GET", "PATCH"]
    - path: "src/components/settings/notification-settings.tsx"
      provides: "UI component for notification preference toggles"
      min_lines: 100
  key_links:
    - from: "src/components/settings/notification-settings.tsx"
      to: "/api/organizations/current/notifications"
      via: "fetch GET and PATCH requests"
      pattern: "fetch.*api/organizations/current/notifications"
    - from: "src/app/api/organizations/current/notifications/route.ts"
      to: "prisma.organizationNotificationPreference"
      via: "database operations"
      pattern: "db\\.organizationNotificationPreference"
---

<objective>
Implement organization notification preference management for org admins.

Purpose: Allow org owners/admins to control how their organization receives system notifications (ORG-02)
Output: Working notification settings UI with toggles for email/SMS preferences per notification type
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-organization-profile/09-RESEARCH.md
@.planning/phases/09-organization-profile/09-01-SUMMARY.md
@src/app/api/notifications/preferences/route.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Organization Notification Preferences API</name>
  <files>src/app/api/organizations/current/notifications/route.ts</files>
  <action>
Create `src/app/api/organizations/current/notifications/route.ts`:

```typescript
import { NextRequest, NextResponse } from "next/server";
import { auth } from "@clerk/nextjs/server";
import { db } from "@/lib/db";
import { z } from "zod/v4";

// GET - Get organization notification preferences
export async function GET() {
  try {
    const { userId, orgId } = await auth();
    if (!userId || !orgId) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    // Get organization
    const organization = await db.organization.findUnique({
      where: { clerkOrgId: orgId },
      include: {
        members: {
          where: { clerkUserId: userId },
          select: { role: true },
        },
        notificationPreference: true,
      },
    });

    if (!organization) {
      return NextResponse.json({ error: "Organization not found" }, { status: 404 });
    }

    // Check admin access
    const member = organization.members[0];
    if (!member || !["OWNER", "ADMIN"].includes(member.role)) {
      return NextResponse.json({ error: "Forbidden - admin access required" }, { status: 403 });
    }

    // Create default preferences if not exists
    let preferences = organization.notificationPreference;
    if (!preferences) {
      preferences = await db.organizationNotificationPreference.create({
        data: {
          organizationId: organization.id,
          emailEnabled: true,
          emailInsuranceAlerts: true,
          emailAuditAlerts: true,
          emailComplianceAlerts: true,
          emailSystemAlerts: true,
          smsEnabled: false,
          smsInsuranceAlerts: true,
          smsAuditAlerts: false,
          smsCriticalAlerts: true,
        },
      });
    }

    return NextResponse.json(preferences);
  } catch (error) {
    console.error("Failed to fetch notification preferences:", error);
    return NextResponse.json({ error: "Internal server error" }, { status: 500 });
  }
}

const updatePreferencesSchema = z.object({
  // Email preferences
  emailEnabled: z.boolean().optional(),
  emailInsuranceAlerts: z.boolean().optional(),
  emailAuditAlerts: z.boolean().optional(),
  emailComplianceAlerts: z.boolean().optional(),
  emailSystemAlerts: z.boolean().optional(),

  // SMS preferences
  smsEnabled: z.boolean().optional(),
  smsInsuranceAlerts: z.boolean().optional(),
  smsAuditAlerts: z.boolean().optional(),
  smsCriticalAlerts: z.boolean().optional(),

  // Override contacts
  notificationEmail: z.string().email().nullable().optional(),
  notificationPhone: z.string().max(20).nullable().optional(),
});

// PATCH - Update organization notification preferences (OWNER/ADMIN only)
export async function PATCH(req: NextRequest) {
  try {
    const { userId, orgId } = await auth();
    if (!userId || !orgId) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    // Get organization and verify membership + role
    const organization = await db.organization.findUnique({
      where: { clerkOrgId: orgId },
      include: {
        members: {
          where: { clerkUserId: userId },
          select: { role: true },
        },
      },
    });

    if (!organization) {
      return NextResponse.json({ error: "Organization not found" }, { status: 404 });
    }

    const member = organization.members[0];
    if (!member || !["OWNER", "ADMIN"].includes(member.role)) {
      return NextResponse.json({ error: "Forbidden - admin access required" }, { status: 403 });
    }

    const body = await req.json();
    const data = updatePreferencesSchema.parse(body);

    // Upsert preferences
    const preferences = await db.organizationNotificationPreference.upsert({
      where: { organizationId: organization.id },
      update: data,
      create: {
        organizationId: organization.id,
        ...data,
      },
    });

    return NextResponse.json(preferences);
  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: "Validation failed", details: error.issues },
        { status: 400 }
      );
    }
    console.error("Failed to update notification preferences:", error);
    return NextResponse.json({ error: "Internal server error" }, { status: 500 });
  }
}
```

Create directory: `src/app/api/organizations/current/notifications/`
  </action>
  <verify>
1. TypeScript compilation: `npx tsc --noEmit` passes
2. Dev server: `npm run dev` starts without errors
  </verify>
  <done>
- GET /api/organizations/current/notifications returns org notification preferences (creates defaults if none)
- PATCH /api/organizations/current/notifications updates preferences (OWNER/ADMIN only)
- Returns 403 for STAFF role users
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Notification Settings UI Component</name>
  <files>
    src/components/settings/notification-settings.tsx
    src/app/(dashboard)/settings/page.tsx
  </files>
  <action>
Create `src/components/settings/notification-settings.tsx`:

```tsx
"use client";

import { useState, useEffect } from "react";

interface NotificationPreferences {
  id: string;
  emailEnabled: boolean;
  emailInsuranceAlerts: boolean;
  emailAuditAlerts: boolean;
  emailComplianceAlerts: boolean;
  emailSystemAlerts: boolean;
  smsEnabled: boolean;
  smsInsuranceAlerts: boolean;
  smsAuditAlerts: boolean;
  smsCriticalAlerts: boolean;
  notificationEmail: string | null;
  notificationPhone: string | null;
}

export function NotificationSettings() {
  const [preferences, setPreferences] = useState<NotificationPreferences | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [isSaving, setIsSaving] = useState(false);
  const [message, setMessage] = useState<{ type: "success" | "error"; text: string } | null>(null);

  // Fetch preferences on mount
  useEffect(() => {
    async function fetchPreferences() {
      try {
        const response = await fetch("/api/organizations/current/notifications");
        if (!response.ok) throw new Error("Failed to fetch preferences");
        const data = await response.json();
        setPreferences(data);
      } catch (error) {
        console.error("Failed to fetch preferences:", error);
        setMessage({ type: "error", text: "Failed to load notification preferences" });
      } finally {
        setIsLoading(false);
      }
    }
    fetchPreferences();
  }, []);

  const handleToggle = async (field: keyof NotificationPreferences) => {
    if (!preferences) return;

    const newValue = !preferences[field];
    const updatedPreferences = { ...preferences, [field]: newValue };
    setPreferences(updatedPreferences);
    setMessage(null);

    try {
      setIsSaving(true);
      const response = await fetch("/api/organizations/current/notifications", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ [field]: newValue }),
      });

      if (!response.ok) {
        throw new Error("Failed to update preference");
      }

      setMessage({ type: "success", text: "Preference updated" });
      setTimeout(() => setMessage(null), 2000);
    } catch (error) {
      // Revert on error
      setPreferences(preferences);
      setMessage({ type: "error", text: "Failed to update preference" });
    } finally {
      setIsSaving(false);
    }
  };

  if (isLoading) {
    return (
      <div className="flex items-center justify-center py-8">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  if (!preferences) {
    return (
      <div className="text-red-600 py-4">
        Failed to load notification preferences. Please refresh the page.
      </div>
    );
  }

  const Toggle = ({
    checked,
    onChange,
    disabled = false,
  }: {
    checked: boolean;
    onChange: () => void;
    disabled?: boolean;
  }) => (
    <button
      type="button"
      onClick={onChange}
      disabled={disabled || isSaving}
      className={`relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 ${
        checked ? "bg-blue-600" : "bg-gray-200"
      }`}
    >
      <span
        className={`pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${
          checked ? "translate-x-5" : "translate-x-0"
        }`}
      />
    </button>
  );

  return (
    <div className="space-y-8">
      {/* Message */}
      {message && (
        <div
          className={`p-3 rounded-md text-sm ${
            message.type === "success"
              ? "bg-green-50 text-green-800"
              : "bg-red-50 text-red-800"
          }`}
        >
          {message.text}
        </div>
      )}

      {/* Email Notifications */}
      <div>
        <div className="flex items-center justify-between mb-4">
          <div>
            <h3 className="text-sm font-medium text-gray-900">Email Notifications</h3>
            <p className="text-sm text-gray-500">Receive notifications via email</p>
          </div>
          <Toggle
            checked={preferences.emailEnabled}
            onChange={() => handleToggle("emailEnabled")}
          />
        </div>

        {preferences.emailEnabled && (
          <div className="ml-4 space-y-4 border-l-2 border-gray-100 pl-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-700">Insurance Alerts</p>
                <p className="text-xs text-gray-500">Policy expiry reminders and updates</p>
              </div>
              <Toggle
                checked={preferences.emailInsuranceAlerts}
                onChange={() => handleToggle("emailInsuranceAlerts")}
              />
            </div>

            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-700">Audit Alerts</p>
                <p className="text-xs text-gray-500">Scheduled audits and reminders</p>
              </div>
              <Toggle
                checked={preferences.emailAuditAlerts}
                onChange={() => handleToggle("emailAuditAlerts")}
              />
            </div>

            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-700">Compliance Alerts</p>
                <p className="text-xs text-gray-500">Compliance score changes and warnings</p>
              </div>
              <Toggle
                checked={preferences.emailComplianceAlerts}
                onChange={() => handleToggle("emailComplianceAlerts")}
              />
            </div>

            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-700">System Alerts</p>
                <p className="text-xs text-gray-500">Important system notifications</p>
              </div>
              <Toggle
                checked={preferences.emailSystemAlerts}
                onChange={() => handleToggle("emailSystemAlerts")}
              />
            </div>
          </div>
        )}
      </div>

      {/* SMS Notifications */}
      <div className="pt-6 border-t border-gray-200">
        <div className="flex items-center justify-between mb-4">
          <div>
            <h3 className="text-sm font-medium text-gray-900">SMS Notifications</h3>
            <p className="text-sm text-gray-500">Receive urgent notifications via SMS</p>
          </div>
          <Toggle
            checked={preferences.smsEnabled}
            onChange={() => handleToggle("smsEnabled")}
          />
        </div>

        {preferences.smsEnabled && (
          <div className="ml-4 space-y-4 border-l-2 border-gray-100 pl-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-700">Insurance Alerts</p>
                <p className="text-xs text-gray-500">Urgent policy expiry warnings</p>
              </div>
              <Toggle
                checked={preferences.smsInsuranceAlerts}
                onChange={() => handleToggle("smsInsuranceAlerts")}
              />
            </div>

            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-700">Audit Alerts</p>
                <p className="text-xs text-gray-500">Upcoming audit reminders</p>
              </div>
              <Toggle
                checked={preferences.smsAuditAlerts}
                onChange={() => handleToggle("smsAuditAlerts")}
              />
            </div>

            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-700">Critical Alerts</p>
                <p className="text-xs text-gray-500">Critical compliance issues requiring immediate attention</p>
              </div>
              <Toggle
                checked={preferences.smsCriticalAlerts}
                onChange={() => handleToggle("smsCriticalAlerts")}
              />
            </div>
          </div>
        )}
      </div>

      <p className="text-xs text-gray-500 pt-4">
        Note: These settings control notifications sent to your organization. Individual staff members can configure their personal notification preferences separately.
      </p>
    </div>
  );
}
```

Update `src/app/(dashboard)/settings/page.tsx` to include the notification settings section.

After the existing Company Profile section (`</div>` closing the bg-white rounded-lg shadow), add:

```tsx
import { NotificationSettings } from "@/components/settings/notification-settings";

// ... then in the JSX, after the Company Profile section:

        <div className="bg-white rounded-lg shadow p-6">
          <h2 className="text-lg font-semibold text-gray-900 mb-6">
            Notification Preferences
          </h2>
          <NotificationSettings />
        </div>
```

The import should be added at the top of the file with other imports.
  </action>
  <verify>
1. TypeScript compilation: `npx tsc --noEmit` passes
2. Dev server: `npm run dev` starts without errors
3. Navigate to /settings as OWNER/ADMIN
4. Notification preferences section displays with toggles
5. Toggling a preference updates immediately and persists on page refresh
  </verify>
  <done>
- Notification settings component renders with all toggle options
- Email notifications section with master toggle and sub-toggles
- SMS notifications section with master toggle and sub-toggles
- Preferences update immediately when toggled
- Changes persist to database and survive page refresh
  </done>
</task>

</tasks>

<verification>
1. API returns 403 for STAFF role users
2. API creates default preferences on first GET if none exist
3. Notification settings UI loads and displays current preferences
4. Email master toggle enables/disables email section
5. SMS master toggle enables/disables SMS section
6. Individual toggles update preferences immediately
7. Changes persist across page refresh
</verification>

<success_criteria>
- Org admin can configure which notification types the organization receives (insurance, audit, compliance, system)
- Org admin can choose notification channels (email, SMS, or both) for organization alerts
- Non-admin staff cannot access these settings (403 from API)
- Default preferences are created automatically on first access
</success_criteria>

<output>
After completion, create `.planning/phases/09-organization-profile/09-03-SUMMARY.md`
</output>
