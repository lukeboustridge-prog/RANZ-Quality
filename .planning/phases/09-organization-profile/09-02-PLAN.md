---
phase: 09-organization-profile
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/app/api/organizations/current/route.ts
  - src/app/api/organizations/current/logo/route.ts
  - src/app/(dashboard)/settings/page.tsx
  - src/components/settings/organization-profile-form.tsx
  - src/components/settings/logo-upload.tsx
autonomous: true

must_haves:
  truths:
    - "Org admin can update trading name, contact details, description from settings page"
    - "Org admin can upload/change company logo"
    - "Non-admin staff cannot access organization settings (redirected)"
    - "Logo is stored in R2 and key is persisted in database"
  artifacts:
    - path: "src/app/api/organizations/current/route.ts"
      provides: "PATCH endpoint for organization profile updates"
      exports: ["PATCH", "GET"]
    - path: "src/app/api/organizations/current/logo/route.ts"
      provides: "POST endpoint for logo upload"
      exports: ["POST"]
    - path: "src/app/(dashboard)/settings/page.tsx"
      provides: "Settings page with role-based access control"
      min_lines: 30
    - path: "src/components/settings/organization-profile-form.tsx"
      provides: "Form component for editing organization profile"
      min_lines: 80
    - path: "src/components/settings/logo-upload.tsx"
      provides: "Logo upload component with preview"
      min_lines: 50
  key_links:
    - from: "src/components/settings/organization-profile-form.tsx"
      to: "/api/organizations/current"
      via: "fetch PATCH request"
      pattern: "fetch.*api/organizations/current"
    - from: "src/components/settings/logo-upload.tsx"
      to: "/api/organizations/current/logo"
      via: "FormData POST request"
      pattern: "fetch.*api/organizations/current/logo"
    - from: "src/app/(dashboard)/settings/page.tsx"
      to: "prisma.organization"
      via: "server-side role check"
      pattern: "OWNER.*ADMIN|ADMIN.*OWNER"
---

<objective>
Implement organization profile editing with logo upload for org admins.

Purpose: Allow org owners/admins to maintain their company's public-facing profile (ORG-01)
Output: Working settings page with profile form and logo upload, protected by role-based access
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-organization-profile/09-RESEARCH.md
@.planning/phases/09-organization-profile/09-01-SUMMARY.md
@src/app/api/organizations/route.ts
@src/lib/r2.ts
@src/lib/db.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Organization Profile API Routes</name>
  <files>
    src/app/api/organizations/current/route.ts
    src/app/api/organizations/current/logo/route.ts
  </files>
  <action>
Create `src/app/api/organizations/current/route.ts`:

```typescript
import { NextRequest, NextResponse } from "next/server";
import { auth } from "@clerk/nextjs/server";
import { db } from "@/lib/db";
import { z } from "zod/v4";

// GET - Get current organization profile
export async function GET() {
  try {
    const { userId, orgId } = await auth();
    if (!userId || !orgId) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const organization = await db.organization.findUnique({
      where: { clerkOrgId: orgId },
      select: {
        id: true,
        name: true,
        tradingName: true,
        email: true,
        phone: true,
        address: true,
        city: true,
        description: true,
        logoKey: true,
        nzbn: true,
      },
    });

    if (!organization) {
      return NextResponse.json({ error: "Organization not found" }, { status: 404 });
    }

    return NextResponse.json(organization);
  } catch (error) {
    console.error("Failed to fetch organization:", error);
    return NextResponse.json({ error: "Internal server error" }, { status: 500 });
  }
}

const updateOrgSchema = z.object({
  name: z.string().min(1, "Name is required").max(100).optional(),
  tradingName: z.string().max(100).nullable().optional(),
  email: z.string().email("Invalid email").nullable().optional(),
  phone: z.string().max(20).nullable().optional(),
  address: z.string().max(200).nullable().optional(),
  city: z.string().max(50).nullable().optional(),
  description: z.string().max(500).nullable().optional(),
});

// PATCH - Update organization profile (OWNER/ADMIN only)
export async function PATCH(req: NextRequest) {
  try {
    const { userId, orgId } = await auth();
    if (!userId || !orgId) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    // Get organization and verify membership + role
    const organization = await db.organization.findUnique({
      where: { clerkOrgId: orgId },
      include: {
        members: {
          where: { clerkUserId: userId },
          select: { role: true },
        },
      },
    });

    if (!organization) {
      return NextResponse.json({ error: "Organization not found" }, { status: 404 });
    }

    const member = organization.members[0];
    if (!member || !["OWNER", "ADMIN"].includes(member.role)) {
      return NextResponse.json({ error: "Forbidden - admin access required" }, { status: 403 });
    }

    const body = await req.json();
    const data = updateOrgSchema.parse(body);

    const updated = await db.organization.update({
      where: { id: organization.id },
      data,
      select: {
        id: true,
        name: true,
        tradingName: true,
        email: true,
        phone: true,
        address: true,
        city: true,
        description: true,
        logoKey: true,
        nzbn: true,
      },
    });

    return NextResponse.json(updated);
  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: "Validation failed", details: error.issues },
        { status: 400 }
      );
    }
    console.error("Failed to update organization:", error);
    return NextResponse.json({ error: "Internal server error" }, { status: 500 });
  }
}
```

Create `src/app/api/organizations/current/logo/route.ts`:

```typescript
import { NextRequest, NextResponse } from "next/server";
import { auth } from "@clerk/nextjs/server";
import { db } from "@/lib/db";
import { uploadToR2, deleteFromR2 } from "@/lib/r2";

const MAX_LOGO_SIZE = 2 * 1024 * 1024; // 2MB
const ALLOWED_TYPES = ["image/png", "image/jpeg", "image/webp"];

export async function POST(req: NextRequest) {
  try {
    const { userId, orgId } = await auth();
    if (!userId || !orgId) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    // Get organization and verify membership + role
    const organization = await db.organization.findUnique({
      where: { clerkOrgId: orgId },
      include: {
        members: {
          where: { clerkUserId: userId },
          select: { role: true },
        },
      },
    });

    if (!organization) {
      return NextResponse.json({ error: "Organization not found" }, { status: 404 });
    }

    const member = organization.members[0];
    if (!member || !["OWNER", "ADMIN"].includes(member.role)) {
      return NextResponse.json({ error: "Forbidden - admin access required" }, { status: 403 });
    }

    const formData = await req.formData();
    const file = formData.get("logo") as File | null;

    if (!file || file.size === 0) {
      return NextResponse.json({ error: "Logo file required" }, { status: 400 });
    }

    if (file.size > MAX_LOGO_SIZE) {
      return NextResponse.json({ error: "Logo must be under 2MB" }, { status: 413 });
    }

    if (!ALLOWED_TYPES.includes(file.type)) {
      return NextResponse.json(
        { error: "Logo must be PNG, JPEG, or WebP" },
        { status: 400 }
      );
    }

    const buffer = Buffer.from(await file.arrayBuffer());
    const ext = file.name.split(".").pop() || "png";
    const logoKey = `logos/${organization.id}/logo-${Date.now()}.${ext}`;

    const storageKey = await uploadToR2(buffer, logoKey, file.type);

    // Delete old logo if exists
    if (organization.logoKey) {
      try {
        await deleteFromR2(organization.logoKey);
      } catch (e) {
        // Log but don't fail - old logo cleanup is best-effort
        console.warn("Failed to delete old logo:", e);
      }
    }

    await db.organization.update({
      where: { id: organization.id },
      data: { logoKey: storageKey },
    });

    return NextResponse.json({ logoKey: storageKey });
  } catch (error) {
    console.error("Failed to upload logo:", error);
    return NextResponse.json({ error: "Internal server error" }, { status: 500 });
  }
}
```

Create the directories if they don't exist: `src/app/api/organizations/current/` and `src/app/api/organizations/current/logo/`
  </action>
  <verify>
1. TypeScript compilation: `npx tsc --noEmit` passes
2. Start dev server: `npm run dev`
3. Test PATCH endpoint returns 401 when not authenticated
  </verify>
  <done>
- GET /api/organizations/current returns org profile
- PATCH /api/organizations/current updates profile (OWNER/ADMIN only, returns 403 for STAFF)
- POST /api/organizations/current/logo uploads logo to R2 and updates logoKey
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Settings Page with Profile Form</name>
  <files>
    src/app/(dashboard)/settings/page.tsx
    src/components/settings/organization-profile-form.tsx
    src/components/settings/logo-upload.tsx
  </files>
  <action>
Create `src/app/(dashboard)/settings/page.tsx`:

```tsx
import { auth } from "@clerk/nextjs/server";
import { redirect } from "next/navigation";
import { db } from "@/lib/db";
import { getSignedDownloadUrl } from "@/lib/r2";
import { OrganizationProfileForm } from "@/components/settings/organization-profile-form";

export default async function SettingsPage() {
  const { userId, orgId } = await auth();

  if (!userId) redirect("/sign-in");
  if (!orgId) redirect("/onboarding");

  const organization = await db.organization.findUnique({
    where: { clerkOrgId: orgId },
    include: {
      members: {
        where: { clerkUserId: userId },
        select: { role: true },
      },
    },
  });

  if (!organization) redirect("/dashboard");

  const member = organization.members[0];
  if (!member || !["OWNER", "ADMIN"].includes(member.role)) {
    // Non-admin user - redirect to dashboard
    redirect("/dashboard");
  }

  // Get signed URL for logo if exists
  let logoUrl: string | null = null;
  if (organization.logoKey) {
    try {
      logoUrl = await getSignedDownloadUrl(organization.logoKey);
    } catch (e) {
      console.warn("Failed to get logo URL:", e);
    }
  }

  return (
    <div className="container mx-auto py-8 px-4 max-w-4xl">
      <div className="mb-8">
        <h1 className="text-2xl font-bold text-gray-900">Organization Settings</h1>
        <p className="text-gray-600 mt-1">
          Manage your company profile and notification preferences
        </p>
      </div>

      <div className="space-y-8">
        <div className="bg-white rounded-lg shadow p-6">
          <h2 className="text-lg font-semibold text-gray-900 mb-6">
            Company Profile
          </h2>
          <OrganizationProfileForm
            organization={{
              id: organization.id,
              name: organization.name,
              tradingName: organization.tradingName,
              email: organization.email,
              phone: organization.phone,
              address: organization.address,
              city: organization.city,
              description: organization.description,
              logoKey: organization.logoKey,
            }}
            logoUrl={logoUrl}
          />
        </div>

        {/* Notification preferences section will be added by Plan 09-03 */}
      </div>
    </div>
  );
}
```

Create `src/components/settings/organization-profile-form.tsx`:

```tsx
"use client";

import { useState } from "react";
import { LogoUpload } from "./logo-upload";

interface OrganizationData {
  id: string;
  name: string;
  tradingName: string | null;
  email: string | null;
  phone: string | null;
  address: string | null;
  city: string | null;
  description: string | null;
  logoKey: string | null;
}

interface OrganizationProfileFormProps {
  organization: OrganizationData;
  logoUrl: string | null;
}

export function OrganizationProfileForm({
  organization,
  logoUrl: initialLogoUrl,
}: OrganizationProfileFormProps) {
  const [formData, setFormData] = useState({
    name: organization.name,
    tradingName: organization.tradingName || "",
    email: organization.email || "",
    phone: organization.phone || "",
    address: organization.address || "",
    city: organization.city || "",
    description: organization.description || "",
  });
  const [logoUrl, setLogoUrl] = useState(initialLogoUrl);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [message, setMessage] = useState<{ type: "success" | "error"; text: string } | null>(null);

  const handleChange = (
    e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>
  ) => {
    const { name, value } = e.target;
    setFormData((prev) => ({ ...prev, [name]: value }));
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);
    setMessage(null);

    try {
      const response = await fetch("/api/organizations/current", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name: formData.name,
          tradingName: formData.tradingName || null,
          email: formData.email || null,
          phone: formData.phone || null,
          address: formData.address || null,
          city: formData.city || null,
          description: formData.description || null,
        }),
      });

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error || "Failed to update profile");
      }

      setMessage({ type: "success", text: "Profile updated successfully" });
    } catch (error) {
      setMessage({
        type: "error",
        text: error instanceof Error ? error.message : "Failed to update profile",
      });
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleLogoChange = (newLogoUrl: string | null) => {
    setLogoUrl(newLogoUrl);
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      {/* Logo Upload */}
      <LogoUpload currentLogoUrl={logoUrl} onLogoChange={handleLogoChange} />

      {/* Form Fields */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label htmlFor="name" className="block text-sm font-medium text-gray-700 mb-1">
            Company Name *
          </label>
          <input
            type="text"
            id="name"
            name="name"
            value={formData.name}
            onChange={handleChange}
            required
            maxLength={100}
            className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        <div>
          <label htmlFor="tradingName" className="block text-sm font-medium text-gray-700 mb-1">
            Trading Name
          </label>
          <input
            type="text"
            id="tradingName"
            name="tradingName"
            value={formData.tradingName}
            onChange={handleChange}
            maxLength={100}
            className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        <div>
          <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-1">
            Contact Email
          </label>
          <input
            type="email"
            id="email"
            name="email"
            value={formData.email}
            onChange={handleChange}
            className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        <div>
          <label htmlFor="phone" className="block text-sm font-medium text-gray-700 mb-1">
            Phone Number
          </label>
          <input
            type="tel"
            id="phone"
            name="phone"
            value={formData.phone}
            onChange={handleChange}
            maxLength={20}
            className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        <div className="md:col-span-2">
          <label htmlFor="address" className="block text-sm font-medium text-gray-700 mb-1">
            Street Address
          </label>
          <input
            type="text"
            id="address"
            name="address"
            value={formData.address}
            onChange={handleChange}
            maxLength={200}
            className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        <div>
          <label htmlFor="city" className="block text-sm font-medium text-gray-700 mb-1">
            City
          </label>
          <input
            type="text"
            id="city"
            name="city"
            value={formData.city}
            onChange={handleChange}
            maxLength={50}
            className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
          />
        </div>
      </div>

      <div>
        <label htmlFor="description" className="block text-sm font-medium text-gray-700 mb-1">
          Company Description
        </label>
        <textarea
          id="description"
          name="description"
          value={formData.description}
          onChange={handleChange}
          rows={4}
          maxLength={500}
          placeholder="Brief description of your company and services..."
          className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
        />
        <p className="text-sm text-gray-500 mt-1">
          {formData.description.length}/500 characters
        </p>
      </div>

      {/* Message */}
      {message && (
        <div
          className={`p-4 rounded-md ${
            message.type === "success"
              ? "bg-green-50 text-green-800"
              : "bg-red-50 text-red-800"
          }`}
        >
          {message.text}
        </div>
      )}

      {/* Submit Button */}
      <div className="flex justify-end">
        <button
          type="submit"
          disabled={isSubmitting}
          className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {isSubmitting ? "Saving..." : "Save Changes"}
        </button>
      </div>
    </form>
  );
}
```

Create `src/components/settings/logo-upload.tsx`:

```tsx
"use client";

import { useState, useRef } from "react";
import Image from "next/image";

interface LogoUploadProps {
  currentLogoUrl: string | null;
  onLogoChange: (newLogoUrl: string | null) => void;
}

export function LogoUpload({ currentLogoUrl, onLogoChange }: LogoUploadProps) {
  const [isUploading, setIsUploading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [previewUrl, setPreviewUrl] = useState<string | null>(currentLogoUrl);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    setError(null);

    // Validate file size (2MB)
    if (file.size > 2 * 1024 * 1024) {
      setError("Logo must be under 2MB");
      return;
    }

    // Validate file type
    if (!["image/png", "image/jpeg", "image/webp"].includes(file.type)) {
      setError("Logo must be PNG, JPEG, or WebP");
      return;
    }

    // Create preview
    const objectUrl = URL.createObjectURL(file);
    setPreviewUrl(objectUrl);

    // Upload
    setIsUploading(true);
    try {
      const formData = new FormData();
      formData.append("logo", file);

      const response = await fetch("/api/organizations/current/logo", {
        method: "POST",
        body: formData,
      });

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error || "Upload failed");
      }

      // Refresh the page to get new signed URL
      // In production, you might want to return the signed URL from the API
      window.location.reload();
    } catch (err) {
      setError(err instanceof Error ? err.message : "Upload failed");
      setPreviewUrl(currentLogoUrl); // Revert preview
    } finally {
      setIsUploading(false);
    }
  };

  const handleClick = () => {
    fileInputRef.current?.click();
  };

  return (
    <div className="flex items-start gap-6">
      <div className="flex-shrink-0">
        <div
          className={`w-24 h-24 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden bg-gray-50 ${
            isUploading ? "opacity-50" : ""
          }`}
        >
          {previewUrl ? (
            <Image
              src={previewUrl}
              alt="Company logo"
              width={96}
              height={96}
              className="w-full h-full object-contain"
            />
          ) : (
            <svg
              className="w-12 h-12 text-gray-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={1.5}
                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
              />
            </svg>
          )}
        </div>
      </div>

      <div className="flex-1">
        <h3 className="text-sm font-medium text-gray-700">Company Logo</h3>
        <p className="text-sm text-gray-500 mt-1">
          PNG, JPEG, or WebP. Max 2MB. Displayed on your profile and reports.
        </p>

        <input
          ref={fileInputRef}
          type="file"
          accept="image/png,image/jpeg,image/webp"
          onChange={handleFileSelect}
          className="hidden"
        />

        <button
          type="button"
          onClick={handleClick}
          disabled={isUploading}
          className="mt-3 px-4 py-2 text-sm border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50"
        >
          {isUploading ? "Uploading..." : previewUrl ? "Change Logo" : "Upload Logo"}
        </button>

        {error && (
          <p className="text-sm text-red-600 mt-2">{error}</p>
        )}
      </div>
    </div>
  );
}
```

Create directory structure first: `src/app/(dashboard)/settings/` and `src/components/settings/`
  </action>
  <verify>
1. TypeScript compilation: `npx tsc --noEmit` passes
2. Dev server: `npm run dev` starts without errors
3. Navigate to /settings - should redirect to /dashboard if not OWNER/ADMIN
4. As OWNER/ADMIN, /settings page loads with profile form
  </verify>
  <done>
- Settings page renders with role-based access (non-admins redirected)
- Organization profile form displays current values
- Logo upload component shows current logo or placeholder
- Form submission updates organization via API
- Logo upload stores file in R2 and updates database
  </done>
</task>

</tasks>

<verification>
1. Non-admin (STAFF role) user is redirected when accessing /settings
2. OWNER/ADMIN can view settings page
3. Profile form shows current organization data
4. Editing and saving profile updates the database
5. Uploading a logo stores in R2 and displays on page
6. Validation errors are displayed (file too large, wrong type)
</verification>

<success_criteria>
- Org admin can update trading name, contact details, description from settings page
- Org admin can upload/change company logo (displayed on profile)
- Non-admin staff cannot access organization settings (redirected to /dashboard)
- API returns 403 for STAFF role users attempting updates
</success_criteria>

<output>
After completion, create `.planning/phases/09-organization-profile/09-02-SUMMARY.md`
</output>
