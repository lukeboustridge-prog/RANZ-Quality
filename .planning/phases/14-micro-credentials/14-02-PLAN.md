---
phase: 14-micro-credentials
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/app/api/admin/micro-credentials/assign/route.ts
  - src/app/api/admin/micro-credentials/[id]/staff/route.ts
  - src/app/(admin)/admin/micro-credentials/[id]/page.tsx
  - src/app/(dashboard)/staff/[id]/page.tsx
  - src/app/(dashboard)/credentials/page.tsx
  - src/components/layout/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "RANZ admin can assign a micro-credential to a staff member with an initial status"
    - "RANZ admin can update the status of a staff member's credential (Not Started through Awarded/Expired)"
    - "RANZ admin can view all staff assigned to a specific credential definition with their statuses"
    - "Org admin can see all their staff members' micro-credential status in a single credentials page"
    - "Org admin credential view shows status breakdown per staff member across all credential types"
  artifacts:
    - path: "src/app/api/admin/micro-credentials/assign/route.ts"
      provides: "POST endpoint for assigning a credential to a staff member"
      exports: ["POST"]
    - path: "src/app/api/admin/micro-credentials/[id]/staff/route.ts"
      provides: "GET staff list for a definition, PATCH to update credential status"
      exports: ["GET", "PATCH"]
    - path: "src/app/(admin)/admin/micro-credentials/[id]/page.tsx"
      provides: "Admin detail page for a credential definition showing assigned staff"
    - path: "src/app/(dashboard)/credentials/page.tsx"
      provides: "Org admin view of all staff credential statuses (Server Component with direct Prisma queries)"
  key_links:
    - from: "src/app/(admin)/admin/micro-credentials/[id]/page.tsx"
      to: "/api/admin/micro-credentials/[id]/staff"
      via: "fetch GET for staff list and PATCH for status updates"
      pattern: "fetch.*api/admin/micro-credentials.*staff"
    - from: "src/app/api/admin/micro-credentials/assign/route.ts"
      to: "prisma.staffMicroCredential"
      via: "database create"
      pattern: "prisma\\.staffMicroCredential\\.create"
    - from: "src/app/(dashboard)/credentials/page.tsx"
      to: "prisma (direct query)"
      via: "Server Component direct Prisma query (no API route)"
      pattern: "db\\.organization\\.findUnique.*microCredentials"
    - from: "src/components/layout/sidebar.tsx"
      to: "/credentials"
      via: "navigation array entry"
      pattern: "href.*credentials"
---

<objective>
Enable RANZ admin to assign micro-credentials to staff members and update their status, and provide org admins with a view of all their staff's credential statuses.

Purpose: This connects credential definitions (from Plan 01) to actual staff members, enabling the core tracking workflow. RANZ admin assigns credentials and manages progression (Not Started -> In Training -> Assessment Pending -> Awarded). Org admin gets visibility into their workforce's credential landscape.

Output: Admin assignment + status management pages, org-facing credentials overview page, sidebar navigation updated.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-micro-credentials/14-01-SUMMARY.md
@prisma/schema.prisma
@src/types/index.ts
@src/app/(admin)/admin/micro-credentials/page.tsx
@src/app/(dashboard)/staff/[id]/page.tsx
@src/components/layout/sidebar.tsx
@src/lib/db.ts
@src/lib/audit-log.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin assignment API and credential detail page with staff management</name>
  <files>
    src/app/api/admin/micro-credentials/assign/route.ts
    src/app/api/admin/micro-credentials/[id]/staff/route.ts
    src/app/(admin)/admin/micro-credentials/[id]/page.tsx
  </files>
  <action>
    1. Create src/app/api/admin/micro-credentials/assign/route.ts:
       - POST endpoint requiring ranz:admin role
       - Body validated with Zod:
         ```
         definitionId: z.string().cuid()
         memberId: z.string().cuid()
         status: z.enum(["NOT_STARTED", "IN_TRAINING", "ASSESSMENT_PENDING", "AWARDED", "EXPIRED"]).default("NOT_STARTED")
         expiryDate: z.string().datetime().optional()  // ISO date string, only relevant for AWARDED
         notes: z.string().max(1000).optional()
         ```
       - Validate definitionId exists (findUnique on MicroCredentialDefinition)
       - Validate memberId exists (findUnique on OrganizationMember, include organization for audit log context)
       - Check no existing StaffMicroCredential for this [definitionId, memberId] combo (return 409 if exists)
       - Create StaffMicroCredential record. If status is AWARDED, set awardedAt to now() and awardedBy to current userId.
       - Log audit event: MCRED_ASSIGN, resourceType "StaffMicroCredential", metadata includes staff name, credential title, org name
       - Return 201 with created record

    2. Create src/app/api/admin/micro-credentials/[id]/staff/route.ts:
       - GET: Given a definition ID, return all StaffMicroCredential records for that definition, including member data (firstName, lastName, email, organization.name, organization.id). Requires ranz:admin. Order by organization name, then member lastName.
       - PATCH: Update a staff credential record. Body validated with Zod:
         ```
         staffCredentialId: z.string().cuid()
         status: z.enum(["NOT_STARTED", "IN_TRAINING", "ASSESSMENT_PENDING", "AWARDED", "EXPIRED"]).optional()
         expiryDate: z.string().datetime().nullable().optional()
         notes: z.string().max(1000).optional()
         ```
         If status changes TO "AWARDED": set awardedAt to now(), awardedBy to userId. If expiryDate not provided when awarding, leave it null (admin can set later).
         If status changes TO "EXPIRED": this is typically done by cron, but admin can also manually expire.
         Reset expiryAlert flags to false if expiryDate changes (so new notifications can fire).
         Log audit event: MCRED_AWARD (if becoming AWARDED) or UPDATE otherwise.
         Return 200.

    3. Create src/app/(admin)/admin/micro-credentials/[id]/page.tsx:
       - "use client" component
       - Page title: shows the credential definition title, level badge (e.g., "Level 5"), and issuing body
       - "Back to Definitions" link at top
       - Two sections:
         a) **Definition Details** card: Read-only display of title, level, skill standard, issuing body, requirements. "Edit" button that navigates back to definitions page (edit is handled there).
         b) **Assigned Staff** section:
            - Fetch staff list from GET /api/admin/micro-credentials/[id]/staff
            - Table with columns: Staff Name, Organisation, Status (badge), Expiry Date, Awarded Date, Actions
            - Status badge colors: NOT_STARTED=slate, IN_TRAINING=blue, ASSESSMENT_PENDING=yellow, AWARDED=green, EXPIRED=red
            - Actions column: "Update Status" dropdown/button that opens a status change dialog. Use a simple inline select element or window.prompt with options. The cleanest approach: each row has a select dropdown for status (pre-selected to current), and a "Save" button that appears when changed (PATCH to /api/admin/micro-credentials/[id]/staff). When changing to AWARDED, also show a date input for expiry date.
            - "Assign Staff" button at top of section:
              - Opens a form with: search/select for organization (dropdown fetched from GET /api/admin/members), then select staff member within that org
              - For simplicity: two input fields -- Org search (text input that filters), Staff member select (dropdown populated after org selected)
              - OR simpler: a single text input for "Staff Member ID" with instructions, plus a search dialog. Given the admin programme page uses simple window.prompt patterns, use a modal-like card:
                - "Assign Staff" button toggles an assignment form card
                - Form has: select Organization (fetch from /api/admin/members to get org list), select Staff Member (populated from selected org's members), optional Notes textarea, Submit
                - POST to /api/admin/micro-credentials/assign
            - Summary stats at top: total assigned, by status counts (e.g., "5 Awarded, 3 In Training, 2 Not Started")
       - Use lucide-react icons: ArrowLeft for back, UserPlus for assign, GraduationCap for page header

  </action>
  <verify>
    Run `pnpm typecheck` passes with no errors.
    Navigate to /admin/micro-credentials/[id] for any definition -- page renders with definition details.
    Assign a staff member via the form -- StaffMicroCredential record created.
    Update status to AWARDED -- awardedAt and awardedBy are set.
    Staff list shows correct status badges and counts.
  </verify>
  <done>
    RANZ admin can view credential definition detail at /admin/micro-credentials/[id].
    RANZ admin can assign staff members to a credential with initial status.
    RANZ admin can update staff credential status (including transitions to AWARDED with expiry date).
    Staff list shows all assigned members with status badges, org name, and dates.
    Assignment prevents duplicates (409 on existing combo).
    All operations logged to audit trail.
  </done>
</task>

<task type="auto">
  <name>Task 2: Org admin credentials view and dashboard sidebar nav</name>
  <files>
    src/app/(dashboard)/credentials/page.tsx
    src/components/layout/sidebar.tsx
  </files>
  <action>
    1. Create src/app/(dashboard)/credentials/page.tsx:
       - Server Component (async function, NOT "use client") -- uses direct Prisma queries, no API route needed
       - NOTE: This page will be converted to "use client" in Plan 03 when evidence upload interactivity is added. For now, Server Component is correct.
       - Import auth from @clerk/nextjs/server, redirect if no orgId
       - Query all StaffMicroCredential records for all OrganizationMembers in the current org:
         ```typescript
         const organization = await db.organization.findUnique({
           where: { clerkOrgId: orgId },
           include: {
             members: {
               include: {
                 microCredentials: {
                   include: {
                     definition: true,
                   },
                   orderBy: { definition: { title: "asc" } },
                 },
               },
               orderBy: [{ role: "asc" }, { firstName: "asc" }],
             },
           },
         });
         ```
       - Page layout:
         a) Header: "Staff Credentials" title with GraduationCap icon, subtitle "View your team's micro-credential status"
         b) Summary cards row (3 cards):
            - Total Credentials Assigned (count of all StaffMicroCredential)
            - Awarded (count where status = AWARDED)
            - In Progress (count where status IN [IN_TRAINING, ASSESSMENT_PENDING])
         c) Staff credential matrix: A table/grid showing each staff member as a row, with columns for each credential definition they have assigned:
            - Column 1: Staff name (firstName lastName), role badge
            - Remaining columns: one per unique credential definition. Cell shows status badge (colored).
            - If a staff member has no credentials assigned, show an em-dash or "None assigned" in a single spanning cell
         d) Alternative simpler layout if the matrix is complex: List view grouped by staff member. Each staff member gets a card showing their name, role, and a list of assigned credentials with status badges and expiry dates.
         - Choose the LIST VIEW approach (simpler, more readable, works well with variable numbers of credentials):
           - For each member with credentials: Card with member name/role as header, then a list of credential items showing: definition title, level badge, status badge, expiry date (if AWARDED), awarded date (if AWARDED)
           - Members with no credentials: still show them with "No credentials assigned" message
       - Empty state: If org has no staff at all, show empty state card directing to /staff
       - If org has staff but none have credentials, show info message: "No micro-credentials have been assigned to your staff yet. Credentials are managed by RANZ administration."
       - Use existing UI: Card, CardHeader, CardTitle, CardContent, Badge from @/components/ui

    2. Update src/components/layout/sidebar.tsx:
       - Add "Credentials" nav item to the navigation array, positioned after "Programme" (the last current item before secondaryNavigation):
         ```
         { name: "Credentials", href: "/credentials", icon: GraduationCap }
         ```
       - Import GraduationCap from lucide-react.
       - Final navigation order: Dashboard, Insurance, Staff, Documents, Suppliers, Projects, Audits, CAPA, Programme, Credentials

  </action>
  <verify>
    Run `pnpm typecheck` passes with no errors.
    Run `pnpm build` succeeds.
    Navigate to /credentials in the dashboard sidebar -- link appears after Programme.
    Visit /credentials -- shows staff credential list (or empty state if no assignments exist).
    After assigning credentials via admin, the org view reflects them correctly.
  </verify>
  <done>
    Sidebar shows "Credentials" nav item with GraduationCap icon after Programme.
    /credentials page renders staff credential list grouped by staff member.
    Each staff member shows their assigned credentials with status badges, level, and dates.
    Empty states handled: no staff -> direct to /staff, no credentials -> informational message.
    Summary cards show aggregate counts (total, awarded, in progress).
    Build passes with zero errors.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm build` succeeds
3. RANZ admin can assign credentials to staff at /admin/micro-credentials/[id]
4. RANZ admin can update credential status
5. Org admin can view credentials at /credentials in dashboard
6. Sidebar shows Credentials link
7. Status badges render correctly with appropriate colors
</verification>

<success_criteria>
- RANZ admin can assign micro-credentials to any staff member with initial status
- RANZ admin can update status through the full lifecycle (Not Started -> In Training -> Assessment Pending -> Awarded -> Expired)
- Admin detail page shows staff list with status summary and individual management
- Org admin sees all their staff's credential statuses at /credentials
- Dashboard sidebar includes Credentials navigation
- Build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/14-micro-credentials/14-02-SUMMARY.md`
</output>
