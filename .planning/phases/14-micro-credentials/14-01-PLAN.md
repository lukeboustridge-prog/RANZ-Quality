---
phase: 14-micro-credentials
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/types/index.ts
  - src/lib/notifications.ts
  - src/app/api/admin/micro-credentials/route.ts
  - src/app/api/admin/micro-credentials/[id]/route.ts
  - src/app/(admin)/admin/micro-credentials/page.tsx
  - src/app/(admin)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "MicroCredentialDefinition and StaffMicroCredential models exist in database"
    - "RANZ admin can create a new micro-credential definition with title, level, skill standard reference, issuing body, and requirements description"
    - "RANZ admin can edit and delete existing credential definitions"
    - "Three default RANZ credential definitions exist in the database (Reclad/Reroofing L5, Repairs/Maintenance L5, Compliance Practices L4)"
    - "Admin navigation includes Micro-credentials link"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "MicroCredentialDefinition and StaffMicroCredential models with MicroCredentialStatus enum"
      contains: "model MicroCredentialDefinition"
    - path: "src/types/index.ts"
      provides: "MicroCredentialStatus type, labels, and CREDENTIAL_EXPIRY notification type"
      contains: "MicroCredentialStatus"
    - path: "src/app/api/admin/micro-credentials/route.ts"
      provides: "GET list and POST create endpoints for credential definitions"
      exports: ["GET", "POST"]
    - path: "src/app/api/admin/micro-credentials/[id]/route.ts"
      provides: "GET single, PATCH update, DELETE endpoints for credential definitions"
      exports: ["GET", "PATCH", "DELETE"]
    - path: "src/app/(admin)/admin/micro-credentials/page.tsx"
      provides: "Admin page to manage credential definitions"
  key_links:
    - from: "src/app/(admin)/admin/micro-credentials/page.tsx"
      to: "/api/admin/micro-credentials"
      via: "fetch GET/POST/PATCH/DELETE for CRUD"
      pattern: "fetch.*api/admin/micro-credentials"
    - from: "src/app/api/admin/micro-credentials/route.ts"
      to: "prisma.microCredentialDefinition"
      via: "database CRUD operations"
      pattern: "prisma\\.microCredentialDefinition\\.(findMany|create)"
    - from: "src/app/(admin)/layout.tsx"
      to: "/admin/micro-credentials"
      via: "navigation array entry"
      pattern: "href.*admin/micro-credentials"
---

<objective>
Create the micro-credential database models (definitions and staff assignments), TypeScript types, RANZ admin CRUD for credential definitions, seed three default RANZ credentials, and add admin navigation.

Purpose: This is the foundation for all Phase 14 work. The two new models (MicroCredentialDefinition for what credentials exist, StaffMicroCredential for tracking who has what) must exist before assignment, org views, evidence upload, or notifications can be built. The admin definitions page is the entry point for the entire micro-credential workflow.

Output: Prisma migration applied, types exported, admin CRUD page working with 3 pre-seeded definitions, admin nav updated.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@prisma/schema.prisma
@src/types/index.ts
@src/app/(admin)/layout.tsx
@src/lib/db.ts
@src/lib/audit-log.ts
@src/lib/notifications.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prisma schema, migration, and TypeScript types</name>
  <files>
    prisma/schema.prisma
    src/types/index.ts
    src/lib/notifications.ts
  </files>
  <action>
    1. Add MicroCredentialStatus enum to prisma/schema.prisma (after the ProgrammeEnrolmentStatus enum):
       ```
       enum MicroCredentialStatus {
         NOT_STARTED
         IN_TRAINING
         ASSESSMENT_PENDING
         AWARDED
         EXPIRED
       }
       ```

    2. Add MicroCredentialDefinition model to prisma/schema.prisma (new section "Phase 14: Micro-Credentials" after the Programme Enrolment section):
       ```
       model MicroCredentialDefinition {
         id               String @id @default(cuid())
         title            String  // e.g., "Reclad/Reroofing Level 5"
         level            Int     // NQF level (e.g., 4, 5)
         skillStandard    String? // Skill standard reference (e.g., "NZQA Unit Standard 12345")
         issuingBody      String  // e.g., "RANZ", "NZQA"
         requirements     String? // Description of requirements to achieve
         isDefault        Boolean @default(false) // True for the 3 pre-seeded RANZ credentials

         createdAt DateTime @default(now())
         updatedAt DateTime @updatedAt

         staffCredentials StaffMicroCredential[]

         @@index([title])
       }
       ```

    3. Add StaffMicroCredential model (the join between a definition and a staff member):
       ```
       model StaffMicroCredential {
         id             String @id @default(cuid())
         definitionId   String
         memberId       String  // OrganizationMember ID

         status         MicroCredentialStatus @default(NOT_STARTED)

         // Award tracking
         awardedAt      DateTime?
         awardedBy      String?   // Clerk user ID of RANZ admin who awarded

         // Expiry
         expiryDate     DateTime?
         expiryAlert90Sent Boolean @default(false)
         expiryAlert60Sent Boolean @default(false)
         expiryAlert30Sent Boolean @default(false)

         // Certificate evidence (R2)
         certificateKey String?  // R2 storage key for uploaded certificate
         certificateFileName String?
         certificateUploadedAt DateTime?
         certificateUploadedBy String? // Clerk user ID

         // Notes
         notes          String?

         createdAt DateTime @default(now())
         updatedAt DateTime @updatedAt

         definition MicroCredentialDefinition @relation(fields: [definitionId], references: [id], onDelete: Cascade)
         member     OrganizationMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

         @@unique([definitionId, memberId])  // One credential per staff per definition
         @@index([memberId])
         @@index([definitionId])
         @@index([status])
         @@index([expiryDate])
       }
       ```

    4. Add relation to OrganizationMember model -- add `microCredentials StaffMicroCredential[]` after the `trainingRecords` relation.

    5. Add `CREDENTIAL_EXPIRY` and `CREDENTIAL_STATUS_CHANGE` to the NotificationType enum in schema.prisma.

    6. Add `MCRED_ASSIGN`, `MCRED_AWARD`, `MCRED_EXPIRE` to the AuditAction enum in schema.prisma.

    7. Run `pnpm prisma db push` to apply schema changes.

    8. In src/types/index.ts:
       - Add MicroCredentialStatus type:
         ```typescript
         export type MicroCredentialStatus =
           | "NOT_STARTED"
           | "IN_TRAINING"
           | "ASSESSMENT_PENDING"
           | "AWARDED"
           | "EXPIRED";
         ```
       - Add MICRO_CREDENTIAL_STATUS_LABELS constant:
         ```typescript
         export const MICRO_CREDENTIAL_STATUS_LABELS: Record<MicroCredentialStatus, string> = {
           NOT_STARTED: "Not Started",
           IN_TRAINING: "In Training",
           ASSESSMENT_PENDING: "Assessment Pending",
           AWARDED: "Awarded",
           EXPIRED: "Expired",
         };
         ```
       - Add `CREDENTIAL_EXPIRY` and `CREDENTIAL_STATUS_CHANGE` to the NotificationType union type.
       - Add labels for both: `CREDENTIAL_EXPIRY: "Credential Expiry Warning"` and `CREDENTIAL_STATUS_CHANGE: "Credential Status Changed"` to NOTIFICATION_TYPE_LABELS.
       - Add `MCRED_ASSIGN`, `MCRED_AWARD`, `MCRED_EXPIRE` to AuditAction type.

    9. Update src/lib/notifications.ts -- add CREDENTIAL_EXPIRY and CREDENTIAL_STATUS_CHANGE to ALL four notification preference mapping objects:
       - NOTIFICATION_TYPE_TO_EMAIL_PREF: CREDENTIAL_EXPIRY -> "emailCompliance", CREDENTIAL_STATUS_CHANGE -> null (always send)
       - NOTIFICATION_TYPE_TO_SMS_PREF: CREDENTIAL_EXPIRY -> "smsCritical", CREDENTIAL_STATUS_CHANGE -> "smsCritical"
       - NOTIFICATION_TYPE_TO_ORG_EMAIL_PREF: CREDENTIAL_EXPIRY -> "emailComplianceAlerts", CREDENTIAL_STATUS_CHANGE -> "emailSystemAlerts"
       - NOTIFICATION_TYPE_TO_ORG_SMS_PREF: CREDENTIAL_EXPIRY -> "smsInsuranceAlerts", CREDENTIAL_STATUS_CHANGE -> "smsCriticalAlerts"
       This is needed now to prevent TypeScript errors since the NotificationType union is expanded.

    IMPORTANT: Do NOT remove or modify any existing types/enums -- only append new values. Use `pnpm prisma db push` (NOT migrate -- this project uses db push with Neon).
  </action>
  <verify>
    Run `pnpm prisma db push` succeeds without errors.
    Run `pnpm typecheck` passes.
    Confirm MicroCredentialDefinition and StaffMicroCredential models exist in generated Prisma client.
  </verify>
  <done>
    MicroCredentialDefinition and StaffMicroCredential tables exist in database with all columns.
    MicroCredentialStatus enum has 5 states (NOT_STARTED, IN_TRAINING, ASSESSMENT_PENDING, AWARDED, EXPIRED).
    TypeScript types and labels are exported from src/types/index.ts.
    NotificationType includes CREDENTIAL_EXPIRY and CREDENTIAL_STATUS_CHANGE.
    AuditAction includes MCRED_ASSIGN, MCRED_AWARD, MCRED_EXPIRE.
    Notification preference mappings updated -- no TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin CRUD API, definitions page, seed defaults, and admin nav</name>
  <files>
    src/app/api/admin/micro-credentials/route.ts
    src/app/api/admin/micro-credentials/[id]/route.ts
    src/app/(admin)/admin/micro-credentials/page.tsx
    src/app/(admin)/layout.tsx
  </files>
  <action>
    1. Create src/app/api/admin/micro-credentials/route.ts:
       - GET: Returns all MicroCredentialDefinition records ordered by level DESC, title ASC. Include a count of StaffMicroCredential per definition (use _count). Requires ranz:admin role (check via Clerk auth publicMetadata.role).
       - POST: Creates a new MicroCredentialDefinition. Body validated with Zod:
         ```
         title: z.string().min(3).max(200)
         level: z.number().int().min(1).max(10)
         skillStandard: z.string().max(200).optional()
         issuingBody: z.string().min(1).max(200)
         requirements: z.string().max(2000).optional()
         ```
         Set isDefault: false (only seed data gets isDefault: true).
         Log audit event with action CREATE, resourceType "MicroCredentialDefinition".
         Return 201 with created record.
       - Require ranz:admin role for both endpoints. Pattern: `const { userId } = await auth(); const user = await clerkClient.users.getUser(userId); const role = user.publicMetadata?.role;` -- or use the pattern from existing admin routes (check how admin/programme/route.ts does it).

    2. Create src/app/api/admin/micro-credentials/[id]/route.ts:
       - GET: Return single definition with _count of staff credentials grouped by status. Requires ranz:admin.
       - PATCH: Update definition fields (same Zod schema as POST but all fields optional). Do NOT allow changing isDefault. Log audit event with action UPDATE. Return 200.
       - DELETE: Only allow deletion if isDefault is false AND no StaffMicroCredential records reference it (_count is 0). Otherwise return 409 with message explaining why deletion is blocked. Log audit event with action DELETE. Return 200.
       - All require ranz:admin role.

    3. Create src/app/(admin)/admin/micro-credentials/page.tsx:
       - "use client" component (consistent with admin layout pattern)
       - Fetch definitions from GET /api/admin/micro-credentials on mount
       - Display as a table/card list with columns: Title, Level, Issuing Body, Skill Standard, Assigned Count, Default badge, Actions
       - "Create Definition" button at top that opens an inline form or dialog (use window.prompt pattern consistent with Phase 13 admin page -- or a simple inline form with Input/Textarea fields that appears above the table)
       - For simplicity and consistency with the admin programme page, use an inline form that toggles visibility:
         - When "Create Definition" is clicked, show a form card at the top with Title, Level (number input), Issuing Body, Skill Standard (optional), Requirements (textarea, optional), and Save/Cancel buttons
         - On Save, POST to /api/admin/micro-credentials, refresh the list
       - Edit: clicking "Edit" on a row opens the same inline form pre-filled with values, PATCH on save
       - Delete: clicking "Delete" on a row shows window.confirm dialog, then DELETE
       - Default definitions show a "Default" badge and have the Delete button disabled
       - Use existing UI components: Card, CardHeader, CardTitle, CardContent, Button, Input, Badge, Table (or just styled divs like admin/programme/page.tsx uses)
       - Use lucide-react icons: GraduationCap for page header, Plus for create button, Pencil for edit, Trash2 for delete

    4. Seed three default RANZ micro-credential definitions. Add logic at the bottom of the GET handler in the admin route (or better: add an initialization check). The cleanest approach: In the GET /api/admin/micro-credentials route, before returning results, check if any records with isDefault: true exist. If not, create them:
       ```
       const defaults = [
         {
           title: "Reclad/Reroofing Level 5",
           level: 5,
           skillStandard: "NZQA Skill Standard - Reclad/Reroofing",
           issuingBody: "RANZ",
           requirements: "Completion of RANZ RoofWright Level 5 assessment for reclad and reroofing projects. Covers scope management, weathertightness detailing, and compliance documentation.",
           isDefault: true,
         },
         {
           title: "Repairs/Maintenance Level 5",
           level: 5,
           skillStandard: "NZQA Skill Standard - Repairs/Maintenance",
           issuingBody: "RANZ",
           requirements: "Completion of RANZ RoofWright Level 5 assessment for repair and maintenance work. Covers diagnostic assessment, material selection, and warranty management.",
           isDefault: true,
         },
         {
           title: "Compliance Practices Level 4",
           level: 4,
           skillStandard: "NZQA Skill Standard - Compliance Practices",
           issuingBody: "RANZ",
           requirements: "Completion of RANZ RoofWright Level 4 assessment for building compliance practices. Covers Building Act requirements, consent processes, and record of work procedures.",
           isDefault: true,
         },
       ];
       ```
       Use createMany with skipDuplicates, or check count first then bulk create. This ensures the defaults are auto-populated on first admin visit.

    5. Update src/app/(admin)/layout.tsx:
       - Add "Micro-credentials" nav item to the navigation array, positioned after "Programme":
         ```
         { name: "Micro-credentials", href: "/admin/micro-credentials", icon: GraduationCap }
         ```
       - Import GraduationCap from lucide-react.

  </action>
  <verify>
    Run `pnpm typecheck` passes with no errors.
    Navigate to /admin/micro-credentials -- page renders with 3 default definitions.
    Create a new definition via the form -- it appears in the list.
    Edit an existing custom definition -- changes persist.
    Delete a custom definition with 0 assignments -- succeeds.
    Attempt to delete a default definition -- blocked with appropriate message.
    Admin nav shows "Micro-credentials" link.
  </verify>
  <done>
    Admin nav includes "Micro-credentials" with GraduationCap icon after Programme.
    /admin/micro-credentials page shows table of definitions with CRUD functionality.
    Three default RANZ definitions are auto-seeded (Reclad/Reroofing L5, Repairs/Maintenance L5, Compliance Practices L4).
    Default definitions show "Default" badge and cannot be deleted.
    Custom definitions can be created, edited, and deleted (if no assignments exist).
    All CRUD operations logged to audit trail.
    Build passes with zero errors.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm prisma db push` succeeds
3. Database has MicroCredentialDefinition and StaffMicroCredential tables (verify via `pnpm db:studio`)
4. Admin nav shows Micro-credentials link
5. /admin/micro-credentials page renders with 3 default definitions
6. CRUD operations work: create, edit, delete (with constraints)
</verification>

<success_criteria>
- MicroCredentialDefinition and StaffMicroCredential models exist in database
- MicroCredentialStatus enum has 5 states
- RANZ admin can CRUD credential definitions at /admin/micro-credentials
- Three default RANZ definitions auto-populate on first visit
- Default definitions are protected from deletion
- TypeScript types, notification mappings, and audit actions are complete
- Build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/14-micro-credentials/14-01-SUMMARY.md`
</output>
