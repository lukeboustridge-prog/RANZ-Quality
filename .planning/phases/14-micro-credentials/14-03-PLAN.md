---
phase: 14-micro-credentials
plan: 03
type: execute
wave: 3
depends_on: ["14-02"]
files_modified:
  - src/app/api/credentials/route.ts
  - src/app/api/credentials/[id]/evidence/route.ts
  - src/app/(dashboard)/credentials/page.tsx
  - src/app/api/cron/notifications/route.ts
  - src/app/api/admin/micro-credentials/report/route.ts
  - src/app/(admin)/admin/micro-credentials/page.tsx
autonomous: true

must_haves:
  truths:
    - "Staff member can upload certificate evidence (PDF/image) against an awarded micro-credential"
    - "Staff member can view/download previously uploaded certificate evidence via a signed R2 URL"
    - "Uploaded certificate is stored in Cloudflare R2 and the credential record is updated with the storage key"
    - "System sends expiry notifications at 90, 60, and 30 days before credential expiry"
    - "Expiry notification flags prevent duplicate alerts for the same credential"
    - "RANZ admin can view a report showing micro-credential coverage across all member organisations"
    - "Coverage report shows per-org breakdown: total staff, credentials assigned, credentials awarded, and percentage"
  artifacts:
    - path: "src/app/api/credentials/route.ts"
      provides: "GET endpoint for org's staff credential data (client-side fetch)"
      exports: ["GET"]
    - path: "src/app/api/credentials/[id]/evidence/route.ts"
      provides: "POST endpoint for uploading certificate evidence to R2, GET endpoint for retrieving signed download URL"
      exports: ["GET", "POST"]
    - path: "src/app/api/cron/notifications/route.ts"
      provides: "Updated cron with credential expiry check function"
      contains: "checkCredentialExpiries"
    - path: "src/app/api/admin/micro-credentials/report/route.ts"
      provides: "GET endpoint for micro-credential coverage report data"
      exports: ["GET"]
  key_links:
    - from: "src/app/(dashboard)/credentials/page.tsx"
      to: "/api/credentials"
      via: "fetch GET for credential list data (client component)"
      pattern: "fetch.*api/credentials"
    - from: "src/app/(dashboard)/credentials/page.tsx"
      to: "/api/credentials/[id]/evidence"
      via: "fetch POST with FormData for file upload, and fetch GET for download URL"
      pattern: "fetch.*api/credentials.*evidence"
    - from: "src/app/api/credentials/[id]/evidence/route.ts"
      to: "uploadToR2 and getSignedDownloadUrl"
      via: "R2 file upload and signed URL generation"
      pattern: "uploadToR2|getSignedDownloadUrl"
    - from: "src/app/api/cron/notifications/route.ts"
      to: "prisma.staffMicroCredential"
      via: "query expiring credentials"
      pattern: "staffMicroCredential\\.findMany.*expiryDate"
    - from: "src/app/(admin)/admin/micro-credentials/page.tsx"
      to: "/api/admin/micro-credentials/report"
      via: "fetch GET for coverage report data"
      pattern: "fetch.*api/admin/micro-credentials/report"
---

<objective>
Enable staff to upload and view/download certificate evidence against awarded credentials, add credential expiry notifications to the cron system, and provide RANZ admin with a coverage report across all organisations.

Purpose: This completes the micro-credential feature set. Evidence upload gives staff a place to store their certificate files. Evidence download/viewing ensures uploaded certificates are accessible (not just stored). Expiry notifications ensure credentials don't silently lapse. The coverage report gives RANZ visibility into the programme's adoption and workforce qualification levels across the membership.

Output: Evidence upload + download API, credentials list API, credentials page UI, cron expiry checks, admin coverage report.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-micro-credentials/14-01-SUMMARY.md
@.planning/phases/14-micro-credentials/14-02-SUMMARY.md
@prisma/schema.prisma
@src/types/index.ts
@src/lib/r2.ts
@src/lib/notifications.ts
@src/app/api/cron/notifications/route.ts
@src/app/(dashboard)/credentials/page.tsx
@src/app/(admin)/admin/micro-credentials/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Credentials list API, certificate evidence upload/download API, and credentials page upload UI</name>
  <files>
    src/app/api/credentials/route.ts
    src/app/api/credentials/[id]/evidence/route.ts
    src/app/(dashboard)/credentials/page.tsx
  </files>
  <action>
    1. Create src/app/api/credentials/route.ts:
       - NOTE: Plan 02 created the credentials page as a Server Component with direct Prisma queries. This plan converts that page to "use client", so an API endpoint is now required to serve the data.
       - GET endpoint requiring Clerk auth with orgId
       - Query: Find the organization by clerkOrgId, include members with their microCredentials (including definition), ordered by role then firstName:
         ```typescript
         const organization = await db.organization.findUnique({
           where: { clerkOrgId: orgId },
           include: {
             members: {
               include: {
                 microCredentials: {
                   include: { definition: true },
                   orderBy: { definition: { title: "asc" } },
                 },
               },
               orderBy: [{ role: "asc" }, { firstName: "asc" }],
             },
           },
         });
         ```
       - Return 200 with { members: organization.members } (or 404 if org not found)

    2. Create src/app/api/credentials/[id]/evidence/route.ts with BOTH POST and GET handlers:
       - The [id] param is the StaffMicroCredential ID (NOT the definition ID)

       **POST handler (upload):**
       - Requires Clerk auth with orgId
       - Validate the StaffMicroCredential exists and belongs to a member in the caller's organization:
         ```typescript
         const credential = await db.staffMicroCredential.findUnique({
           where: { id: params.id },
           include: {
             member: { include: { organization: true } },
             definition: true,
           },
         });
         // Verify credential.member.organization.clerkOrgId === caller's orgId
         ```
       - Only allow upload if credential status is AWARDED (return 400 otherwise with message "Can only upload evidence for awarded credentials")
       - Accept multipart/form-data with a single file field "file"
       - Validate file: max 50MB (use MAX_FILE_SIZE_BYTES from @/types), allowed mimeTypes: application/pdf, image/jpeg, image/png, image/webp
       - Upload to R2 using uploadToR2 from @/lib/r2 with key: `credentials/${credential.member.organizationId}/${credential.memberId}/${credential.id}/${Date.now()}-${fileName}`
       - Update StaffMicroCredential record:
         ```
         certificateKey: storageKey (returned from uploadToR2)
         certificateFileName: original file name
         certificateUploadedAt: new Date()
         certificateUploadedBy: userId (from Clerk auth)
         ```
       - Return 200 with { success: true, fileName, storageKey }

       **GET handler (download/view):**
       - Requires Clerk auth with orgId
       - Validate the StaffMicroCredential exists and belongs to a member in the caller's organization (same ownership check as POST)
       - If credential.certificateKey is null, return 404 with { error: "No certificate evidence uploaded for this credential" }
       - Generate a signed download URL using getSignedDownloadUrl from @/lib/r2:
         ```typescript
         import { getSignedDownloadUrl } from "@/lib/r2";
         const signedUrl = await getSignedDownloadUrl(credential.certificateKey);
         ```
       - Return 200 with { url: signedUrl, fileName: credential.certificateFileName }
       - The signed URL is time-limited (default expiry from r2.ts), so it must be generated fresh each time

    3. Update src/app/(dashboard)/credentials/page.tsx to add evidence upload and download capability:
       - Plan 02 created this page as a Server Component with direct Prisma queries. Convert it to "use client" for interactivity. The data volume is small (staff + credentials) and client-side fetching matches the admin page patterns.
       - Refactor: Make page.tsx "use client", fetch org credentials from GET /api/credentials on mount via useEffect.
       - Add to each AWARDED credential item:
         - If no certificate: "Upload Certificate" button (lucide Upload icon). On click, open file picker (hidden input triggered by button click). On file selected, upload via fetch POST with FormData to /api/credentials/{staffCredentialId}/evidence. Show loading spinner during upload. On success, refresh data and show the file name.
         - If certificate exists: Show file name with a CheckCircle icon indicating evidence attached. Make the file name a clickable "View Certificate" link that fetches GET /api/credentials/{staffCredentialId}/evidence to get the signed URL, then opens that URL in a new tab (window.open(url, '_blank')). Also show a "Replace" button to upload a new file (same upload flow, overwrites the record).
       - Maintain all existing UI: summary cards, staff grouping, status badges, empty states from Plan 02.

  </action>
  <verify>
    Run `pnpm typecheck` passes.
    Navigate to /credentials -- page renders with credential list (fetched from API).
    For an AWARDED credential, click "Upload Certificate" -- file picker opens.
    Upload a PDF -- file stored in R2, credential record updated, UI shows file name with check icon.
    Click the file name / "View Certificate" link -- GET /api/credentials/[id]/evidence returns signed URL, certificate opens in new tab.
    Attempt to upload for a non-AWARDED credential -- blocked with appropriate message.
    Upload a replacement certificate -- previous key overwritten in record (R2 file remains, old key replaced).
    GET evidence for a credential with no upload -- returns 404 with appropriate message.
  </verify>
  <done>
    GET /api/credentials endpoint serves org credential data for the client-side page.
    Staff/org admin can upload certificate evidence (PDF, JPEG, PNG, WebP up to 50MB) for AWARDED credentials.
    Staff/org admin can view/download previously uploaded certificate evidence via signed R2 URL (opens in new tab).
    Uploaded certificates stored in R2 under credentials/{orgId}/{memberId}/{credId}/ path.
    Credential record updated with storage key, filename, upload timestamp, and uploader ID.
    UI shows upload button for AWARDED credentials without evidence, clickable file name with download for those with evidence.
    Non-AWARDED credentials cannot have evidence uploaded (400 error).
    Credentials with no evidence return 404 on GET evidence request.
  </done>
</task>

<task type="auto">
  <name>Task 2: Credential expiry notifications cron and admin coverage report</name>
  <files>
    src/app/api/cron/notifications/route.ts
    src/app/api/admin/micro-credentials/report/route.ts
    src/app/(admin)/admin/micro-credentials/page.tsx
  </files>
  <action>
    1. Update src/app/api/cron/notifications/route.ts:
       - Add `credentialExpiries: 0` to the results object
       - Add step 9: `results.credentialExpiries = await checkCredentialExpiries();`
       - Create the checkCredentialExpiries function following the EXACT same pattern as checkProgrammeRenewals (cumulative threshold checks):

       ```typescript
       async function checkCredentialExpiries(): Promise<number> {
         const now = new Date();
         const in90Days = new Date(now.getTime() + 90 * 24 * 60 * 60 * 1000);
         let alertsSent = 0;

         // Get AWARDED credentials with expiry dates within 90 days
         const expiringCredentials = await db.staffMicroCredential.findMany({
           where: {
             status: "AWARDED",
             expiryDate: { lte: in90Days, gt: now },
           },
           include: {
             definition: true,
             member: {
               include: {
                 organization: {
                   select: { id: true, name: true, email: true },
                 },
               },
             },
           },
         });

         for (const credential of expiringCredentials) {
           if (!credential.expiryDate) continue;

           const daysUntilExpiry = Math.ceil(
             (credential.expiryDate.getTime() - now.getTime()) / (24 * 60 * 60 * 1000)
           );

           // Determine which alerts to send (cumulative thresholds)
           const alertsToSend: { days: number; flag: "expiryAlert90Sent" | "expiryAlert60Sent" | "expiryAlert30Sent" }[] = [];

           if (daysUntilExpiry <= 90 && !credential.expiryAlert90Sent) {
             alertsToSend.push({ days: 90, flag: "expiryAlert90Sent" });
           }
           if (daysUntilExpiry <= 60 && !credential.expiryAlert60Sent) {
             alertsToSend.push({ days: 60, flag: "expiryAlert60Sent" });
           }
           if (daysUntilExpiry <= 30 && !credential.expiryAlert30Sent) {
             alertsToSend.push({ days: 30, flag: "expiryAlert30Sent" });
           }

           if (alertsToSend.length === 0) continue;

           const staffName = `${credential.member.firstName} ${credential.member.lastName}`;
           const formattedDate = credential.expiryDate.toLocaleDateString("en-NZ", {
             day: "numeric", month: "long", year: "numeric",
           });

           try {
             await db.$transaction(async (tx) => {
               for (const alert of alertsToSend) {
                 await createNotification({
                   organizationId: credential.member.organizationId,
                   type: "CREDENTIAL_EXPIRY",
                   channel: "EMAIL",
                   priority: daysUntilExpiry <= 30 ? "HIGH" : "NORMAL",
                   title: `Micro-Credential Expiring - ${credential.definition.title}`,
                   message: `${staffName}'s "${credential.definition.title}" credential expires in ${daysUntilExpiry} days (on ${formattedDate}). Please arrange re-assessment or renewal.`,
                   actionUrl: `${process.env.NEXT_PUBLIC_APP_URL}/credentials`,
                   recipient: credential.member.organization.email ?? undefined,
                 });
                 alertsSent++;
               }

               // Set all triggered flags
               const updateData: Record<string, boolean> = {};
               for (const alert of alertsToSend) {
                 updateData[alert.flag] = true;
               }

               await tx.staffMicroCredential.update({
                 where: { id: credential.id },
                 data: updateData,
               });
             });
           } catch (error) {
             console.error(
               `Failed to send credential expiry alert for credential ${credential.id}:`,
               error
             );
           }
         }

         return alertsSent;
       }
       ```

       - Import createNotification from @/lib/notifications if not already imported (it already is).
       - NOTE: Do NOT auto-transition status to EXPIRED. The cron only sends notifications. Status transitions to EXPIRED are handled manually by RANZ admin or could be added as a separate concern later.

    2. Create src/app/api/admin/micro-credentials/report/route.ts:
       - GET endpoint requiring ranz:admin role
       - Query aggregated data: for each organization, count total staff, total credentials assigned, credentials by status, and credential coverage percentage
       - Query approach:
         ```typescript
         const organizations = await db.organization.findMany({
           select: {
             id: true,
             name: true,
             tradingName: true,
             certificationTier: true,
             members: {
               select: {
                 id: true,
                 firstName: true,
                 lastName: true,
                 microCredentials: {
                   select: {
                     id: true,
                     status: true,
                     definition: { select: { title: true } },
                   },
                 },
               },
             },
           },
           orderBy: { name: "asc" },
         });
         ```
       - Transform into report format:
         ```
         {
           summary: {
             totalOrganizations: number,
             totalStaff: number,
             totalCredentialsAssigned: number,
             totalCredentialsAwarded: number,
             overallCoveragePercent: number  // (orgs with at least 1 awarded / total orgs) * 100
           },
           organizations: [
             {
               id, name, tradingName, certificationTier,
               staffCount: number,
               credentialsAssigned: number,
               credentialsAwarded: number,
               credentialsByStatus: { NOT_STARTED: n, IN_TRAINING: n, ASSESSMENT_PENDING: n, AWARDED: n, EXPIRED: n },
               coveragePercent: number  // (staff with at least 1 awarded / total staff) * 100
             }
           ]
         }
         ```
       - Return 200 with the report data

    3. Update src/app/(admin)/admin/micro-credentials/page.tsx:
       - Add a "Coverage Report" tab or section below the definitions table
       - Add a toggle or tab: "Definitions" | "Coverage Report"
       - When "Coverage Report" is active:
         - Fetch from GET /api/admin/micro-credentials/report
         - Show summary cards at top: Total Organisations, Total Staff, Credentials Assigned, Credentials Awarded, Overall Coverage %
         - Show per-organisation table: Org Name, Tier badge, Staff Count, Assigned, Awarded, Coverage %, status breakdown mini-bars or text
         - Sort by coverage % descending (orgs with best coverage first)
         - Use a simple horizontal bar or colored text for status breakdown (e.g., "3 Awarded, 2 In Training, 1 Not Started")
       - Keep the existing definitions list as the default view
       - Use a simple state toggle (useState with "definitions" | "report") and conditional rendering
       - Add lucide-react icons: BarChart3 for report tab

  </action>
  <verify>
    Run `pnpm typecheck` passes with no errors.
    Run `pnpm build` succeeds.
    Test cron endpoint (if possible locally): GET /api/cron/notifications returns credentialExpiries count in response.
    Visit /admin/micro-credentials -- toggle to "Coverage Report" tab -- shows org breakdown.
    Coverage report correctly calculates percentages and counts.
    Evidence upload from Task 1 combined with this plan's cron: a credential with expiryDate within 90 days would trigger notifications.
  </verify>
  <done>
    Cron job checks for expiring credentials at 90/60/30 day thresholds.
    Expiry notifications sent via email with credential title, staff name, and expiry date.
    Alert flags prevent duplicate notifications for the same credential.
    Admin coverage report shows per-organisation credential adoption metrics.
    Report includes summary totals and per-org breakdown with coverage percentages.
    Report accessible via tab toggle on the admin micro-credentials page.
    Build passes with zero errors.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm build` succeeds
3. Staff can upload certificate evidence for AWARDED credentials
4. Staff can view/download certificate evidence via signed R2 URL (opens in new tab)
5. GET /api/credentials serves org credential data for client-side page
6. Cron includes credential expiry checks (verify response includes credentialExpiries field)
7. Admin coverage report renders with organisation-level data
8. Evidence stored in R2 with correct path structure
9. Expiry notification flags prevent duplicate alerts
</verification>

<success_criteria>
- GET /api/credentials endpoint provides org credential data for client-side page
- Staff can upload PDF/image evidence against AWARDED credentials via /credentials page
- Staff can view/download previously uploaded evidence via GET /api/credentials/[id]/evidence (signed R2 URL)
- Certificate files stored in Cloudflare R2 under credentials/ prefix
- Cron job sends expiry notifications at 90, 60, and 30 days before credential expiry
- Notification flags prevent duplicates (same pattern as insurance and programme renewal)
- RANZ admin can view coverage report showing credential adoption across all organisations
- Coverage report includes summary stats and per-org breakdown
- All notification type mappings are complete
- Build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/14-micro-credentials/14-03-SUMMARY.md`
</output>
