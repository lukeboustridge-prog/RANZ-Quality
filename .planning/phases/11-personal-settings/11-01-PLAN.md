---
phase: 11-personal-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/settings/page.tsx
  - src/components/settings/user-profile-section.tsx
autonomous: true

must_haves:
  truths:
    - "User can access settings page regardless of role (admin or staff)"
    - "User can update their name via Clerk UserProfile"
    - "User can update their email via Clerk UserProfile"
    - "User can update their phone number via Clerk UserProfile"
    - "User can upload/change their profile photo via Clerk UserProfile"
    - "Admin users still see organization settings sections"
    - "Staff users only see personal settings sections"
  artifacts:
    - path: "src/components/settings/user-profile-section.tsx"
      provides: "Clerk UserProfile component wrapper"
      min_lines: 20
    - path: "src/app/(dashboard)/settings/page.tsx"
      provides: "Updated settings page with conditional sections"
      contains: "UserProfileSection"
  key_links:
    - from: "src/app/(dashboard)/settings/page.tsx"
      to: "src/components/settings/user-profile-section.tsx"
      via: "import and render"
      pattern: "UserProfileSection"
---

<objective>
Update the settings page to support all authenticated users (not just admins) and embed Clerk's UserProfile component for personal profile management.

Purpose: Enable all users to access their personal settings while preserving admin-only access to organization settings. Clerk's built-in UserProfile component handles profile management (name, email, phone, photo) with battle-tested security and verification flows.

Output: Modified settings page with conditional rendering based on user role, and a new UserProfileSection component wrapping Clerk's UserProfile.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@RANZ Quality Program/.planning/PROJECT.md
@RANZ Quality Program/.planning/ROADMAP.md
@RANZ Quality Program/.planning/STATE.md
@RANZ Quality Program/.planning/phases/11-personal-settings/11-RESEARCH.md

# Existing settings page (current implementation - admin-only access)
@RANZ Quality Program/src/app/(dashboard)/settings/page.tsx

# Existing settings components to understand patterns
@RANZ Quality Program/src/components/settings/organization-profile-form.tsx
@RANZ Quality Program/src/components/settings/notification-settings.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UserProfileSection component</name>
  <files>src/components/settings/user-profile-section.tsx</files>
  <action>
Create a client component that wraps Clerk's UserProfile component with appropriate styling to match the app's design system.

Requirements:
1. Use "use client" directive (Clerk components require client-side rendering)
2. Import UserProfile from '@clerk/nextjs'
3. Apply appearance customization to match app styling:
   - Remove box shadow (use border instead)
   - Match color scheme (blue-600 primary)
   - Set appropriate width/spacing
4. Hide the navbar since we're embedding in a single-purpose section (user can only see account info)

Example structure:
```tsx
"use client";

import { UserProfile } from '@clerk/nextjs';

export function UserProfileSection() {
  return (
    <div className="clerk-user-profile-wrapper">
      <UserProfile
        appearance={{
          elements: {
            rootBox: 'w-full',
            card: 'shadow-none border border-gray-200 rounded-lg',
            navbar: 'hidden',
            pageScrollBox: 'p-0',
          },
          variables: {
            colorPrimary: '#2563eb',
          }
        }}
      />
    </div>
  );
}
```
  </action>
  <verify>
File exists at src/components/settings/user-profile-section.tsx with UserProfile import and appearance customization.
  </verify>
  <done>
UserProfileSection component created with Clerk UserProfile embedded and styled to match app design.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update settings page for role-based conditional rendering</name>
  <files>src/app/(dashboard)/settings/page.tsx</files>
  <action>
Modify the settings page to:

1. REMOVE the redirect for non-admin users - ALL authenticated users should access this page
2. Determine if user is admin (OWNER or ADMIN role) for conditional section rendering
3. Show organization settings (Company Profile, Organization Notifications, Staff Management) ONLY to admins
4. Show personal settings (Personal Profile, Personal Notification Preferences) to ALL users
5. Update page title/description based on user role
6. Import and render the new UserProfileSection component

Key changes:
- Remove: `if (!member || !["OWNER", "ADMIN"].includes(member.role)) { redirect("/dashboard"); }`
- Add: `const isAdmin = member && ["OWNER", "ADMIN"].includes(member.role);`
- Wrap admin-only sections in `{isAdmin && (...)}`
- Add Personal Profile section with UserProfileSection component for all users
- Update page heading: admins see "Organization Settings", staff see "Personal Settings"

Structure:
```tsx
// After getting member role
const isAdmin = member && ["OWNER", "ADMIN"].includes(member.role);

return (
  <div className="container mx-auto py-8 px-4 max-w-4xl">
    <div className="mb-8">
      <h1 className="text-2xl font-bold text-gray-900">
        {isAdmin ? "Organization Settings" : "Personal Settings"}
      </h1>
      <p className="text-gray-600 mt-1">
        {isAdmin
          ? "Manage your company profile, team, and notification preferences"
          : "Manage your personal profile and notification preferences"
        }
      </p>
    </div>

    <div className="space-y-8">
      {/* Admin-only: Company Profile */}
      {isAdmin && (
        <div className="bg-white rounded-lg shadow p-6">
          <h2>Company Profile</h2>
          <OrganizationProfileForm ... />
        </div>
      )}

      {/* Admin-only: Organization Notifications */}
      {isAdmin && (
        <div className="bg-white rounded-lg shadow p-6">
          <h2>Notification Preferences</h2>
          <NotificationSettings />
        </div>
      )}

      {/* Admin-only: Staff Management */}
      {isAdmin && (
        <div className="bg-white rounded-lg shadow p-6">
          <h2>Staff Management</h2>
          ...
        </div>
      )}

      {/* ALL USERS: Personal Profile */}
      <div className="bg-white rounded-lg shadow p-6">
        <h2 className="text-lg font-semibold text-gray-900 mb-6">
          Personal Profile
        </h2>
        <p className="text-sm text-gray-500 mb-4">
          Manage your account details, email, and profile photo
        </p>
        <UserProfileSection />
      </div>
    </div>
  </div>
);
```

Import the new component:
```tsx
import { UserProfileSection } from "@/components/settings/user-profile-section";
```
  </action>
  <verify>
1. Run TypeScript check: `cd "RANZ Quality Program" && npx tsc --noEmit`
2. Start dev server and verify:
   - Admin user sees all sections (Company Profile, Notifications, Staff, Personal Profile)
   - Staff user sees only Personal Profile section
   - Personal Profile section shows Clerk UserProfile component
  </verify>
  <done>
Settings page allows all authenticated users access. Admins see full settings, staff see only personal settings. UserProfileSection component renders Clerk's UserProfile for all users.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. TypeScript compiles without errors
2. Settings page accessible to all authenticated users (admin and staff)
3. Admin users see: Company Profile, Notification Preferences, Staff Management, Personal Profile
4. Staff users see: Only Personal Profile section
5. Personal Profile section displays Clerk UserProfile with name, email, phone, and photo management
6. UserProfile component styled to match app design (no jarring visual differences)
</verification>

<success_criteria>
- User can update their name via Clerk UserProfile
- User can update their email via Clerk UserProfile (with verification)
- User can update their phone number via Clerk UserProfile
- User can upload/change their profile photo via Clerk UserProfile
- Admin users still have access to organization settings
- Staff users are no longer redirected away from settings page
</success_criteria>

<output>
After completion, create `.planning/phases/11-personal-settings/11-01-SUMMARY.md`
</output>
