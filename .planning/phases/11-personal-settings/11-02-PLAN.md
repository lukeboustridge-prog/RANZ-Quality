---
phase: 11-personal-settings
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/settings/personal-notification-settings.tsx
  - src/app/(dashboard)/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can toggle email notifications on/off"
    - "User can opt in/out of specific email notification types (insurance, audit, compliance, newsletter)"
    - "User can toggle SMS notifications on/off"
    - "User can opt in/out of specific SMS notification types (insurance, audit)"
    - "Critical SMS alerts cannot be disabled by user (forced enabled)"
    - "User can enter/update their SMS phone number"
    - "User's notification preferences are saved to database"
    - "Info banner explains relationship between org and personal preferences"
  artifacts:
    - path: "src/components/settings/personal-notification-settings.tsx"
      provides: "Personal notification preferences UI component"
      min_lines: 100
    - path: "src/app/(dashboard)/settings/page.tsx"
      provides: "Settings page with personal notifications section"
      contains: "PersonalNotificationSettings"
  key_links:
    - from: "src/components/settings/personal-notification-settings.tsx"
      to: "/api/notifications/preferences"
      via: "fetch GET and PATCH"
      pattern: "fetch.*api/notifications/preferences"
    - from: "src/app/(dashboard)/settings/page.tsx"
      to: "src/components/settings/personal-notification-settings.tsx"
      via: "import and render"
      pattern: "PersonalNotificationSettings"
---

<objective>
Create a personal notification settings component that allows users to manage their individual notification preferences independent of organization-level settings.

Purpose: Give users control over which notifications they receive. Organization settings determine what CAN be sent; personal settings determine what the user WANTS to receive. This completes the two-tier notification preference system.

Output: PersonalNotificationSettings component using existing /api/notifications/preferences API, integrated into the settings page for all users.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@RANZ Quality Program/.planning/PROJECT.md
@RANZ Quality Program/.planning/ROADMAP.md
@RANZ Quality Program/.planning/STATE.md
@RANZ Quality Program/.planning/phases/11-personal-settings/11-RESEARCH.md

# Existing API (already implemented - use as-is)
@RANZ Quality Program/src/app/api/notifications/preferences/route.ts

# Organization notification settings (pattern to follow)
@RANZ Quality Program/src/components/settings/notification-settings.tsx

# Settings page to integrate with
@RANZ Quality Program/src/app/(dashboard)/settings/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PersonalNotificationSettings component</name>
  <files>src/components/settings/personal-notification-settings.tsx</files>
  <action>
Create a client component for managing user-level notification preferences. Follow the pattern established in notification-settings.tsx but use the personal preferences API.

Requirements:
1. Use "use client" directive
2. Fetch preferences from GET /api/notifications/preferences on mount
3. Update preferences via PATCH /api/notifications/preferences
4. Use optimistic updates with rollback on error
5. Show loading state while fetching
6. Show error state if fetch fails

UI Structure:
- Info banner explaining org vs personal preferences
- Email Notifications section:
  - Master toggle for all email notifications
  - Sub-toggles (visible when email enabled): Insurance, Audit, Compliance, Newsletter
- SMS Notifications section:
  - Master toggle for all SMS notifications
  - Phone number input field (visible when SMS enabled)
  - Sub-toggles: Insurance, Audit
  - Critical alerts toggle (disabled/forced on with explanatory text)
- Success/error message display

Key implementation details:
- Interface matches NotificationPreference model fields:
  ```typescript
  interface NotificationPreferences {
    id: string;
    emailEnabled: boolean;
    emailInsurance: boolean;
    emailAudit: boolean;
    emailCompliance: boolean;
    emailNewsletter: boolean;
    smsEnabled: boolean;
    smsInsurance: boolean;
    smsAudit: boolean;
    smsCritical: boolean;
    smsPhoneNumber: string | null;
  }
  ```
- Toggle component reusable (same as org notification settings)
- Phone number update should debounce or have explicit save button
- Critical alerts toggle should be visually disabled with explanatory text: "Critical alerts cannot be disabled for security reasons"

Follow the exact styling and structure from notification-settings.tsx for visual consistency.
  </action>
  <verify>
1. File exists at src/components/settings/personal-notification-settings.tsx
2. TypeScript compiles: `cd "RANZ Quality Program" && npx tsc --noEmit`
3. Component fetches from /api/notifications/preferences
4. Component PATCHes to /api/notifications/preferences on toggle
  </verify>
  <done>
PersonalNotificationSettings component created with all notification toggles, phone number input, and API integration. Critical alerts toggle is visually disabled.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Personal Notification Settings to settings page</name>
  <files>src/app/(dashboard)/settings/page.tsx</files>
  <action>
Add the PersonalNotificationSettings component to the settings page, visible to ALL users (not just admins).

Steps:
1. Import the new component:
   ```tsx
   import { PersonalNotificationSettings } from "@/components/settings/personal-notification-settings";
   ```

2. Add a new section AFTER the Personal Profile section (from Plan 11-01):
   ```tsx
   {/* ALL USERS: Personal Notification Preferences */}
   <div className="bg-white rounded-lg shadow p-6">
     <h2 className="text-lg font-semibold text-gray-900 mb-6">
       Personal Notification Preferences
     </h2>
     <PersonalNotificationSettings />
   </div>
   ```

3. Ensure this section appears for ALL authenticated users, not just admins (outside of the isAdmin conditional blocks).

The final settings page structure should be:
- [Admin only] Company Profile
- [Admin only] Notification Preferences (org-level)
- [Admin only] Staff Management
- [All users] Personal Profile (UserProfileSection)
- [All users] Personal Notification Preferences (PersonalNotificationSettings)
  </action>
  <verify>
1. TypeScript compiles: `cd "RANZ Quality Program" && npx tsc --noEmit`
2. Settings page imports PersonalNotificationSettings
3. Personal Notification Preferences section visible for all users
  </verify>
  <done>
Settings page updated with Personal Notification Preferences section visible to all authenticated users.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. TypeScript compiles without errors
2. Staff user sees Personal Notification Preferences section on settings page
3. Admin user sees both Organization Notifications AND Personal Notification Preferences sections
4. Toggling preferences calls PATCH /api/notifications/preferences
5. Preferences persist across page refreshes (verify with GET /api/notifications/preferences)
6. Critical alerts toggle is disabled and cannot be turned off
7. Phone number can be entered and saved
8. Info banner is displayed explaining org vs personal preferences
</verification>

<success_criteria>
- User can opt in/out of specific notification types (insurance, audit, compliance, newsletter emails)
- User can toggle SMS notifications on/off
- User can enter SMS phone number
- Critical alerts cannot be disabled (toggle forced on)
- User's notification preferences are respected by the notification system (persisted to database)
- Info banner clarifies relationship between org and user preferences
</success_criteria>

<output>
After completion, create `.planning/phases/11-personal-settings/11-02-SUMMARY.md`
</output>
