---
phase: 03-security-foundations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/env.ts
  - src/lib/cron-auth.ts
  - src/app/api/cron/verify-lbp/route.ts
  - src/app/api/cron/notifications/route.ts
autonomous: true

must_haves:
  truths:
    - "Cron endpoints return 401 if CRON_SECRET header missing or incorrect"
    - "Application startup fails if CRON_SECRET environment variable not set"
    - "Unauthorized cron attempts are logged with IP and path"
  artifacts:
    - path: "src/lib/env.ts"
      provides: "Required CRON_SECRET validation"
      contains: "CRON_SECRET: z.string().min(32"
    - path: "src/lib/cron-auth.ts"
      provides: "Cron authentication utility"
      exports: ["verifyCronRequest"]
    - path: "src/app/api/cron/verify-lbp/route.ts"
      provides: "Secured LBP verification endpoint"
      contains: "verifyCronRequest"
    - path: "src/app/api/cron/notifications/route.ts"
      provides: "Secured notifications endpoint"
      contains: "verifyCronRequest"
  key_links:
    - from: "src/app/api/cron/verify-lbp/route.ts"
      to: "src/lib/cron-auth.ts"
      via: "import verifyCronRequest"
      pattern: "import.*verifyCronRequest.*from.*cron-auth"
    - from: "src/lib/cron-auth.ts"
      to: "src/lib/env.ts"
      via: "import env for CRON_SECRET"
      pattern: "import.*env.*from.*env"
---

<objective>
Secure cron endpoints with strict CRON_SECRET validation that fails fast on misconfiguration.

Purpose: Protect scheduled jobs from unauthorized triggering. Current code has permissive fallback `if (!cronSecret) return true` which allows access if env var missing.
Output: Strict cron authentication with startup validation and 401 responses for unauthorized requests.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-security-foundations/03-RESEARCH.md

@src/lib/env.ts
@src/app/api/cron/verify-lbp/route.ts
@src/app/api/cron/notifications/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make CRON_SECRET required and create cron-auth utility</name>
  <files>src/lib/env.ts, src/lib/cron-auth.ts</files>
  <action>
1. Update src/lib/env.ts:
   - Change CRON_SECRET from `z.string().optional()` to `z.string().min(32, { message: "CRON_SECRET must be at least 32 characters for security" })`
   - This makes CRON_SECRET REQUIRED - app fails to start without it

2. Create src/lib/cron-auth.ts:
   ```typescript
   import { NextRequest, NextResponse } from "next/server";
   import { env } from "./env";

   /**
    * Verifies cron request authentication using CRON_SECRET header.
    * Vercel automatically adds: Authorization: Bearer <CRON_SECRET>
    * Returns 401 response if unauthorized, null if valid.
    */
   export function verifyCronRequest(req: NextRequest): NextResponse | null {
     const authHeader = req.headers.get("authorization");

     // Strict validation - env.CRON_SECRET is guaranteed to exist due to Zod validation
     if (authHeader !== `Bearer ${env.CRON_SECRET}`) {
       console.warn("Unauthorized cron attempt detected", {
         ip: req.headers.get("x-forwarded-for") || "unknown",
         userAgent: req.headers.get("user-agent") || "unknown",
         path: req.nextUrl.pathname,
         timestamp: new Date().toISOString(),
       });

       return NextResponse.json(
         {
           error: "Unauthorized",
           message: "Invalid or missing CRON_SECRET in Authorization header",
         },
         { status: 401 }
       );
     }

     return null; // Valid request - proceed
   }
   ```
  </action>
  <verify>
Run `npx tsc --noEmit` - should pass (may show pre-existing errors but no new errors in env.ts or cron-auth.ts).
Check that cron-auth.ts exports verifyCronRequest function.
  </verify>
  <done>
env.ts requires CRON_SECRET with min 32 chars. cron-auth.ts exports verifyCronRequest() that returns 401 or null.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update cron endpoints to use strict authentication</name>
  <files>src/app/api/cron/verify-lbp/route.ts, src/app/api/cron/notifications/route.ts</files>
  <action>
1. Update src/app/api/cron/verify-lbp/route.ts:
   - Add import: `import { verifyCronRequest } from "@/lib/cron-auth";`
   - In GET handler, replace the existing manual auth check with:
     ```typescript
     // Strict authentication - no permissive fallback
     const authError = verifyCronRequest(req);
     if (authError) return authError;
     ```
   - Remove the old `const authHeader = req.headers.get("authorization")` and `const cronSecret = process.env.CRON_SECRET` code
   - Keep all existing business logic unchanged

2. Update src/app/api/cron/notifications/route.ts:
   - Add import: `import { verifyCronRequest } from "@/lib/cron-auth";`
   - Remove the entire `verifyCronSecret` helper function (lines 11-17)
   - In GET handler, replace `if (!verifyCronSecret(req))` with:
     ```typescript
     const authError = verifyCronRequest(req);
     if (authError) return authError;
     ```
   - Keep all existing business logic unchanged
  </action>
  <verify>
Run `npx tsc --noEmit` - should pass for cron routes.
Grep both files to confirm they import verifyCronRequest from @/lib/cron-auth.
Grep to confirm no `process.env.CRON_SECRET` direct access remains in cron routes.
  </verify>
  <done>
Both cron endpoints use verifyCronRequest() for authentication. No permissive fallback remains. Unauthorized requests return 401.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `npx tsc --noEmit` passes (may show pre-existing errors unrelated to this plan)
2. `grep -r "verifyCronRequest" src/app/api/cron/` shows both routes importing and using the function
3. `grep -r "if (!cronSecret) return true" src/` returns no results (permissive fallback removed)
4. `grep "CRON_SECRET.*optional" src/lib/env.ts` returns no results (CRON_SECRET is now required)
</verification>

<success_criteria>
- CRON_SECRET is required with minimum 32 character validation in env.ts
- verifyCronRequest utility exists in src/lib/cron-auth.ts
- Both /api/cron/verify-lbp and /api/cron/notifications use verifyCronRequest()
- No permissive fallback (`if (!secret) return true`) exists in codebase
- Application would fail to start if CRON_SECRET not set (Zod validation)
</success_criteria>

<output>
After completion, create `.planning/phases/03-security-foundations/03-01-SUMMARY.md`
</output>
