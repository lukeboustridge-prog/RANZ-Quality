---
phase: 03-security-foundations
plan: 03
type: execute
wave: 2
depends_on: ["03-02"]
files_modified:
  - src/app/api/insurance/route.ts
  - src/app/api/insurance/[id]/route.ts
  - src/app/api/documents/[id]/approve/route.ts
  - src/app/api/staff/route.ts
  - src/app/api/staff/[id]/route.ts
  - src/app/api/staff/[id]/verify-lbp/route.ts
autonomous: true

must_haves:
  truths:
    - "Insurance policy creation is logged to AuditLog table"
    - "Insurance policy updates and deletions are logged with before/after state"
    - "Document approval/rejection is logged to AuditLog table"
    - "Staff member create/update/delete is logged to AuditLog table"
    - "LBP verification status changes are logged to AuditLog table"
  artifacts:
    - path: "src/app/api/insurance/route.ts"
      provides: "Insurance POST with audit logging"
      contains: "logInsuranceMutation"
    - path: "src/app/api/insurance/[id]/route.ts"
      provides: "Insurance PUT/DELETE with audit logging"
      contains: "logInsuranceMutation"
    - path: "src/app/api/documents/[id]/approve/route.ts"
      provides: "Document approve with audit logging"
      contains: "logDocumentMutation"
    - path: "src/app/api/staff/route.ts"
      provides: "Staff POST with audit logging"
      contains: "logMemberMutation"
    - path: "src/app/api/staff/[id]/route.ts"
      provides: "Staff PUT/DELETE with audit logging"
      contains: "logMemberMutation"
    - path: "src/app/api/staff/[id]/verify-lbp/route.ts"
      provides: "LBP verify with audit logging"
      contains: "logMemberMutation"
  key_links:
    - from: "src/app/api/insurance/route.ts"
      to: "src/lib/audit-log.ts"
      via: "import logInsuranceMutation"
      pattern: "import.*logInsuranceMutation.*from.*audit-log"
    - from: "src/app/api/staff/route.ts"
      to: "src/lib/audit-log.ts"
      via: "import logMemberMutation"
      pattern: "import.*logMemberMutation.*from.*audit-log"
---

<objective>
Wire audit logging to all document, insurance, and member mutation endpoints.

Purpose: Every data change creates an immutable audit trail entry with before/after state, enabling compliance audits and dispute resolution.
Output: All mutation endpoints log to AuditLog table with proper state capture.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-security-foundations/03-RESEARCH.md
@.planning/phases/03-security-foundations/03-02-SUMMARY.md

@src/lib/audit-log.ts
@src/app/api/insurance/route.ts
@src/app/api/insurance/[id]/route.ts
@src/app/api/documents/[id]/approve/route.ts
@src/app/api/staff/route.ts
@src/app/api/staff/[id]/route.ts
@src/app/api/staff/[id]/verify-lbp/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add audit logging to insurance endpoints</name>
  <files>src/app/api/insurance/route.ts, src/app/api/insurance/[id]/route.ts</files>
  <action>
1. Update src/app/api/insurance/route.ts (POST handler):
   - Add import: `import { logInsuranceMutation } from "@/lib/audit-log";`
   - After successful `db.insurancePolicy.create()`, add:
     ```typescript
     // Log creation to audit trail
     await logInsuranceMutation(
       "CREATE",
       policy.id,
       null, // No previous state for CREATE
       {
         policyType: policy.policyType,
         policyNumber: policy.policyNumber,
         insurer: policy.insurer,
         coverageAmount: policy.coverageAmount.toString(),
         effectiveDate: policy.effectiveDate.toISOString(),
         expiryDate: policy.expiryDate.toISOString(),
       },
       {
         organizationId: organization.id,
         certificateUploaded: !!certificateKey,
       }
     );
     ```

2. Update src/app/api/insurance/[id]/route.ts:
   - Add import: `import { logInsuranceMutation } from "@/lib/audit-log";`

   - In PUT handler, after successful update:
     ```typescript
     // Log update to audit trail with before/after state
     await logInsuranceMutation(
       "UPDATE",
       id,
       {
         policyType: existingPolicy.policyType,
         policyNumber: existingPolicy.policyNumber,
         insurer: existingPolicy.insurer,
         coverageAmount: existingPolicy.coverageAmount.toString(),
         expiryDate: existingPolicy.expiryDate.toISOString(),
       },
       {
         policyType: policy.policyType,
         policyNumber: policy.policyNumber,
         insurer: policy.insurer,
         coverageAmount: policy.coverageAmount.toString(),
         expiryDate: policy.expiryDate.toISOString(),
       },
       { organizationId: organization.id }
     );
     ```

   - In DELETE handler, after successful delete (before return):
     ```typescript
     // Log deletion to audit trail
     await logInsuranceMutation(
       "DELETE",
       id,
       {
         policyType: policy.policyType,
         policyNumber: policy.policyNumber,
         insurer: policy.insurer,
         coverageAmount: policy.coverageAmount.toString(),
         expiryDate: policy.expiryDate.toISOString(),
       },
       null, // No new state after deletion
       { organizationId: organization.id }
     );
     ```
  </action>
  <verify>
Run `npx tsc --noEmit` - insurance routes should compile.
Grep for logInsuranceMutation in both files to confirm presence.
  </verify>
  <done>
Insurance POST, PUT, DELETE all log to AuditLog with proper before/after state capture.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add audit logging to document and staff endpoints</name>
  <files>src/app/api/documents/[id]/approve/route.ts, src/app/api/staff/route.ts, src/app/api/staff/[id]/route.ts, src/app/api/staff/[id]/verify-lbp/route.ts</files>
  <action>
1. Update src/app/api/documents/[id]/approve/route.ts:
   - Add import: `import { logDocumentMutation } from "@/lib/audit-log";`

   - In PUT handler, after `await approveVersion()` call (action === "approve"):
     ```typescript
     // Log approval to audit trail
     await logDocumentMutation(
       "APPROVE",
       documentId,
       { status: "PENDING_APPROVAL" },
       { status: "APPROVED" },
       { organizationId: document.organizationId, versionId: targetVersionId }
     );
     ```

   - After `await rejectVersion()` call (action === "reject"):
     ```typescript
     // Log rejection to audit trail
     await logDocumentMutation(
       "REJECT",
       documentId,
       { status: "PENDING_APPROVAL" },
       { status: "REJECTED", rejectionReason: reason },
       { organizationId: document.organizationId, versionId: targetVersionId }
     );
     ```

2. Update src/app/api/staff/route.ts (POST handler):
   - Add import: `import { logMemberMutation } from "@/lib/audit-log";`
   - After `db.organizationMember.create()`:
     ```typescript
     // Log creation to audit trail
     await logMemberMutation(
       "CREATE",
       member.id,
       null,
       {
         firstName: member.firstName,
         lastName: member.lastName,
         email: member.email,
         role: member.role,
         lbpNumber: member.lbpNumber,
       },
       { organizationId: organization.id }
     );
     ```

3. Update src/app/api/staff/[id]/route.ts:
   - Add import: `import { logMemberMutation } from "@/lib/audit-log";`

   - In PUT handler, after successful update:
     ```typescript
     // Log update to audit trail
     await logMemberMutation(
       "UPDATE",
       id,
       {
         firstName: existingMember.firstName,
         lastName: existingMember.lastName,
         email: existingMember.email,
         role: existingMember.role,
         lbpNumber: existingMember.lbpNumber,
       },
       {
         firstName: member.firstName,
         lastName: member.lastName,
         email: member.email,
         role: member.role,
         lbpNumber: member.lbpNumber,
       },
       { organizationId: organization.id }
     );
     ```

   - In DELETE handler, after successful delete:
     ```typescript
     // Log deletion to audit trail
     await logMemberMutation(
       "DELETE",
       id,
       {
         firstName: member.firstName,
         lastName: member.lastName,
         email: member.email,
         role: member.role,
       },
       null,
       { organizationId: organization.id }
     );
     ```

4. Update src/app/api/staff/[id]/verify-lbp/route.ts:
   - Add import: `import { logMemberMutation } from "@/lib/audit-log";`
   - After verification completes (before return):
     ```typescript
     // Log LBP verification to audit trail
     await logMemberMutation(
       "VERIFY",
       memberId,
       {
         lbpVerified: member.lbpVerified,
         lbpStatus: member.lbpStatus,
         lbpLastChecked: member.lbpLastChecked?.toISOString(),
       },
       {
         lbpVerified: updatedMember?.lbpVerified,
         lbpStatus: updatedMember?.lbpStatus,
         lbpLastChecked: updatedMember?.lbpLastChecked?.toISOString(),
       },
       { organizationId: member.organizationId, lbpVerification: true }
     );
     ```
  </action>
  <verify>
Run `npx tsc --noEmit` - all routes should compile.
Grep for logDocumentMutation in approve route.
Grep for logMemberMutation in staff routes.
  </verify>
  <done>
Document approve/reject and staff create/update/delete/verify all log to AuditLog.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `npx tsc --noEmit` passes for all modified routes
2. `grep -r "logInsuranceMutation" src/app/api/insurance/` shows 3 usages (POST, PUT, DELETE)
3. `grep -r "logDocumentMutation" src/app/api/documents/` shows 2 usages (APPROVE, REJECT)
4. `grep -r "logMemberMutation" src/app/api/staff/` shows 5 usages (POST, PUT, DELETE, VERIFY)
</verification>

<success_criteria>
- All insurance mutations (POST, PUT, DELETE) log to AuditLog
- Document approval and rejection log to AuditLog
- All staff mutations (POST, PUT, DELETE) log to AuditLog
- LBP verification status changes log to AuditLog
- All audit logs capture appropriate before/after state
- No TypeScript errors in modified routes
</success_criteria>

<output>
After completion, create `.planning/phases/03-security-foundations/03-03-SUMMARY.md`
</output>
