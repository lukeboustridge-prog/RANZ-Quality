---
phase: 07-admin-reporting
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/compliance-v2.ts
  - src/app/api/admin/reports/members/export/route.ts
autonomous: true

must_haves:
  truths:
    - "CSV export includes NZBN column for all members"
    - "CSV export includes four dimension scores (doc, ins, pers, audit)"
    - "CSV export completes in under 5 seconds for 250 members"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Dimension score columns on Organization"
      contains: "complianceDocScore"
    - path: "src/app/api/admin/reports/members/export/route.ts"
      provides: "Server-side CSV export endpoint"
      exports: ["GET"]
  key_links:
    - from: "src/app/api/admin/reports/members/export/route.ts"
      to: "prisma.organization"
      via: "database query"
      pattern: "db\\.organization\\.findMany"
    - from: "src/lib/compliance-v2.ts"
      to: "prisma.organization"
      via: "updateOrganizationComplianceScore"
      pattern: "db\\.organization\\.update"
---

<objective>
Enhance CSV export to include dimension scores and NZBN for external consumption by insurers and partners.

Purpose: Insurers and partners need comprehensive member data including individual dimension scores and NZBN for underwriting and verification purposes. Current client-side CSV lacks these fields.

Output: Server-side CSV export endpoint returning all required columns with cached dimension scores for fast bulk export.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-admin-reporting/07-RESEARCH.md
@prisma/schema.prisma
@src/lib/compliance-v2.ts
@src/app/(admin)/admin/members/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dimension score columns to Organization schema</name>
  <files>
    prisma/schema.prisma
    src/lib/compliance-v2.ts
  </files>
  <action>
1. Update `prisma/schema.prisma` Organization model. Add after `complianceScore`:
   ```prisma
   // Cached dimension scores for fast bulk queries
   complianceDocScore    Float   @default(0)  // Documentation dimension (50% weight)
   complianceInsScore    Float   @default(0)  // Insurance dimension (25% weight)
   compliancePersScore   Float   @default(0)  // Personnel dimension (15% weight)
   complianceAuditScore  Float   @default(0)  // Audit dimension (10% weight)
   complianceLastCalc    DateTime?            // Last compliance calculation timestamp
   ```

2. Run migration:
   ```
   pnpm prisma migrate dev --name add_dimension_scores
   ```

3. Update `updateOrganizationComplianceScore` in `src/lib/compliance-v2.ts` to store all dimension scores:
   ```typescript
   export async function updateOrganizationComplianceScore(
     organizationId: string
   ): Promise<ComplianceResult> {
     const result = await calculateComplianceScore(organizationId);

     await db.organization.update({
       where: { id: organizationId },
       data: {
         complianceScore: result.overallScore,
         complianceDocScore: result.breakdown.documentation.score,
         complianceInsScore: result.breakdown.insurance.score,
         compliancePersScore: result.breakdown.personnel.score,
         complianceAuditScore: result.breakdown.audit.score,
         complianceLastCalc: new Date(),
       },
     });

     return result;
   }
   ```

4. Create backfill script inline at end of migration or as standalone utility.
   For now, leave backfill as TODO comment - existing orgs will get populated on next compliance update.
  </action>
  <verify>
Schema updated: `grep "complianceDocScore" prisma/schema.prisma` returns the field.
Migration applied: Check for new migration file in `prisma/migrations/`.
Prisma client regenerated: `pnpm prisma generate` completes without errors.
TypeScript: `pnpm tsc --noEmit` passes.
  </verify>
  <done>
Organization model has 4 dimension score columns and complianceLastCalc timestamp. updateOrganizationComplianceScore stores all scores.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create server-side CSV export endpoint</name>
  <files>
    src/app/api/admin/reports/members/export/route.ts
  </files>
  <action>
1. Create `src/app/api/admin/reports/members/export/route.ts`

2. Implement GET handler with optional tier filter:
   ```typescript
   import { NextRequest, NextResponse } from "next/server";
   import { auth } from "@clerk/nextjs/server";
   import { db } from "@/lib/db";
   import { format } from "date-fns";
   ```

3. Authorization check (copy pattern from existing admin routes):
   ```typescript
   async function isRanzStaff(): Promise<boolean> {
     const { sessionClaims } = await auth();
     const orgRole = sessionClaims?.org_role as string | undefined;
     return orgRole === "ranz:admin" || orgRole === "ranz:auditor";
   }
   ```

4. Parse optional query params:
   ```typescript
   const { searchParams } = new URL(req.url);
   const tier = searchParams.get("tier") as CertificationTier | null;
   ```

5. Query all organizations with dimension scores:
   ```typescript
   const where = tier ? { certificationTier: tier } : {};

   const organizations = await db.organization.findMany({
     where,
     select: {
       id: true,
       name: true,
       tradingName: true,
       nzbn: true,
       email: true,
       phone: true,
       city: true,
       certificationTier: true,
       complianceScore: true,
       complianceDocScore: true,
       complianceInsScore: true,
       compliancePersScore: true,
       complianceAuditScore: true,
       certifiedSince: true,
       lastAuditDate: true,
       _count: { select: { members: true } },
       insurancePolicies: {
         where: { expiryDate: { gt: new Date() } },
         select: { id: true },
       },
     },
     orderBy: [{ certificationTier: "desc" }, { name: "asc" }],
   });
   ```

6. Build CSV with headers:
   ```typescript
   const headers = [
     "name",
     "tradingName",
     "nzbn",
     "tier",
     "complianceScore",
     "docScore",
     "insScore",
     "persScore",
     "auditScore",
     "lastAuditDate",
     "insuranceStatus",
     "memberCount",
     "city",
     "email",
     "phone",
     "certifiedSince",
   ];
   ```

7. Map organizations to CSV rows (escape commas and quotes properly):
   ```typescript
   function escapeCSV(value: string | null | undefined): string {
     if (value === null || value === undefined) return "";
     const str = String(value);
     if (str.includes(",") || str.includes('"') || str.includes("\n")) {
       return `"${str.replace(/"/g, '""')}"`;
     }
     return str;
   }

   const rows = organizations.map((org) => [
     escapeCSV(org.name),
     escapeCSV(org.tradingName),
     escapeCSV(org.nzbn),
     org.certificationTier,
     org.complianceScore,
     org.complianceDocScore,
     org.complianceInsScore,
     org.compliancePersScore,
     org.complianceAuditScore,
     org.lastAuditDate ? format(org.lastAuditDate, "yyyy-MM-dd") : "",
     org.insurancePolicies.length > 0 ? "CURRENT" : "EXPIRED",
     org._count.members,
     escapeCSV(org.city),
     escapeCSV(org.email),
     escapeCSV(org.phone),
     org.certifiedSince ? format(org.certifiedSince, "yyyy-MM-dd") : "",
   ].join(","));
   ```

8. Return CSV response:
   ```typescript
   const csv = [headers.join(","), ...rows].join("\n");
   const filename = `ranz-members-${format(new Date(), "yyyy-MM-dd")}.csv`;

   return new Response(csv, {
     headers: {
       "Content-Type": "text/csv; charset=utf-8",
       "Content-Disposition": `attachment; filename="${filename}"`,
       "Cache-Control": "no-store",
     },
   });
   ```

9. Add audit logging:
   ```typescript
   await createAuditLog({
     action: "EXPORT",
     resourceType: "MemberDirectory",
     resourceId: "all",
     metadata: { format: "CSV", tier: tier || "all", count: organizations.length },
   });
   ```
  </action>
  <verify>
API exists: `ls src/app/api/admin/reports/members/export/route.ts` shows the file.
TypeScript: `pnpm tsc --noEmit` passes.
Build: `pnpm build` completes without errors.
  </verify>
  <done>
GET /api/admin/reports/members/export endpoint returns CSV with all required columns including NZBN and dimension scores. Supports optional tier filter.
  </done>
</task>

</tasks>

<verification>
1. Schema check: `grep -c "complianceDocScore\|complianceInsScore\|compliancePersScore\|complianceAuditScore" prisma/schema.prisma` returns 4
2. Migration exists: `ls prisma/migrations/*add_dimension_scores*` shows migration folder
3. API exists: File at `src/app/api/admin/reports/members/export/route.ts`
4. Build passes: `pnpm build` completes without errors
5. Type check: `pnpm tsc --noEmit` passes
</verification>

<success_criteria>
- Organization model has complianceDocScore, complianceInsScore, compliancePersScore, complianceAuditScore columns
- updateOrganizationComplianceScore stores all dimension scores in database
- CSV export endpoint at /api/admin/reports/members/export functional
- CSV includes all 16 columns: name, tradingName, nzbn, tier, complianceScore, docScore, insScore, persScore, auditScore, lastAuditDate, insuranceStatus, memberCount, city, email, phone, certifiedSince
- CSV values properly escaped (commas, quotes)
- Endpoint requires RANZ admin authorization
</success_criteria>

<output>
After completion, create `.planning/phases/07-admin-reporting/07-02-SUMMARY.md`
</output>
