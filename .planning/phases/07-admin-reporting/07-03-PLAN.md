---
phase: 07-admin-reporting
plan: 03
type: execute
wave: 2
depends_on: ["07-02"]
files_modified:
  - src/app/api/admin/compliance/[orgId]/route.ts
  - src/components/admin/compliance-breakdown-modal.tsx
  - src/app/(admin)/admin/members/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can click a member row to see compliance drill-down"
    - "Drill-down shows four dimension scores with visual breakdown"
    - "Generate PDF button in drill-down triggers report download"
  artifacts:
    - path: "src/app/api/admin/compliance/[orgId]/route.ts"
      provides: "Compliance drill-down API endpoint"
      exports: ["GET"]
    - path: "src/components/admin/compliance-breakdown-modal.tsx"
      provides: "Modal showing compliance dimension breakdown"
      exports: ["ComplianceBreakdownModal"]
  key_links:
    - from: "src/components/admin/compliance-breakdown-modal.tsx"
      to: "/api/admin/compliance/:orgId"
      via: "fetch on modal open"
      pattern: "fetch.*api/admin/compliance"
    - from: "src/components/admin/compliance-breakdown-modal.tsx"
      to: "/api/admin/reports/organization/:orgId"
      via: "PDF download button"
      pattern: "api/admin/reports/organization"
    - from: "src/app/(admin)/admin/members/page.tsx"
      to: "ComplianceBreakdownModal"
      via: "modal state and trigger"
      pattern: "ComplianceBreakdownModal"
---

<objective>
Create admin dashboard drill-down UI for compliance breakdown visualization.

Purpose: RANZ admins need to quickly inspect individual member compliance details without generating a full PDF report. The drill-down modal provides instant insight into which dimensions need attention.

Output: Clickable member rows that open a modal showing four-dimension breakdown with scores, issues summary, and PDF generation button.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-admin-reporting/07-RESEARCH.md
@src/app/(admin)/admin/members/page.tsx
@src/components/dashboard/dimension-indicators.tsx
@src/lib/compliance-v2.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create compliance drill-down API endpoint</name>
  <files>
    src/app/api/admin/compliance/[orgId]/route.ts
  </files>
  <action>
1. Create `src/app/api/admin/compliance/[orgId]/route.ts`

2. Implement GET handler:
   ```typescript
   import { NextRequest, NextResponse } from "next/server";
   import { auth } from "@clerk/nextjs/server";
   import { db } from "@/lib/db";
   import { calculateComplianceScore, type ComplianceResult } from "@/lib/compliance-v2";
   ```

3. Authorization check (copy isRanzStaff pattern):
   ```typescript
   async function isRanzStaff(): Promise<boolean> {
     const { sessionClaims } = await auth();
     const orgRole = sessionClaims?.org_role as string | undefined;
     return orgRole === "ranz:admin" || orgRole === "ranz:auditor";
   }
   ```

4. Extract orgId from params:
   ```typescript
   export async function GET(
     req: NextRequest,
     { params }: { params: Promise<{ orgId: string }> }
   ) {
     const { orgId } = await params;
   ```

5. Validate organization exists:
   ```typescript
   const organization = await db.organization.findUnique({
     where: { id: orgId },
     select: {
       id: true,
       name: true,
       tradingName: true,
       certificationTier: true,
       complianceScore: true,
       lastAuditDate: true,
       nextAuditDue: true,
     },
   });

   if (!organization) {
     return NextResponse.json({ error: "Organization not found" }, { status: 404 });
   }
   ```

6. Calculate full compliance breakdown:
   ```typescript
   const complianceResult = await calculateComplianceScore(orgId);
   ```

7. Return structured response matching frontend needs:
   ```typescript
   return NextResponse.json({
     organizationId: organization.id,
     organizationName: organization.name,
     tradingName: organization.tradingName,
     tier: organization.certificationTier,
     overallScore: complianceResult.overallScore,
     breakdown: {
       documentation: {
         score: complianceResult.breakdown.documentation.score,
         weight: complianceResult.breakdown.documentation.weight,
         completeElements: complianceResult.breakdown.documentation.elements.filter(e => e.hasApprovedDoc).length,
         totalElements: complianceResult.breakdown.documentation.elements.length,
       },
       insurance: {
         score: complianceResult.breakdown.insurance.score,
         weight: complianceResult.breakdown.insurance.weight,
         validPolicies: complianceResult.breakdown.insurance.policies.filter(p => p.isValid).length,
         requiredPolicies: complianceResult.breakdown.insurance.policies.filter(p => p.required).length,
       },
       personnel: {
         score: complianceResult.breakdown.personnel.score,
         weight: complianceResult.breakdown.personnel.weight,
         ...complianceResult.breakdown.personnel.details,
       },
       audit: {
         score: complianceResult.breakdown.audit.score,
         weight: complianceResult.breakdown.audit.weight,
         ...complianceResult.breakdown.audit.details,
       },
     },
     issues: complianceResult.issues.map(issue => ({
       category: issue.category,
       severity: issue.severity,
       message: issue.message,
       actionRequired: issue.actionRequired || null,
     })),
     tierEligibility: complianceResult.tierEligibility,
     lastAuditDate: organization.lastAuditDate?.toISOString() || null,
     nextAuditDue: organization.nextAuditDue?.toISOString() || null,
   });
   ```

8. Wrap in try-catch, return 500 on error.
  </action>
  <verify>
API exists: `ls src/app/api/admin/compliance/*/route.ts` shows the file.
TypeScript: `pnpm tsc --noEmit` passes.
  </verify>
  <done>
GET /api/admin/compliance/:orgId returns full compliance breakdown with dimension scores, issues, and tier eligibility.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ComplianceBreakdownModal component</name>
  <files>
    src/components/admin/compliance-breakdown-modal.tsx
  </files>
  <action>
1. Create `src/components/admin/compliance-breakdown-modal.tsx`

2. Define props interface:
   ```typescript
   interface ComplianceBreakdownModalProps {
     orgId: string | null;  // null = closed
     onClose: () => void;
   }
   ```

3. Define API response type (matches endpoint):
   ```typescript
   interface ComplianceDrillDown {
     organizationId: string;
     organizationName: string;
     tradingName: string | null;
     tier: string;
     overallScore: number;
     breakdown: {
       documentation: { score: number; weight: number; completeElements: number; totalElements: number };
       insurance: { score: number; weight: number; validPolicies: number; requiredPolicies: number };
       personnel: { score: number; weight: number; totalMembers: number; lbpVerifiedCount: number };
       audit: { score: number; weight: number; lastAuditDate: string | null; daysSinceLastAudit: number | null };
     };
     issues: Array<{ category: string; severity: string; message: string; actionRequired: string | null }>;
     tierEligibility: { currentTier: string; eligibleForUpgrade: boolean; nextTier: string | null; blockers: string[] };
   }
   ```

4. Implement component with:
   - useState for data and loading state
   - useEffect to fetch when orgId changes (only if not null)
   - Dialog/Modal UI using shadcn Dialog component:
     ```typescript
     import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from "@/components/ui/dialog";
     import { Button } from "@/components/ui/button";
     import { Badge } from "@/components/ui/badge";
     import { Download, X, AlertCircle, AlertTriangle, Info, CheckCircle } from "lucide-react";
     ```

5. Modal content structure:
   - **Header**: Organization name, tier badge, overall score with status indicator
   - **Dimension Grid**: 2x2 grid showing 4 dimensions with:
     - Label and weight percentage
     - Score with color coding (green/yellow/red)
     - Progress bar visualization
     - Brief detail text (e.g., "18/19 elements", "4/5 LBP verified")
   - **Issues Section** (if any): List with severity icons:
     - critical: red AlertCircle
     - warning: yellow AlertTriangle
     - info: blue Info
   - **Actions**: "Generate PDF Report" button, "Close" button

6. PDF download handler:
   ```typescript
   const handleDownloadPDF = async () => {
     if (!orgId) return;
     setDownloading(true);
     try {
       const response = await fetch(`/api/admin/reports/organization/${orgId}`);
       if (!response.ok) throw new Error("Failed to generate PDF");
       const blob = await response.blob();
       const url = URL.createObjectURL(blob);
       const a = document.createElement("a");
       a.href = url;
       a.download = `compliance-report-${data?.organizationName.toLowerCase().replace(/\s+/g, '-')}.pdf`;
       a.click();
       URL.revokeObjectURL(url);
     } catch (error) {
       console.error("PDF download failed:", error);
     } finally {
       setDownloading(false);
     }
   };
   ```

7. Loading state: Show skeleton/spinner while fetching data

8. Export the component as named export.
  </action>
  <verify>
Component exists: `ls src/components/admin/compliance-breakdown-modal.tsx` shows the file.
TypeScript: `pnpm tsc --noEmit` passes.
Imports resolve: No unresolved import errors.
  </verify>
  <done>
ComplianceBreakdownModal component shows dimension breakdown, issues list, and has working PDF download button.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire modal to admin members page</name>
  <files>
    src/app/(admin)/admin/members/page.tsx
  </files>
  <action>
1. Import the new modal:
   ```typescript
   import { ComplianceBreakdownModal } from "@/components/admin/compliance-breakdown-modal";
   ```

2. Add state for selected organization:
   ```typescript
   const [selectedOrgId, setSelectedOrgId] = useState<string | null>(null);
   ```

3. Make table rows clickable (add onClick to tr):
   ```typescript
   <tr
     key={org.id}
     className="hover:bg-slate-50 cursor-pointer"
     onClick={() => setSelectedOrgId(org.id)}
   >
   ```

4. Keep the existing "View" button but also allow clicking the row.
   Modify the Actions cell to prevent event bubbling:
   ```typescript
   <td className="py-3 px-4 text-right" onClick={(e) => e.stopPropagation()}>
     <Link href={`/admin/members/${org.id}`}>
       <Button variant="ghost" size="sm">
         <ExternalLink className="h-4 w-4" />
       </Button>
     </Link>
   </td>
   ```

5. Add modal at the end of the component (before closing div):
   ```typescript
   <ComplianceBreakdownModal
     orgId={selectedOrgId}
     onClose={() => setSelectedOrgId(null)}
   />
   ```

6. Add visual cue that rows are clickable - the cursor-pointer and hover:bg-slate-50 already handle this.
  </action>
  <verify>
Import added: `grep "ComplianceBreakdownModal" src/app/\\(admin\\)/admin/members/page.tsx` returns import line.
State added: `grep "selectedOrgId" src/app/\\(admin\\)/admin/members/page.tsx` returns state declaration.
Build passes: `pnpm build` completes without errors.
  </verify>
  <done>
Clicking a member row in admin members page opens ComplianceBreakdownModal showing full compliance drill-down with PDF generation button.
  </done>
</task>

</tasks>

<verification>
1. API endpoint: `ls src/app/api/admin/compliance/*/route.ts` shows file
2. Modal component: `ls src/components/admin/compliance-breakdown-modal.tsx` shows file
3. Integration: `grep "ComplianceBreakdownModal" src/app/\\(admin\\)/admin/members/page.tsx` shows import
4. Build passes: `pnpm build` completes without errors
5. Type check: `pnpm tsc --noEmit` passes
</verification>

<success_criteria>
- GET /api/admin/compliance/:orgId endpoint returns dimension breakdown
- ComplianceBreakdownModal displays 4 dimensions with scores and details
- Modal shows issues list with severity indicators
- "Generate PDF Report" button downloads PDF from /api/admin/reports/organization/:orgId
- Admin members page: clicking row opens modal
- Modal loads data within 500ms (lazy fetch on open)
- Modal can be closed via X button or onClose callback
</success_criteria>

<output>
After completion, create `.planning/phases/07-admin-reporting/07-03-SUMMARY.md`
</output>
