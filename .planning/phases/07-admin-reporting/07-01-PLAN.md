---
phase: 07-admin-reporting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/components/reports/pdf/compliance-report.tsx
  - src/app/api/admin/reports/organization/[orgId]/route.ts
autonomous: true

must_haves:
  truths:
    - "Admin can request PDF report for a single organization"
    - "PDF includes RANZ branding, organization name, and generation date"
    - "PDF shows four-dimension compliance breakdown with scores"
  artifacts:
    - path: "src/components/reports/pdf/compliance-report.tsx"
      provides: "React-PDF template for compliance reports"
      exports: ["ComplianceReportPDF"]
    - path: "src/app/api/admin/reports/organization/[orgId]/route.ts"
      provides: "Single-org PDF generation endpoint"
      exports: ["GET"]
  key_links:
    - from: "src/app/api/admin/reports/organization/[orgId]/route.ts"
      to: "compliance-v2.ts"
      via: "calculateComplianceScore import"
      pattern: "calculateComplianceScore"
    - from: "src/app/api/admin/reports/organization/[orgId]/route.ts"
      to: "ComplianceReportPDF"
      via: "renderToBuffer import"
      pattern: "@react-pdf/renderer"
---

<objective>
Implement PDF generation infrastructure for single-organization compliance reports.

Purpose: RANZ admins need to generate branded PDF compliance reports for individual member organizations to share with members, auditors, and insurers.

Output: Working PDF endpoint at `/api/admin/reports/organization/:orgId` that returns downloadable PDF with RANZ branding and compliance breakdown.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-admin-reporting/07-RESEARCH.md
@src/lib/compliance-v2.ts
@src/app/api/admin/reports/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-pdf and create PDF template components</name>
  <files>
    package.json
    src/components/reports/pdf/compliance-report.tsx
  </files>
  <action>
1. Install @react-pdf/renderer:
   ```
   pnpm add @react-pdf/renderer
   ```

2. Create `src/components/reports/pdf/compliance-report.tsx` with:
   - Register default fonts (Helvetica is built-in, no registration needed)
   - Create styled components using @react-pdf/renderer StyleSheet:
     - `styles.page`: A4 portrait, padding 40pt
     - `styles.header`: flex row, justify-between, border-bottom
     - `styles.logo`: RANZ text placeholder (actual logo is future enhancement)
     - `styles.title`: 24pt bold
     - `styles.section`: marginTop 20pt
     - `styles.sectionTitle`: 14pt bold, marginBottom 8pt
     - `styles.row`: flex row, borderBottom 1pt
     - `styles.cell`: flex 1, padding 4pt
     - `styles.scoreBar`: height 8pt, backgroundColor gray
     - `styles.scoreFill`: height 8pt, positioned absolute
     - `styles.footer`: position absolute, bottom 30pt, fontSize 8pt

3. Export `ComplianceReportPDF` component accepting props:
   ```typescript
   interface ComplianceReportPDFProps {
     organization: {
       name: string;
       tradingName: string | null;
       nzbn: string | null;
       certificationTier: string;
     };
     complianceResult: ComplianceResult; // from compliance-v2.ts
     generatedAt: Date;
     reportId: string;
   }
   ```

4. PDF structure (sections):
   - **Header**: "RANZ" text (bold), "Compliance Report" title, generation date
   - **Organization Info**: Name, trading name (if exists), NZBN, tier badge text
   - **Overall Score**: Large number display with status text (Compliant/At Risk/Critical)
   - **Dimension Breakdown**: 4 rows showing Documentation (50%), Insurance (25%), Personnel (15%), Audit (10%) with score bars
   - **Issues Summary**: Table with severity icon, message, action required (if exists)
   - **Footer**: "Roofing Association of New Zealand", report ID, timestamp, validity disclaimer

5. Color coding for scores:
   - 90%+: green (#22c55e)
   - 70-89%: yellow (#eab308)
   - <70%: red (#ef4444)

Important: @react-pdf/renderer uses its own primitives (Document, Page, View, Text, StyleSheet). Do NOT use HTML elements or standard React components.
  </action>
  <verify>
TypeScript compilation: `pnpm tsc --noEmit` passes without errors in the new file.
Import check: `grep -l "@react-pdf/renderer" src/components/reports/pdf/compliance-report.tsx` returns the file.
  </verify>
  <done>
ComplianceReportPDF component exists and exports correctly. Package.json includes @react-pdf/renderer dependency.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create single-organization PDF endpoint</name>
  <files>
    src/app/api/admin/reports/organization/[orgId]/route.ts
  </files>
  <action>
1. Create the directory and route file `src/app/api/admin/reports/organization/[orgId]/route.ts`

2. Implement GET handler:
   ```typescript
   import { NextRequest, NextResponse } from "next/server";
   import { auth } from "@clerk/nextjs/server";
   import { db } from "@/lib/db";
   import { calculateComplianceScore } from "@/lib/compliance-v2";
   import { renderToBuffer } from "@react-pdf/renderer";
   import { ComplianceReportPDF } from "@/components/reports/pdf/compliance-report";
   import { randomUUID } from "crypto";
   ```

3. Authorization check (copy pattern from existing `/api/admin/reports/route.ts`):
   - Check `isRanzStaff()` - return 403 if false
   - Require valid userId - return 401 if missing

4. Validate orgId parameter exists (return 400 if missing)

5. Fetch organization with required fields:
   ```typescript
   const organization = await db.organization.findUnique({
     where: { id: orgId },
     select: {
       id: true,
       name: true,
       tradingName: true,
       nzbn: true,
       certificationTier: true,
     },
   });
   ```
   Return 404 if not found.

6. Calculate compliance using canonical engine:
   ```typescript
   const complianceResult = await calculateComplianceScore(orgId);
   ```

7. Generate PDF:
   ```typescript
   const reportId = `RPT-${new Date().getFullYear()}-${randomUUID().slice(0, 8).toUpperCase()}`;
   const pdfBuffer = await renderToBuffer(
     ComplianceReportPDF({
       organization,
       complianceResult,
       generatedAt: new Date(),
       reportId,
     })
   );
   ```

8. Return PDF response with proper headers:
   ```typescript
   const filename = `compliance-report-${organization.name.toLowerCase().replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
   return new Response(pdfBuffer, {
     headers: {
       'Content-Type': 'application/pdf',
       'Content-Disposition': `attachment; filename="${filename}"`,
       'Cache-Control': 'no-store',
     },
   });
   ```

9. Wrap in try-catch, log errors, return 500 on failure.

10. Add audit logging for PDF generation (use createAuditLog with action: "EXPORT"):
    ```typescript
    await createAuditLog({
      action: "EXPORT",
      resourceType: "ComplianceReport",
      resourceId: orgId,
      metadata: { format: "PDF", reportId },
    });
    ```
  </action>
  <verify>
API exists: `ls src/app/api/admin/reports/organization/*/route.ts` shows the file.
TypeScript: `pnpm tsc --noEmit` passes.
Dev server: Start with `pnpm dev`, verify no runtime errors in console.
  </verify>
  <done>
GET /api/admin/reports/organization/:orgId endpoint exists, returns PDF with correct Content-Type header, requires RANZ admin auth.
  </done>
</task>

</tasks>

<verification>
1. Build check: `pnpm build` completes without errors
2. Type check: `pnpm tsc --noEmit` passes
3. Dependency installed: `grep "@react-pdf/renderer" package.json` shows the package
4. API route exists: File at `src/app/api/admin/reports/organization/[orgId]/route.ts`
5. Component exists: File at `src/components/reports/pdf/compliance-report.tsx`
</verification>

<success_criteria>
- @react-pdf/renderer installed and in package.json
- ComplianceReportPDF component created with all required sections
- GET endpoint at /api/admin/reports/organization/:orgId functional
- PDF includes RANZ branding (text), org name, generation date, dimension breakdown
- Endpoint requires RANZ admin authorization (403 for non-admin)
- Audit log created for each PDF generation
</success_criteria>

<output>
After completion, create `.planning/phases/07-admin-reporting/07-01-SUMMARY.md`
</output>
