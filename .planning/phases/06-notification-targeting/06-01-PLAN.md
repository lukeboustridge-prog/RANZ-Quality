---
phase: 06-notification-targeting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/cron/verify-lbp/route.ts
  - src/lib/notifications.ts
autonomous: true

must_haves:
  truths:
    - "LBP status change to SUSPENDED sends email to affected OrganizationMember.email"
    - "LBP status change to CANCELLED sends email to affected OrganizationMember.email"
    - "Organization.email still receives LBP status change notification (no regression)"
    - "Notification database record links to userId for member email"
    - "Organization email notification has null userId (org-level)"
    - "All three channels fire independently (org email, member email, member SMS)"
  artifacts:
    - path: "src/app/api/cron/verify-lbp/route.ts"
      provides: "Triple notification pattern for LBP status changes"
      contains: "createNotification.*channel.*EMAIL.*member\\.email"
    - path: "src/lib/notifications.ts"
      provides: "LBP notification message generators"
      contains: "generateMemberLBPMessage|generateOrgLBPMessage"
  key_links:
    - from: "src/app/api/cron/verify-lbp/route.ts"
      to: "createNotification"
      via: "import from @/lib/notifications"
      pattern: "createNotification\\(\\{[^}]*channel.*EMAIL"
---

<objective>
Add direct email notification to affected OrganizationMember for LBP status changes and convert organization email to use createNotification() for audit trail.

Purpose: Currently LBP status changes only email the organization address, missing the affected individual. Phase 5 added SMS to the member, but email to the member is missing. This creates a triple notification pattern: org email (compliance), member email (personal), member SMS (immediate).

Output: LBP status changes trigger 3 notifications - all tracked in database with proper userId targeting.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-notification-targeting/06-RESEARCH.md

@src/app/api/cron/verify-lbp/route.ts
@src/lib/notifications.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add LBP message generation helpers to notifications.ts</name>
  <files>src/lib/notifications.ts</files>
  <action>
Add two message generation helper functions at the end of notifications.ts (before the export statements):

1. `generateMemberLBPMessage(memberName: string, lbpNumber: string, oldStatus: string | null, newStatus: string): string`
   - Returns HTML email content for the affected member
   - Include: personal greeting, status change details (old -> new), what the status means
   - For SUSPENDED: warn they cannot carry out restricted building work
   - For CANCELLED: warn their license has been revoked
   - Include LBP Board contact: 0800 729 721, lbp@mbie.govt.nz
   - Include actionUrl placeholder text: "View your profile in the RANZ Portal"

2. `generateOrgLBPMessage(memberName: string, lbpNumber: string, oldStatus: string | null, newStatus: string): string`
   - Returns HTML email content for the organization
   - Include: staff member name, LBP number, status change
   - Add "Compliance Impact" section explaining this may affect organization's certification
   - Include actionUrl placeholder text: "View staff profile in the RANZ Portal"

Both functions should return the message body text (NOT the full HTML email - createNotification() wraps it in the email template).

Export both functions.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/lib/notifications.ts`</verify>
  <done>Two exported functions: generateMemberLBPMessage and generateOrgLBPMessage in notifications.ts</done>
</task>

<task type="auto">
  <name>Task 2: Convert org email to createNotification and add member email</name>
  <files>src/app/api/cron/verify-lbp/route.ts</files>
  <action>
Update the critical changes notification loop (lines 53-109) with triple notification pattern:

1. **Import the new helpers:**
   Add to existing imports from @/lib/notifications:
   `import { createNotification, generateMemberLBPMessage, generateOrgLBPMessage } from "@/lib/notifications";`

2. **Remove direct sendEmail import** (no longer needed - remove line 5):
   The old `import { sendEmail } from "@/lib/email";` is no longer used.

3. **Replace organization email block (lines 57-81)** with createNotification:
```typescript
// Email notification to organization (via createNotification for audit trail)
if (member?.organization?.email) {
  try {
    await createNotification({
      organizationId: member.organizationId,
      // userId null = organization-level notification
      type: "LBP_STATUS_CHANGE",
      channel: "EMAIL",
      priority: "CRITICAL",
      title: `Staff LBP Alert - ${member.firstName} ${member.lastName}`,
      message: generateOrgLBPMessage(
        `${member.firstName} ${member.lastName}`,
        change.lbpNumber,
        change.oldStatus,
        change.newStatus
      ),
      actionUrl: `${process.env.NEXT_PUBLIC_APP_URL}/staff/${member.id}`,
      recipient: member.organization.email,
    });
    console.log(`Organization notification sent to ${member.organization.email} for LBP status change`);
  } catch (orgEmailError) {
    console.error(`Failed to send LBP status change org notification:`, orgEmailError);
  }
}
```

4. **Add member email notification** (NEW - insert between org email and SMS blocks):
```typescript
// Email notification to affected member directly
if (member?.email) {
  try {
    await createNotification({
      organizationId: member.organizationId,
      userId: member.clerkUserId,  // Links to specific user
      type: "LBP_STATUS_CHANGE",
      channel: "EMAIL",
      priority: "CRITICAL",
      title: "Your LBP License Status Changed",
      message: generateMemberLBPMessage(
        `${member.firstName}`,
        change.lbpNumber,
        change.oldStatus,
        change.newStatus
      ),
      actionUrl: `${process.env.NEXT_PUBLIC_APP_URL}/staff`,
      recipient: member.email,
    });
    console.log(`Member notification sent to ${member.email} for LBP status change`);
  } catch (memberEmailError) {
    console.error(`Failed to send LBP status change member notification:`, memberEmailError);
  }
}
```

5. **Keep existing SMS notification** (lines 83-108) - no changes needed to SMS block.

Key implementation notes:
- Organization notification has NO userId (org-level)
- Member notification HAS userId (individual-level)
- Each channel has independent try/catch (one failure doesn't block others)
- All three use createNotification() for database audit trail
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. Grep confirms triple notification: `grep -c "createNotification" src/app/api/cron/verify-lbp/route.ts` should return 3
3. Grep confirms sendEmail removed: `grep "sendEmail" src/app/api/cron/verify-lbp/route.ts` should return nothing
  </verify>
  <done>
- LBP status change creates 3 notifications: org email, member email, member SMS
- sendEmail import removed (all emails via createNotification)
- Each notification has appropriate userId (null for org, clerkUserId for member)
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. Build succeeds: `npm run build`
2. Count createNotification calls in verify-lbp: should be 3 (org email, member email, member SMS)
3. No direct sendEmail usage in verify-lbp route
4. generateMemberLBPMessage and generateOrgLBPMessage exported from notifications.ts
</verification>

<success_criteria>
- LBP status change to SUSPENDED/CANCELLED triggers 3 notifications
- Organization email notification has null userId (org-level)
- Member email notification has userId = member.clerkUserId
- Member SMS notification has userId = member.clerkUserId (unchanged from Phase 5)
- All emails use createNotification() (not direct sendEmail)
- Build passes without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-notification-targeting/06-01-SUMMARY.md`
</output>
