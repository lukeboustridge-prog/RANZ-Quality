---
phase: 06-notification-targeting
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/cron/notifications/route.ts
  - src/lib/notifications.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Insurance expiry notification at 90 days links to owner userId in database"
    - "Insurance expiry notification at 60 days links to owner userId in database"
    - "Insurance expiry notification at 30 days links to owner userId in database"
    - "Notification database record has userId field populated (not just organizationId)"
    - "SMS notification for 30-day alert also links to owner userId"
  artifacts:
    - path: "src/lib/notifications.ts"
      provides: "notifyInsuranceExpiry with userId parameter"
      contains: "ownerUserId.*string"
    - path: "src/app/api/cron/notifications/route.ts"
      provides: "clerkUserId fetched in insurance expiry query"
      contains: "select.*clerkUserId"
  key_links:
    - from: "src/app/api/cron/notifications/route.ts"
      to: "notifyInsuranceExpiry"
      via: "ownerUserId parameter"
      pattern: "ownerUserId.*owner\\.clerkUserId"
    - from: "src/lib/notifications.ts"
      to: "createNotification"
      via: "userId parameter"
      pattern: "createNotification.*userId.*ownerUserId"
---

<objective>
Add userId linkage to insurance expiry notifications so database records connect to specific users.

Purpose: VERIFICATION.md gap identified that insurance expiry notifications create records with organizationId but no userId. This makes it impossible to query "all notifications for user X" and breaks Phase 6 success criterion #4: "Notification database record links to specific user ID (not just organization ID)".

Output: Insurance expiry notifications include ownerUserId in database records for proper user targeting.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-notification-targeting/06-VERIFICATION.md

@src/app/api/cron/notifications/route.ts
@src/lib/notifications.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add clerkUserId to insurance expiry query</name>
  <files>src/app/api/cron/notifications/route.ts</files>
  <action>
Update the `checkInsuranceExpiries()` function's Prisma query to include `clerkUserId` in the member select.

**Current code (lines 83-93):**
```typescript
include: {
  organization: {
    include: {
      members: {
        where: { role: "OWNER" },
        select: { email: true, phone: true },
      },
    },
  },
},
```

**Change to:**
```typescript
include: {
  organization: {
    include: {
      members: {
        where: { role: "OWNER" },
        select: { email: true, phone: true, clerkUserId: true },
      },
    },
  },
},
```

This adds `clerkUserId` to the fetched owner data so it can be passed to notifyInsuranceExpiry().
  </action>
  <verify>Grep confirms clerkUserId in select: `grep -A2 "where.*OWNER" src/app/api/cron/notifications/route.ts | grep clerkUserId`</verify>
  <done>Owner clerkUserId fetched in insurance expiry query</done>
</task>

<task type="auto">
  <name>Task 2: Update notifyInsuranceExpiry to accept and pass userId</name>
  <files>src/lib/notifications.ts</files>
  <action>
Update the `notifyInsuranceExpiry()` function to accept an optional `ownerUserId` parameter and pass it to `createNotification()`.

**1. Update function signature (around line 224):**

**Current:**
```typescript
export async function notifyInsuranceExpiry(params: {
  organizationId: string;
  businessName: string;
  policyType: string;
  daysUntilExpiry: number;
  ownerEmail: string;
  ownerPhone?: string;
}): Promise<void> {
```

**Change to:**
```typescript
export async function notifyInsuranceExpiry(params: {
  organizationId: string;
  businessName: string;
  policyType: string;
  daysUntilExpiry: number;
  ownerEmail: string;
  ownerPhone?: string;
  ownerUserId?: string;  // NEW: Links notification to specific user
}): Promise<void> {
```

**2. Update destructuring (around line 231):**

**Current:**
```typescript
const {
  organizationId,
  businessName,
  policyType,
  daysUntilExpiry,
  ownerEmail,
  ownerPhone,
} = params;
```

**Change to:**
```typescript
const {
  organizationId,
  businessName,
  policyType,
  daysUntilExpiry,
  ownerEmail,
  ownerPhone,
  ownerUserId,
} = params;
```

**3. Pass userId to email createNotification (around line 245):**

**Current:**
```typescript
await createNotification({
  organizationId,
  type: "INSURANCE_EXPIRY",
  channel: "EMAIL",
  ...
```

**Change to:**
```typescript
await createNotification({
  organizationId,
  userId: ownerUserId,  // NEW: Link to owner user
  type: "INSURANCE_EXPIRY",
  channel: "EMAIL",
  ...
```

**4. Pass userId to SMS createNotification (around line 271):**

**Current:**
```typescript
await createNotification({
  organizationId,
  type: "INSURANCE_EXPIRY",
  channel: "SMS",
  ...
```

**Change to:**
```typescript
await createNotification({
  organizationId,
  userId: ownerUserId,  // NEW: Link to owner user
  type: "INSURANCE_EXPIRY",
  channel: "SMS",
  ...
```

Both EMAIL and SMS notifications now link to the owner's userId.
  </action>
  <verify>
1. Function signature updated: `grep "ownerUserId.*string" src/lib/notifications.ts`
2. userId passed to both notifications: `grep -c "userId: ownerUserId" src/lib/notifications.ts` should return 2
  </verify>
  <done>notifyInsuranceExpiry accepts ownerUserId and passes to both createNotification calls</done>
</task>

<task type="auto">
  <name>Task 3: Pass ownerUserId in cron notification call</name>
  <files>src/app/api/cron/notifications/route.ts</files>
  <action>
Update the `notifyInsuranceExpiry()` call in `checkInsuranceExpiries()` to include the owner's clerkUserId.

**Current code (around lines 123-130 inside the transaction):**
```typescript
await notifyInsuranceExpiry({
  organizationId: policy.organizationId,
  businessName: policy.organization.name,
  policyType: policyTypeLabels[policy.policyType] || policy.policyType,
  daysUntilExpiry,
  ownerEmail: owner.email,
  ownerPhone: owner.phone || undefined,
});
```

**Change to:**
```typescript
await notifyInsuranceExpiry({
  organizationId: policy.organizationId,
  businessName: policy.organization.name,
  policyType: policyTypeLabels[policy.policyType] || policy.policyType,
  daysUntilExpiry,
  ownerEmail: owner.email,
  ownerPhone: owner.phone || undefined,
  ownerUserId: owner.clerkUserId,  // NEW: Link to owner user
});
```

This connects the fetched clerkUserId to the notification function.
  </action>
  <verify>
1. ownerUserId passed: `grep "ownerUserId.*owner" src/app/api/cron/notifications/route.ts`
2. TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>Insurance expiry notifications linked to owner userId via ownerUserId parameter</done>
</task>

</tasks>

<verification>
After all tasks:
1. Build succeeds: `npm run build`
2. clerkUserId in query select: grep confirms clerkUserId in member select
3. notifyInsuranceExpiry accepts ownerUserId: function signature includes ownerUserId
4. userId passed to createNotification: both EMAIL and SMS calls include userId: ownerUserId
5. Cron passes ownerUserId: notifyInsuranceExpiry call includes ownerUserId: owner.clerkUserId
</verification>

<success_criteria>
- Insurance expiry query fetches owner.clerkUserId
- notifyInsuranceExpiry() accepts ownerUserId parameter
- Both EMAIL and SMS createNotification() calls include userId: ownerUserId
- Cron route passes owner.clerkUserId to notifyInsuranceExpiry()
- Build passes without TypeScript errors
- VERIFICATION.md gaps for userId linkage resolved
</success_criteria>

<output>
After completion, create `.planning/phases/06-notification-targeting/06-03-SUMMARY.md`
</output>
