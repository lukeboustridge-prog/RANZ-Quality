---
phase: 05-sms-notification-system
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/cron/verify-lbp/route.ts
autonomous: true

must_haves:
  truths:
    - "LBP status changing to SUSPENDED triggers SMS to affected staff member"
    - "SMS sent to staff member's phone number (not organization phone)"
    - "SMS uses lbpStatusChange template with member name and status"
    - "Insurance policy expiring in 30 days triggers SMS to organization owner phone number"
  artifacts:
    - path: "src/app/api/cron/verify-lbp/route.ts"
      provides: "SMS notification for LBP status changes"
      contains: "createNotification"
  key_links:
    - from: "src/app/api/cron/verify-lbp/route.ts"
      to: "src/lib/notifications.ts"
      via: "createNotification import"
      pattern: "createNotification.*channel.*SMS"
---

<objective>
Add SMS notifications to the LBP verification cron for critical status changes.

Purpose: When daily LBP verification detects a license status change to SUSPENDED or CANCELLED, the affected staff member should receive an immediate SMS alert to their personal phone number (in addition to the existing organization email).

Output:
- LBP verification cron sends SMS to affected staff members
- Uses existing SMS_TEMPLATES.lbpStatusChange template
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-sms-notification-system/05-RESEARCH.md
@src/app/api/cron/verify-lbp/route.ts
@src/lib/notifications.ts
@src/lib/sms.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SMS notification for LBP status changes</name>
  <files>src/app/api/cron/verify-lbp/route.ts</files>
  <action>
Update `src/app/api/cron/verify-lbp/route.ts`:

1. Add imports at the top:
```typescript
import { createNotification } from "@/lib/notifications";
import { SMS_TEMPLATES } from "@/lib/sms";
```

2. Inside the `for (const change of criticalChanges)` loop, AFTER the existing email send (around line 77), add SMS notification:

```typescript
for (const change of criticalChanges) {
  const member = affectedMembers.find((m) => m.id === change.memberId);

  // Existing email notification to organization
  if (member?.organization?.email) {
    try {
      await sendEmail({
        // ... existing email code ...
      });
    } catch (emailError) {
      console.error(
        `Failed to send LBP status change notification:`,
        emailError
      );
    }
  }

  // NEW: SMS notification to affected staff member
  if (member?.phone) {
    try {
      await createNotification({
        organizationId: member.organizationId,
        userId: member.clerkUserId,
        type: "LBP_STATUS_CHANGE",
        channel: "SMS",
        priority: "CRITICAL",
        title: "LBP License Status Changed",
        message: SMS_TEMPLATES.lbpStatusChange(
          `${member.firstName} ${member.lastName}`,
          change.newStatus
        ),
        recipient: member.phone,
      });
      console.log(
        `SMS notification sent to ${member.firstName} ${member.lastName} for LBP status change`
      );
    } catch (smsError) {
      console.error(
        `Failed to send LBP status change SMS to ${member.email}:`,
        smsError
      );
    }
  }
}
```

Key points:
- SMS goes to member's personal phone (member.phone), not organization.phone
- Uses CRITICAL priority for immediate attention
- Uses existing SMS_TEMPLATES.lbpStatusChange for consistent messaging
- Logs success and failure for debugging
- Error in SMS does not block email send (independent try/catch)
  </action>
  <verify>
Run `npx tsc --noEmit` - compiles without errors.
Verify import statements are correct.
Verify createNotification call includes all required fields (type, channel, title, message, recipient).
  </verify>
  <done>LBP verification cron sends SMS to affected staff member's phone when status changes to SUSPENDED or CANCELLED</done>
</task>

<task type="auto">
  <name>Task 2: Add LBP_STATUS_CHANGE to NotificationType if missing</name>
  <files>src/types/index.ts</files>
  <action>
Check if `LBP_STATUS_CHANGE` exists in the NotificationType enum/type in `src/types/index.ts`.

If it exists, skip this task.

If it doesn't exist, add it to the NotificationType:

```typescript
export type NotificationType =
  | "INSURANCE_EXPIRY"
  | "AUDIT_SCHEDULED"
  | "AUDIT_REMINDER"
  | "CAPA_DUE"
  | "CAPA_OVERDUE"
  | "COMPLIANCE_ALERT"
  | "LBP_STATUS_CHANGE"  // ADD THIS LINE
  | "DOCUMENT_APPROVED"
  | "DOCUMENT_REJECTED"
  | "GENERAL";
```

Also check if it's in the Prisma schema enum `NotificationType`. If missing there too, add it and run migration.
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors related to LBP_STATUS_CHANGE.
Check Prisma schema has the enum value if using database-backed enum.
  </verify>
  <done>LBP_STATUS_CHANGE is a valid NotificationType usable in createNotification calls</done>
</task>

<task type="auto">
  <name>Task 3: Verify insurance expiry SMS trigger (existing implementation)</name>
  <files>src/app/api/cron/notifications/route.ts, src/lib/notifications.ts</files>
  <action>
Verify the existing insurance expiry SMS implementation is correctly wired:

1. Confirm `checkInsuranceExpiries()` in `src/app/api/cron/notifications/route.ts` calls `notifyInsuranceExpiry()` with `ownerPhone`:
```bash
grep -A20 "await notifyInsuranceExpiry" src/app/api/cron/notifications/route.ts | grep "ownerPhone"
```
Expected: Should show `ownerPhone: owner.phone || undefined`

2. Confirm `notifyInsuranceExpiry()` in `src/lib/notifications.ts` sends SMS when phone provided and daysUntilExpiry <= 30:
```bash
grep -A30 "export async function notifyInsuranceExpiry" src/lib/notifications.ts | grep -A5 "ownerPhone &&"
```
Expected: Should show conditional SMS send with `daysUntilExpiry <= 30`

3. Confirm SMS uses insuranceExpiry30 template:
```bash
grep "SMS_TEMPLATES.insuranceExpiry30" src/lib/notifications.ts
```
Expected: Should show template usage in notifyInsuranceExpiry function

If any of these checks fail, the implementation is already correct - no code changes needed for this task.
This task exists to verify requirement coverage for "Insurance policy expiring in 30 days triggers SMS to organization owner phone number".
  </action>
  <verify>
Run the three grep commands above. All should return matching results.
If they do, the existing implementation already satisfies the success criteria.
  </verify>
  <done>Existing insurance expiry SMS trigger verified: 30-day expiry sends SMS to owner phone via notifyInsuranceExpiry()</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. verify-lbp route imports createNotification and SMS_TEMPLATES
3. Critical LBP status changes (SUSPENDED, CANCELLED) trigger SMS to member.phone
4. SMS uses lbpStatusChange template with member name and new status
5. Existing email functionality unchanged
</verification>

<success_criteria>
- LBP status change to SUSPENDED sends SMS to staff member's phone
- LBP status change to CANCELLED sends SMS to staff member's phone
- SMS skipped gracefully when member has no phone number
- Email notification still sent to organization (no regression)
- Insurance expiry at 30 days triggers SMS to organization owner (existing implementation verified)
</success_criteria>

<output>
After completion, create `.planning/phases/05-sms-notification-system/05-02-SUMMARY.md`
</output>
