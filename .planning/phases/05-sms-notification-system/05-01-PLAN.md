---
phase: 05-sms-notification-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/notifications.ts
  - src/lib/sms.ts
autonomous: true

must_haves:
  truths:
    - "SMS delivery failures retry with exponential backoff delays"
    - "Database tracks nextRetryAt timestamp for each failed notification"
    - "Retries respect backoff schedule (not immediate)"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "lastRetryAt and nextRetryAt fields on Notification model"
      contains: "nextRetryAt"
    - path: "src/lib/notifications.ts"
      provides: "Exponential backoff calculation and retry scheduling"
      contains: "calculateNextRetryTime"
  key_links:
    - from: "src/lib/notifications.ts"
      to: "prisma.notification"
      via: "nextRetryAt query filter"
      pattern: "nextRetryAt.*lte"
---

<objective>
Implement exponential backoff retry logic for failed SMS notifications.

Purpose: Failed SMS deliveries currently retry immediately when the cron runs. This plan adds proper backoff delays (30s, 60s, 120s, up to 15min max) to prevent retry storms and give transient failures time to resolve.

Output:
- Database migration adding retry timestamp fields
- Backoff calculation function
- Updated retry logic respecting scheduled times
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-sms-notification-system/05-RESEARCH.md
@src/lib/notifications.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add retry timestamp fields to Notification schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add two new DateTime fields to the Notification model:

```prisma
model Notification {
  // ... existing fields ...

  // Retry scheduling for exponential backoff
  lastRetryAt     DateTime?           // Timestamp of last retry attempt
  nextRetryAt     DateTime?           // When next retry should occur

  // ... existing relations and indexes ...

  @@index([nextRetryAt])  // For efficient retry queries
}
```

Add the `@@index([nextRetryAt])` after the existing indexes for efficient cron queries.

Run `npx prisma migrate dev --name add_sms_retry_timestamps` to apply migration.
Run `npx prisma generate` to update the client.
  </action>
  <verify>
Run `npx prisma validate` - should pass without errors.
Check `node_modules/.prisma/client/index.d.ts` contains `lastRetryAt` and `nextRetryAt` fields.
  </verify>
  <done>Notification model has lastRetryAt and nextRetryAt nullable DateTime fields with index on nextRetryAt</done>
</task>

<task type="auto">
  <name>Task 2: Implement exponential backoff calculation</name>
  <files>src/lib/sms.ts</files>
  <action>
Add backoff calculation function to `src/lib/sms.ts` (near the top, after imports):

```typescript
// Exponential backoff configuration
const SMS_INITIAL_BACKOFF_SECONDS = 30;
const SMS_MAX_BACKOFF_SECONDS = 900; // 15 minutes

/**
 * Calculate next retry time using exponential backoff.
 *
 * Retry schedule:
 * - Retry 1: 30 seconds
 * - Retry 2: 60 seconds
 * - Retry 3: 120 seconds (capped, max 3 retries)
 *
 * @param retryCount Current retry count (1, 2, or 3)
 * @param failedAt When the last attempt failed
 * @returns Date when next retry should occur
 */
export function calculateNextRetryTime(retryCount: number, failedAt: Date): Date {
  const backoffSeconds = Math.pow(2, retryCount - 1) * SMS_INITIAL_BACKOFF_SECONDS;
  const delay = Math.min(backoffSeconds, SMS_MAX_BACKOFF_SECONDS);

  return new Date(failedAt.getTime() + delay * 1000);
}
```

Export this function so it can be used by notifications.ts.
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>calculateNextRetryTime function exported from sms.ts, returns Date with exponential delay capped at 15 minutes</done>
</task>

<task type="auto">
  <name>Task 3: Update retry logic with backoff scheduling</name>
  <files>src/lib/notifications.ts</files>
  <action>
Update `retryFailedNotifications()` in `src/lib/notifications.ts`:

1. Import the backoff function at top:
```typescript
import { sendSMS, SMS_TEMPLATES, calculateNextRetryTime } from "@/lib/sms";
```

2. Replace the `retryFailedNotifications` function:

```typescript
// Retry failed notifications with exponential backoff (called by cron)
export async function retryFailedNotifications(): Promise<number> {
  const now = new Date();

  const failedNotifications = await db.notification.findMany({
    where: {
      status: "FAILED",
      retryCount: { lt: 3 }, // Max 3 retries
      OR: [
        { nextRetryAt: null },        // Never scheduled (legacy records)
        { nextRetryAt: { lte: now } } // Retry time has been reached
      ]
    },
    take: 50,
  });

  let sentCount = 0;
  for (const notification of failedNotifications) {
    // Update lastRetryAt before attempt
    await db.notification.update({
      where: { id: notification.id },
      data: { lastRetryAt: now }
    });

    const result = await sendNotification(notification.id);

    if (result.success) {
      sentCount++;
    } else {
      // Calculate and schedule next retry if under limit
      const newRetryCount = notification.retryCount + 1;
      if (newRetryCount < 3) {
        const nextRetry = calculateNextRetryTime(newRetryCount, now);
        await db.notification.update({
          where: { id: notification.id },
          data: { nextRetryAt: nextRetry }
        });
      }
    }
  }

  return sentCount;
}
```

Key changes:
- Query filters on `nextRetryAt` to respect backoff schedule
- Records `lastRetryAt` before each attempt
- Calculates and stores `nextRetryAt` on failure
- Handles legacy records without `nextRetryAt` (treats as ready to retry)
  </action>
  <verify>
Run `npx tsc --noEmit` - compiles without errors.
Check the function handles the new fields correctly by reviewing the query and update logic.
  </verify>
  <done>retryFailedNotifications respects nextRetryAt schedule, updates lastRetryAt and nextRetryAt fields, uses exponential backoff calculation</done>
</task>

</tasks>

<verification>
1. Prisma schema validates: `npx prisma validate`
2. TypeScript compiles: `npx tsc --noEmit`
3. Notification model includes lastRetryAt, nextRetryAt fields
4. retryFailedNotifications queries use nextRetryAt filter
5. calculateNextRetryTime returns correct exponential delays:
   - retryCount=1 -> 30 seconds
   - retryCount=2 -> 60 seconds
   - retryCount=3 -> 120 seconds (capped)
</verification>

<success_criteria>
- Database migration applied successfully
- Failed SMS notifications scheduled with exponential backoff
- Retry logic respects nextRetryAt timestamp
- No regression in existing notification functionality
</success_criteria>

<output>
After completion, create `.planning/phases/05-sms-notification-system/05-01-SUMMARY.md`
</output>
