---
phase: 08-sso-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/clerk-sync.ts
  - src/lib/compliance-v2.ts
autonomous: true

must_haves:
  truths:
    - "Compliance score updates trigger Clerk metadata sync"
    - "Clerk organization public_metadata reflects current certification tier and compliance score"
    - "Metadata sync errors are logged but do not block compliance calculation"
  artifacts:
    - path: "src/lib/clerk-sync.ts"
      provides: "Clerk organization metadata sync utility"
      exports: ["syncOrgMetadataToClerk"]
    - path: "src/lib/compliance-v2.ts"
      provides: "Compliance calculation with metadata sync wiring"
      exports: ["updateOrganizationComplianceScore"]
  key_links:
    - from: "src/lib/compliance-v2.ts"
      to: "src/lib/clerk-sync.ts"
      via: "import and call after database update"
      pattern: "syncOrgMetadataToClerk"
    - from: "src/lib/clerk-sync.ts"
      to: "@clerk/nextjs/server"
      via: "clerkClient import"
      pattern: "clerkClient"
---

<objective>
Create Clerk metadata sync utility and wire it to compliance score updates.

Purpose: When compliance scores or certification tiers change, the updated values must be synced to Clerk's organization public_metadata so they can be embedded in JWT session claims for cross-app authorization in the Roofing Reports satellite domain.

Output: syncOrgMetadataToClerk function that updates Clerk organization metadata with certification_tier, compliance_score, and insurance_valid fields, called automatically after compliance score recalculation.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-sso-integration/08-RESEARCH.md
@src/lib/compliance-v2.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Clerk metadata sync utility</name>
  <files>
    src/lib/clerk-sync.ts
  </files>
  <action>
Create `src/lib/clerk-sync.ts` with the syncOrgMetadataToClerk function:

```typescript
import { clerkClient } from "@clerk/nextjs/server";
import { db } from "./db";

/**
 * Sync organization certification data to Clerk public_metadata
 * for JWT session claim embedding.
 *
 * This enables the Roofing Reports satellite domain to access
 * certification_tier and compliance_score via session claims.
 *
 * Note: Metadata changes appear in session tokens after the next
 * automatic refresh (60 seconds) unless client forces refresh.
 */
export async function syncOrgMetadataToClerk(
  organizationId: string,
  data: {
    certificationTier: string;
    complianceScore: number;
    insuranceValid: boolean;
  }
): Promise<void> {
  // Get clerkOrgId from database
  const org = await db.organization.findUnique({
    where: { id: organizationId },
    select: { clerkOrgId: true },
  });

  if (!org?.clerkOrgId) {
    console.warn(
      `[clerk-sync] Organization ${organizationId} has no clerkOrgId, skipping metadata sync`
    );
    return;
  }

  try {
    const client = await clerkClient();
    await client.organizations.updateOrganizationMetadata(org.clerkOrgId, {
      publicMetadata: {
        certification_tier: data.certificationTier,
        compliance_score: data.complianceScore,
        insurance_valid: data.insuranceValid,
      },
    });

    console.log(
      `[clerk-sync] Synced metadata for org ${organizationId}: tier=${data.certificationTier}, score=${data.complianceScore}, insurance=${data.insuranceValid}`
    );
  } catch (error) {
    // Log error but don't throw - metadata sync should not block operations
    console.error(
      `[clerk-sync] Failed to sync metadata for org ${organizationId}:`,
      error
    );
  }
}
```

Important implementation details:
1. Use `await clerkClient()` (function call) not direct import - Next.js 14+ App Router pattern
2. Use `updateOrganizationMetadata` not `updateOrganization` - metadata-specific method
3. Field names use snake_case (`certification_tier`) to match Clerk Dashboard JWT template syntax
4. Catch errors and log - metadata sync failures should not break compliance calculation
5. Skip silently if no clerkOrgId (handles test/seed data without Clerk organizations)
  </action>
  <verify>
TypeScript compilation: `pnpm tsc --noEmit` passes without errors.
File exists: `ls src/lib/clerk-sync.ts` returns the file.
Export check: `grep "export async function syncOrgMetadataToClerk" src/lib/clerk-sync.ts` matches.
  </verify>
  <done>
syncOrgMetadataToClerk function exists with proper error handling and logging. Function accepts organizationId and data object, fetches clerkOrgId from database, and updates Clerk public_metadata.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire metadata sync to compliance score updates</name>
  <files>
    src/lib/compliance-v2.ts
  </files>
  <action>
Modify `src/lib/compliance-v2.ts` to call syncOrgMetadataToClerk after updating compliance scores in the database.

1. Add import at top of file:
   ```typescript
   import { syncOrgMetadataToClerk } from "./clerk-sync";
   ```

2. Update the `updateOrganizationComplianceScore` function (around line 680-698) to:
   - Fetch certificationTier along with the score update
   - Determine insurance validity (any valid PUBLIC_LIABILITY policy)
   - Call syncOrgMetadataToClerk after database update

Replace the existing function with:
```typescript
export async function updateOrganizationComplianceScore(
  organizationId: string
): Promise<ComplianceResult> {
  const result = await calculateComplianceScore(organizationId);

  // Update database with compliance scores
  const updatedOrg = await db.organization.update({
    where: { id: organizationId },
    data: {
      complianceScore: result.overallScore,
      complianceDocScore: result.breakdown.documentation.score,
      complianceInsScore: result.breakdown.insurance.score,
      compliancePersScore: result.breakdown.personnel.score,
      complianceAuditScore: result.breakdown.audit.score,
      complianceLastCalc: new Date(),
    },
    select: {
      certificationTier: true,
    },
  });

  // Check if insurance is valid (any PUBLIC_LIABILITY policy not expired)
  const validInsurance = await db.insurancePolicy.findFirst({
    where: {
      organizationId,
      policyType: "PUBLIC_LIABILITY",
      expiryDate: { gte: new Date() },
    },
  });

  // Sync to Clerk metadata for JWT session claims (non-blocking)
  syncOrgMetadataToClerk(organizationId, {
    certificationTier: updatedOrg.certificationTier,
    complianceScore: result.overallScore,
    insuranceValid: !!validInsurance,
  }).catch((error) => {
    // Already logged in syncOrgMetadataToClerk, just ensure no unhandled rejection
    console.error("[compliance-v2] Clerk sync failed (non-blocking):", error);
  });

  return result;
}
```

Key changes:
1. Use `select` on update to get current certificationTier
2. Query insurance validity separately (not included in calculateComplianceScore return)
3. Call syncOrgMetadataToClerk without await - fire-and-forget pattern
4. Catch errors explicitly to prevent unhandled promise rejection warnings
  </action>
  <verify>
TypeScript compilation: `pnpm tsc --noEmit` passes.
Import exists: `grep "import { syncOrgMetadataToClerk }" src/lib/compliance-v2.ts` matches.
Function call exists: `grep "syncOrgMetadataToClerk" src/lib/compliance-v2.ts` shows the call.
  </verify>
  <done>
updateOrganizationComplianceScore now calls syncOrgMetadataToClerk after database update. Metadata sync is non-blocking (fire-and-forget) and errors are logged but do not fail the compliance calculation.
  </done>
</task>

</tasks>

<verification>
1. Type check: `pnpm tsc --noEmit` passes
2. Build check: `pnpm build` completes without errors
3. File exists: src/lib/clerk-sync.ts created with syncOrgMetadataToClerk export
4. Wiring exists: src/lib/compliance-v2.ts imports and calls syncOrgMetadataToClerk
5. Non-blocking: syncOrgMetadataToClerk call does not use await in compliance-v2.ts
</verification>

<success_criteria>
- src/lib/clerk-sync.ts exists with syncOrgMetadataToClerk function
- Function fetches clerkOrgId from database, calls clerkClient().organizations.updateOrganizationMetadata
- Errors are caught and logged, not thrown
- compliance-v2.ts imports and calls syncOrgMetadataToClerk after database update
- Call is fire-and-forget (no await) with explicit error catch
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-sso-integration/08-01-SUMMARY.md`
</output>
