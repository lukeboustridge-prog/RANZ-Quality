---
phase: 01-compliance-engine-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/index.ts
  - src/lib/compliance.ts
  - src/lib/compliance-v2.ts
autonomous: true

must_haves:
  truths:
    - "COMPLIANCE_THRESHOLDS constant exists and defines 90/70 values"
    - "getComplianceStatusLevel helper function returns correct status for any score"
    - "Legacy compliance.ts file is removed from codebase"
    - "compliance-v2.ts uses central constants instead of hardcoded values"
  artifacts:
    - path: "src/types/index.ts"
      provides: "Central compliance constants and helper"
      contains: "COMPLIANCE_THRESHOLDS"
    - path: "src/lib/compliance-v2.ts"
      provides: "Canonical compliance scoring engine using central constants"
      exports: ["calculateComplianceScore", "updateOrganizationComplianceScore", "getComplianceStatus"]
  key_links:
    - from: "src/lib/compliance-v2.ts"
      to: "src/types/index.ts"
      via: "import COMPLIANCE_THRESHOLDS"
      pattern: "import.*COMPLIANCE_THRESHOLDS.*from.*@/types"
---

<objective>
Create compliance scoring foundation by establishing central constants and consolidating to a single scoring engine.

Purpose: COMP-01 and COMP-02 require a single source of truth for compliance scoring. This plan creates the foundation that all other files will import from.

Output: Central constants in types/index.ts, updated compliance-v2.ts using those constants, and removal of legacy compliance.ts.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-compliance-engine-consolidation/01-RESEARCH.md

# Source files
@src/types/index.ts
@src/lib/compliance-v2.ts
@src/lib/compliance.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add compliance constants and helper to types/index.ts</name>
  <files>src/types/index.ts</files>
  <action>
Add the following constants and helper function to the END of src/types/index.ts (after the NZ_REGIONS export):

```typescript
// ============================================================================
// Compliance Scoring Constants
// ============================================================================

/**
 * Compliance threshold values
 * These define the scoring boundaries for compliance status
 *
 * @see CLAUDE.md - Part 2: Compliance scoring thresholds
 */
export const COMPLIANCE_THRESHOLDS = {
  /** Score >= 90% = Compliant (green) */
  COMPLIANT: 90,
  /** Score >= 70% = At Risk (yellow) */
  AT_RISK: 70,
  /** Score < 70% = Critical (red) */
  CRITICAL: 0,
} as const;

/**
 * Helper function to get compliance status level from score
 * Replaces hardcoded threshold logic throughout the codebase
 */
export function getComplianceStatusLevel(score: number): 'compliant' | 'at-risk' | 'critical' {
  if (score >= COMPLIANCE_THRESHOLDS.COMPLIANT) return 'compliant';
  if (score >= COMPLIANCE_THRESHOLDS.AT_RISK) return 'at-risk';
  return 'critical';
}

/**
 * Type-safe status metadata for UI components
 */
export const COMPLIANCE_STATUS_METADATA = {
  compliant: { label: 'Compliant', color: 'green', textColor: 'text-green-600', bgGradient: 'from-green-500 to-green-600' },
  'at-risk': { label: 'At Risk', color: 'yellow', textColor: 'text-yellow-600', bgGradient: 'from-yellow-500 to-yellow-600' },
  critical: { label: 'Critical', color: 'red', textColor: 'text-red-600', bgGradient: 'from-red-500 to-red-600' },
} as const;

export type ComplianceStatusLevel = keyof typeof COMPLIANCE_STATUS_METADATA;
```

Do NOT modify any existing content - only append to the file.
  </action>
  <verify>
Run TypeScript compiler to verify no syntax errors:
```bash
cd "C:\Users\LukeBoustridge\Projects\RANZ\RANZ Quality Program" && npx tsc --noEmit --skipLibCheck 2>&1 | head -20
```
Verify COMPLIANCE_THRESHOLDS is exported:
```bash
grep -n "COMPLIANCE_THRESHOLDS" src/types/index.ts
```
  </verify>
  <done>
- COMPLIANCE_THRESHOLDS constant exported with COMPLIANT=90, AT_RISK=70, CRITICAL=0
- getComplianceStatusLevel function exported
- COMPLIANCE_STATUS_METADATA exported with UI styling
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Update compliance-v2.ts to use central constants</name>
  <files>src/lib/compliance-v2.ts</files>
  <action>
Update src/lib/compliance-v2.ts to import and use central constants:

1. Add import at top of file (after existing imports from @/types):
   Change the existing import line to include COMPLIANCE_THRESHOLDS:
   ```typescript
   import {
     ALL_ISO_ELEMENTS,
     ISO_ELEMENT_WEIGHTS,
     INSURANCE_REQUIREMENTS,
     COMPLIANCE_THRESHOLDS,
     type InsurancePolicyType,
   } from "@/types";
   ```

2. Update getComplianceStatus function (around line 696-708) to use constants:
   Replace the hardcoded values:
   ```typescript
   export function getComplianceStatus(score: number): {
     status: "compliant" | "at-risk" | "critical";
     label: string;
     color: string;
   } {
     if (score >= COMPLIANCE_THRESHOLDS.COMPLIANT) {
       return { status: "compliant", label: "Compliant", color: "green" };
     }
     if (score >= COMPLIANCE_THRESHOLDS.AT_RISK) {
       return { status: "at-risk", label: "At Risk", color: "yellow" };
     }
     return { status: "critical", label: "Critical", color: "red" };
   }
   ```

Do NOT change the function's return type or behavior - only replace magic numbers 90 and 70 with COMPLIANCE_THRESHOLDS.COMPLIANT and COMPLIANCE_THRESHOLDS.AT_RISK.
  </action>
  <verify>
Run TypeScript compiler:
```bash
cd "C:\Users\LukeBoustridge\Projects\RANZ\RANZ Quality Program" && npx tsc --noEmit --skipLibCheck 2>&1 | head -20
```
Verify import exists:
```bash
grep -n "COMPLIANCE_THRESHOLDS" src/lib/compliance-v2.ts
```
Verify no hardcoded 90/70 remain in getComplianceStatus:
```bash
grep -A10 "export function getComplianceStatus" src/lib/compliance-v2.ts
```
  </verify>
  <done>
- COMPLIANCE_THRESHOLDS imported from @/types
- getComplianceStatus uses COMPLIANCE_THRESHOLDS.COMPLIANT and COMPLIANCE_THRESHOLDS.AT_RISK
- No hardcoded 90 or 70 values in getComplianceStatus function
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Delete legacy compliance.ts</name>
  <files>src/lib/compliance.ts</files>
  <action>
Delete the legacy compliance.ts file:

1. First verify no files import from it:
   ```bash
   grep -r "from ['\"]@/lib/compliance['\"]" src/
   grep -r "from ['\"].*compliance['\"]" src/ | grep -v compliance-v2
   ```
   Expected: No results (if results found, DO NOT DELETE - report which files need migration first)

2. If no imports found, delete the file:
   ```bash
   rm src/lib/compliance.ts
   ```

3. Verify deletion:
   ```bash
   ls src/lib/compliance.ts 2>&1
   ```
   Expected: "No such file or directory"

IMPORTANT: Do NOT delete if any active imports exist. The codebase analysis showed no imports, but verify before deleting.
  </action>
  <verify>
Verify file is deleted:
```bash
cd "C:\Users\LukeBoustridge\Projects\RANZ\RANZ Quality Program" && ls src/lib/compliance.ts 2>&1 || echo "File successfully deleted"
```
Verify TypeScript still compiles:
```bash
npx tsc --noEmit --skipLibCheck 2>&1 | head -20
```
  </verify>
  <done>
- src/lib/compliance.ts no longer exists in codebase
- No broken imports (TypeScript compiles successfully)
- Legacy 3-category scoring engine removed (only 4-dimension compliance-v2.ts remains)
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **TypeScript compilation passes:**
   ```bash
   cd "C:\Users\LukeBoustridge\Projects\RANZ\RANZ Quality Program" && npx tsc --noEmit --skipLibCheck
   ```

2. **Central constants exist:**
   ```bash
   grep "COMPLIANCE_THRESHOLDS" src/types/index.ts
   grep "getComplianceStatusLevel" src/types/index.ts
   ```

3. **compliance-v2.ts uses constants:**
   ```bash
   grep "COMPLIANCE_THRESHOLDS" src/lib/compliance-v2.ts
   ```

4. **Legacy file removed:**
   ```bash
   ls src/lib/compliance.ts 2>&1 && echo "FAIL: Legacy file still exists" || echo "PASS: Legacy file removed"
   ```

5. **Application builds:**
   ```bash
   npm run build 2>&1 | tail -20
   ```
</verification>

<success_criteria>
1. COMPLIANCE_THRESHOLDS constant exported from src/types/index.ts with values {COMPLIANT: 90, AT_RISK: 70, CRITICAL: 0}
2. getComplianceStatusLevel helper function exported from src/types/index.ts
3. src/lib/compliance-v2.ts imports and uses COMPLIANCE_THRESHOLDS (no hardcoded 90/70 in getComplianceStatus)
4. src/lib/compliance.ts deleted from codebase
5. TypeScript compiles without errors
6. Application builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/01-compliance-engine-consolidation/01-01-SUMMARY.md`
</output>
