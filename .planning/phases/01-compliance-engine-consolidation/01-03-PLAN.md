---
phase: 01-compliance-engine-consolidation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/app/api/admin/members/route.ts
  - src/lib/reports.ts
  - src/lib/badges.ts
autonomous: true

must_haves:
  truths:
    - "Admin members API uses central constants for filtering by compliance status"
    - "Reports lib uses central constants for score distribution calculation"
    - "Badges lib uses central constants for compliance score colors"
    - "API and lib files return identical status classifications as UI components"
  artifacts:
    - path: "src/app/api/admin/members/route.ts"
      provides: "Admin API with central constants for filtering"
      contains: "COMPLIANCE_THRESHOLDS"
    - path: "src/lib/reports.ts"
      provides: "Report generation using central constants"
      contains: "COMPLIANCE_THRESHOLDS"
    - path: "src/lib/badges.ts"
      provides: "Badge generation using central constants"
      contains: "COMPLIANCE_THRESHOLDS"
  key_links:
    - from: "src/app/api/admin/members/route.ts"
      to: "src/types/index.ts"
      via: "import COMPLIANCE_THRESHOLDS"
      pattern: "import.*COMPLIANCE_THRESHOLDS.*from.*@/types"
    - from: "src/lib/reports.ts"
      to: "src/types/index.ts"
      via: "import COMPLIANCE_THRESHOLDS"
      pattern: "import.*COMPLIANCE_THRESHOLDS.*from.*@/types"
---

<objective>
Migrate API routes and lib files to use central compliance constants, ensuring backend scoring matches frontend display.

Purpose: COMP-02 requires all components to use centralized thresholds. This plan updates the admin API filtering logic, report generation, and badge generation to use the same constants as the UI.

Output: Updated admin/members API route, reports.ts, and badges.ts - all importing COMPLIANCE_THRESHOLDS from @/types.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-compliance-engine-consolidation/01-RESEARCH.md

# Prior plan summary (contains central constants)
@.planning/phases/01-compliance-engine-consolidation/01-01-SUMMARY.md

# Source files to update
@src/app/api/admin/members/route.ts
@src/lib/reports.ts
@src/lib/badges.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update admin members API route to use central constants</name>
  <files>src/app/api/admin/members/route.ts</files>
  <action>
Update src/app/api/admin/members/route.ts to use central constants:

1. Add import at top of file (with existing imports):
   ```typescript
   import { COMPLIANCE_THRESHOLDS } from "@/types";
   ```

2. Replace the filter logic (around lines 76-78) that checks compliance status:
   Current:
   ```typescript
   if (status === "compliant") return score >= 90;
   if (status === "at-risk") return score >= 70 && score < 90;
   if (status === "critical") return score < 70;
   ```

   Replace with:
   ```typescript
   if (status === "compliant") return score >= COMPLIANCE_THRESHOLDS.COMPLIANT;
   if (status === "at-risk") return score >= COMPLIANCE_THRESHOLDS.AT_RISK && score < COMPLIANCE_THRESHOLDS.COMPLIANT;
   if (status === "critical") return score < COMPLIANCE_THRESHOLDS.AT_RISK;
   ```

3. Replace the stats calculation (around lines 86-88):
   Current:
   ```typescript
   compliant: organizations.filter((o) => o.complianceScore >= 90).length,
   atRisk: organizations.filter((o) => o.complianceScore >= 70 && o.complianceScore < 90).length,
   ```

   Replace with:
   ```typescript
   compliant: organizations.filter((o) => o.complianceScore >= COMPLIANCE_THRESHOLDS.COMPLIANT).length,
   atRisk: organizations.filter((o) => o.complianceScore >= COMPLIANCE_THRESHOLDS.AT_RISK && o.complianceScore < COMPLIANCE_THRESHOLDS.COMPLIANT).length,
   ```

Note: The third line calculating critical count may use `< 70` - replace with `< COMPLIANCE_THRESHOLDS.AT_RISK` if present.
  </action>
  <verify>
Verify import added:
```bash
cd "C:\Users\LukeBoustridge\Projects\RANZ\RANZ Quality Program" && grep -n "COMPLIANCE_THRESHOLDS" src/app/api/admin/members/route.ts | head -5
```
Verify no hardcoded 90/70 remain:
```bash
grep -n ">= 90\|>= 70\|< 90\|< 70" src/app/api/admin/members/route.ts && echo "FAIL: Hardcoded values remain" || echo "PASS: No hardcoded thresholds"
```
TypeScript compiles:
```bash
npx tsc --noEmit --skipLibCheck 2>&1 | head -20
```
  </verify>
  <done>
- COMPLIANCE_THRESHOLDS imported from @/types
- Filter logic uses COMPLIANCE_THRESHOLDS.COMPLIANT and COMPLIANCE_THRESHOLDS.AT_RISK
- Stats calculation uses central constants
- No hardcoded threshold values (90, 70) remain in file
  </done>
</task>

<task type="auto">
  <name>Task 2: Update reports.ts to use central constants</name>
  <files>src/lib/reports.ts</files>
  <action>
Update src/lib/reports.ts to use central constants:

1. Add import at top of file (with existing imports from @/types if any):
   ```typescript
   import { COMPLIANCE_THRESHOLDS } from "@/types";
   ```

   If the file already imports from @/types, add COMPLIANCE_THRESHOLDS to that import.

2. Find and replace the score distribution logic (around lines 157-158):
   Current:
   ```typescript
   if (org.complianceScore >= 90) scoreDistribution.excellent++;
   else if (org.complianceScore >= 70) scoreDistribution.good++;
   ```

   Replace with:
   ```typescript
   if (org.complianceScore >= COMPLIANCE_THRESHOLDS.COMPLIANT) scoreDistribution.excellent++;
   else if (org.complianceScore >= COMPLIANCE_THRESHOLDS.AT_RISK) scoreDistribution.good++;
   ```

Search for any other occurrences of hardcoded 90 or 70 in the file and replace them with the appropriate constant.
  </action>
  <verify>
Verify import added:
```bash
cd "C:\Users\LukeBoustridge\Projects\RANZ\RANZ Quality Program" && grep -n "COMPLIANCE_THRESHOLDS" src/lib/reports.ts | head -5
```
Verify no hardcoded 90/70 remain in score logic:
```bash
grep -n "complianceScore >= 90\|complianceScore >= 70" src/lib/reports.ts && echo "FAIL: Hardcoded values remain" || echo "PASS: No hardcoded thresholds"
```
TypeScript compiles:
```bash
npx tsc --noEmit --skipLibCheck 2>&1 | head -20
```
  </verify>
  <done>
- COMPLIANCE_THRESHOLDS imported from @/types
- Score distribution uses COMPLIANCE_THRESHOLDS.COMPLIANT for excellent threshold
- Score distribution uses COMPLIANCE_THRESHOLDS.AT_RISK for good threshold
- No hardcoded threshold values remain in file
  </done>
</task>

<task type="auto">
  <name>Task 3: Update badges.ts to use central constants</name>
  <files>src/lib/badges.ts</files>
  <action>
Update src/lib/badges.ts to use central constants:

1. Add import at top of file:
   ```typescript
   import { COMPLIANCE_THRESHOLDS } from "@/types";
   ```

   If file already imports from @/types, add COMPLIANCE_THRESHOLDS to that import.

2. Find the SVG color logic (around line 225) that contains:
   ```typescript
   fill="${complianceScore >= 90 ? '#16a34a' : complianceScore >= 70 ? '#ca8a04' : '#dc2626'}"
   ```

   Replace with:
   ```typescript
   fill="${complianceScore >= COMPLIANCE_THRESHOLDS.COMPLIANT ? '#16a34a' : complianceScore >= COMPLIANCE_THRESHOLDS.AT_RISK ? '#ca8a04' : '#dc2626'}"
   ```

Search the entire file for any other occurrences of `>= 90` or `>= 70` patterns and replace with constants.

Note: The hex colors (#16a34a = green-600, #ca8a04 = yellow-600, #dc2626 = red-600) should remain as they are - only replace the numeric thresholds.
  </action>
  <verify>
Verify import added:
```bash
cd "C:\Users\LukeBoustridge\Projects\RANZ\RANZ Quality Program" && grep -n "COMPLIANCE_THRESHOLDS" src/lib/badges.ts | head -5
```
Verify no hardcoded 90/70 remain:
```bash
grep -n ">= 90\|>= 70" src/lib/badges.ts && echo "FAIL: Hardcoded values remain" || echo "PASS: No hardcoded thresholds"
```
TypeScript compiles:
```bash
npx tsc --noEmit --skipLibCheck 2>&1 | head -20
```
  </verify>
  <done>
- COMPLIANCE_THRESHOLDS imported from @/types
- SVG fill color logic uses COMPLIANCE_THRESHOLDS.COMPLIANT and COMPLIANCE_THRESHOLDS.AT_RISK
- No hardcoded threshold values (90, 70) remain in file
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **TypeScript compilation passes:**
   ```bash
   cd "C:\Users\LukeBoustridge\Projects\RANZ\RANZ Quality Program" && npx tsc --noEmit --skipLibCheck
   ```

2. **All API/lib files import from @/types:**
   ```bash
   grep -l "COMPLIANCE_THRESHOLDS" src/app/api/admin/members/route.ts src/lib/reports.ts src/lib/badges.ts
   ```
   Expected: All 3 files listed

3. **No hardcoded 90/70 thresholds in API/lib files:**
   ```bash
   grep -rn ">= 90\|>= 70\|< 90\|< 70" src/app/api/admin/members/route.ts src/lib/reports.ts src/lib/badges.ts | grep -v COMPLIANCE_THRESHOLDS && echo "FAIL" || echo "PASS"
   ```
   Expected: No matches found (lines with COMPLIANCE_THRESHOLDS are OK), "PASS" printed

4. **Application builds:**
   ```bash
   npm run build 2>&1 | tail -20
   ```
</verification>

<success_criteria>
1. admin/members/route.ts imports COMPLIANCE_THRESHOLDS and uses constants for all filter and stats calculations
2. reports.ts imports COMPLIANCE_THRESHOLDS and uses constants for score distribution
3. badges.ts imports COMPLIANCE_THRESHOLDS and uses constants for SVG color logic
4. Zero hardcoded 90 or 70 threshold values remain in any of the three files
5. TypeScript compiles without errors
6. Application builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/01-compliance-engine-consolidation/01-03-SUMMARY.md`
</output>
