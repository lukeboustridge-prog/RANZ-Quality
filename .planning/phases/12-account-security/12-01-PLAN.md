---
phase: 12-account-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/settings/security-settings.tsx
  - src/app/(dashboard)/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can change their password from security settings section"
    - "User can enable two-factor authentication (TOTP or SMS backup)"
    - "User can disable two-factor authentication if already enabled"
    - "User can view list of active sessions with device/location info"
    - "User can sign out of any session remotely"
  artifacts:
    - path: "src/components/settings/security-settings.tsx"
      provides: "Security settings component wrapping Clerk UserProfile security page"
      min_lines: 20
  key_links:
    - from: "src/app/(dashboard)/settings/page.tsx"
      to: "SecuritySettings component"
      via: "Component import and render"
      pattern: "SecuritySettings"
    - from: "src/components/settings/security-settings.tsx"
      to: "@clerk/nextjs UserProfile"
      via: "Component import with security routing"
      pattern: "UserProfile.*routing.*security"
---

<objective>
Expose Clerk's built-in security features (password, 2FA, sessions) as a dedicated section in the settings page.

Purpose: Complete the v1.1 Settings milestone by enabling users to manage account security. Clerk already provides production-ready password management, 2FA enrollment, and session management - we just need to surface it in the UI.

Output: Security Settings section visible to all users on the settings page with access to password change, 2FA setup, and session management.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

# Prior Phase Summary (relevant)
@.planning/phases/11-personal-settings/11-01-SUMMARY.md

# Existing Components
@src/components/settings/user-profile-section.tsx
@src/app/(dashboard)/settings/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SecuritySettings component</name>
  <files>src/components/settings/security-settings.tsx</files>
  <action>
Create a client component that embeds Clerk's UserProfile component configured to show the security page.

Key implementation details:
1. Use `UserProfile` component from `@clerk/nextjs`
2. Configure `routing="hash"` or `routing="path"` to enable internal navigation
3. Set initial page to "security" using the `path` or default navigation
4. Apply consistent appearance styling matching UserProfileSection:
   - `rootBox: 'w-full'`
   - `card: 'shadow-none border border-gray-200 rounded-lg'`
   - `colorPrimary: '#2563eb'` (blue-600)
5. Show the navbar so users can switch between profile and security tabs within the component
6. The component should expose:
   - Password change (built into Clerk)
   - Two-factor authentication toggle (TOTP and SMS backup options built into Clerk)
   - Active sessions list with sign-out capability (built into Clerk)

Pattern to follow (from user-profile-section.tsx):
```tsx
"use client";
import { UserProfile } from '@clerk/nextjs';

export function SecuritySettings() {
  return (
    <div className="clerk-security-wrapper">
      <UserProfile
        appearance={{
          elements: {
            rootBox: 'w-full',
            card: 'shadow-none border border-gray-200 rounded-lg',
            pageScrollBox: 'p-0',
            // Show navbar for Security page navigation
            navbarButton: 'text-gray-600 hover:text-gray-900',
            navbarButtonActive: 'text-blue-600 border-b-2 border-blue-600',
          },
          variables: {
            colorPrimary: '#2563eb',
          }
        }}
        // Route to security page by default
        routing="hash"
      />
    </div>
  );
}
```

Note: Clerk's UserProfile provides the following security features out of the box:
- Password management (change password, password requirements)
- Two-factor authentication (TOTP authenticator app, SMS backup codes)
- Active sessions (device type, location, sign out remotely)
- Connected accounts (OAuth providers if configured)
  </action>
  <verify>
File exists at `src/components/settings/security-settings.tsx`
TypeScript compiles without errors: `cd "RANZ Quality Program" && npx tsc --noEmit`
Component exports SecuritySettings function
  </verify>
  <done>
SecuritySettings component created that wraps Clerk UserProfile with security-focused configuration
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Security Settings section to settings page</name>
  <files>src/app/(dashboard)/settings/page.tsx</files>
  <action>
Add Security Settings section to the settings page, visible to all users (not just admins).

Implementation:
1. Import `SecuritySettings` from `@/components/settings/security-settings`
2. Add a new section after "Personal Notification Preferences" section
3. Section structure:
```tsx
{/* ALL USERS: Account Security */}
<div className="bg-white rounded-lg shadow p-6">
  <h2 className="text-lg font-semibold text-gray-900 mb-6">
    Account Security
  </h2>
  <p className="text-sm text-gray-500 mb-4">
    Manage your password, two-factor authentication, and active sessions
  </p>
  <SecuritySettings />
</div>
```

This follows the exact pattern used for Personal Profile and Personal Notification Preferences sections.
  </action>
  <verify>
File compiles without errors: `cd "RANZ Quality Program" && npx tsc --noEmit`
Settings page imports and renders SecuritySettings component
Section appears for all authenticated users (not gated by isAdmin)
  </verify>
  <done>
Settings page includes Account Security section visible to all users
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify complete security flow</name>
  <files></files>
  <action>
Run the development server and verify the security settings are accessible:

1. Start dev server: `cd "RANZ Quality Program" && pnpm dev`
2. Navigate to /settings (logged in as any user)
3. Scroll to Account Security section
4. Verify Clerk's security UI renders with:
   - Password section (ability to change password)
   - Two-factor authentication section (enable/disable TOTP, SMS)
   - Active sessions section (list sessions, sign out remotely)

If the UserProfile shows the profile page by default instead of security:
- Check if `routing="hash"` or `routing="path"` allows direct security access
- May need to adjust the initial path or use URL fragments
- Alternative: Use Clerk's `UserButton` with `appearance.elements.userButtonPopoverCard` customization

Log any issues encountered and their resolutions.
  </action>
  <verify>
Dev server starts without errors
Security section visible at /settings
Password change UI accessible
2FA toggle visible
Active sessions list visible
  </verify>
  <done>
Security settings fully functional with password, 2FA, and session management accessible
  </done>
</task>

</tasks>

<verification>
All phase success criteria must be verified:

1. **Password Change (PERS-03):**
   - Navigate to /settings
   - Scroll to Account Security section
   - Click to change password
   - Verify password change UI appears

2. **2FA Enable (PERS-04):**
   - In Account Security section
   - Find two-factor authentication option
   - Verify "Add" or "Enable" button present
   - (Do not actually enable - just verify UI is present)

3. **2FA Disable (PERS-04):**
   - If 2FA enabled, verify "Remove" or "Disable" option visible
   - (Covered by Clerk's built-in flow)

4. **Active Sessions View (PERS-05):**
   - In Account Security section
   - Find active sessions/devices list
   - Verify current session shown with device/location info

5. **Remote Sign Out (PERS-05):**
   - In active sessions list
   - Verify "Sign out" option available for other sessions
   - (Do not actually sign out - just verify UI is present)
</verification>

<success_criteria>
All requirements satisfied:

- [x] PERS-03: User can change password from security settings
- [x] PERS-04: User can enable/disable 2FA (TOTP or SMS)
- [x] PERS-05: User can view active sessions and sign out remotely

Phase goal achieved:
- Account Security section added to settings page
- All security features accessible via Clerk's built-in UI
- Consistent styling with rest of settings page
</success_criteria>

<output>
After completion, create `.planning/phases/12-account-security/12-01-SUMMARY.md` following the summary template.

Update REQUIREMENTS.md to mark PERS-03, PERS-04, PERS-05 as complete.
Update ROADMAP.md to mark Phase 12 as complete and update v1.1 milestone status.
</output>
