---
phase: 04-public-api-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/index.ts
  - src/app/api/public/verify/route.ts
  - prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "Public verification endpoint accepts NZBN query parameter"
    - "Public verification endpoint accepts name query parameter"
    - "Attempting to verify with organization ID returns 400 error"
    - "Non-existent NZBN returns 404 not found"
    - "Name search is case-insensitive"
  artifacts:
    - path: "src/app/api/public/verify/route.ts"
      provides: "Query-parameter based verification endpoint"
      exports: ["GET", "OPTIONS"]
    - path: "src/types/index.ts"
      provides: "NZBN_REGEX constant and MAX_FILE_SIZE constants"
      contains: "NZBN_REGEX"
    - path: "prisma/schema.prisma"
      provides: "Database indexes for name and tradingName"
      contains: "@@index([name])"
  key_links:
    - from: "src/app/api/public/verify/route.ts"
      to: "prisma.organization"
      via: "findFirst with NZBN or name query"
      pattern: "db\\.organization\\.findFirst"
---

<objective>
Refactor the public verification API to accept NZBN or business name lookups instead of internal organization IDs.

Purpose: Prevent enumeration attacks where attackers could iterate through organization IDs to discover all certified members. NZBN is a public identifier that cannot be enumerated sequentially.

Output: New query-parameter-based verification endpoint that rejects organization ID lookups with helpful error messages.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-public-api-hardening/04-RESEARCH.md
@src/app/api/public/verify/[businessId]/route.ts
@src/types/index.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add upload and NZBN constants to types/index.ts</name>
  <files>src/types/index.ts</files>
  <action>
Add the following constants to src/types/index.ts at the end of the file:

```typescript
// ============================================================================
// File Upload Constants
// ============================================================================

/**
 * Maximum file size for uploads (50MB)
 * Used by document and insurance upload endpoints
 */
export const MAX_FILE_SIZE_BYTES = 50 * 1024 * 1024; // 50MB
export const MAX_FILE_SIZE_MB = 50;

// ============================================================================
// NZBN Validation
// ============================================================================

/**
 * New Zealand Business Number (NZBN) validation regex
 * NZBN is exactly 13 digits
 */
export const NZBN_REGEX = /^\d{13}$/;
```

These constants will be used by the verification endpoint and all file upload endpoints.
  </action>
  <verify>Check that the constants are exported correctly:
```bash
grep -n "MAX_FILE_SIZE_BYTES\|NZBN_REGEX" src/types/index.ts
```
Should show both constants defined.</verify>
  <done>NZBN_REGEX and MAX_FILE_SIZE constants exported from src/types/index.ts</done>
</task>

<task type="auto">
  <name>Task 2: Add database indexes for name search</name>
  <files>prisma/schema.prisma</files>
  <action>
Add indexes for name and tradingName fields on the Organization model in prisma/schema.prisma.

Find the Organization model and add two new indexes after the existing indexes:

```prisma
model Organization {
  // ... existing fields ...

  @@index([certificationTier])
  @@index([complianceScore])
  @@index([name])         // NEW: For name-based verification lookup
  @@index([tradingName])  // NEW: For trading name verification lookup
}
```

Then run prisma db push to apply the migration (or generate migration if needed).

Note: The NZBN field already has @unique which creates an index automatically.
  </action>
  <verify>Run:
```bash
npx prisma db push --accept-data-loss
```
Should complete without errors. The indexes will be created in the database.</verify>
  <done>Database indexes added for name and tradingName fields for efficient name-based lookups</done>
</task>

<task type="auto">
  <name>Task 3: Create query-parameter verification endpoint</name>
  <files>src/app/api/public/verify/route.ts</files>
  <action>
Create a new file at src/app/api/public/verify/route.ts (NOT in the [businessId] folder).

This new endpoint accepts query parameters instead of path parameters:
- GET /api/public/verify?nzbn=9429041234567 - Lookup by NZBN
- GET /api/public/verify?name=Example%20Roofing%20Ltd - Lookup by name/trading name

Implementation:

```typescript
import { NextRequest, NextResponse } from "next/server";
import { db } from "@/lib/db";
import { NZBN_REGEX } from "@/types";

export async function GET(req: NextRequest) {
  try {
    const { searchParams } = new URL(req.url);
    const nzbn = searchParams.get('nzbn');
    const name = searchParams.get('name');

    // Require at least one search parameter
    if (!nzbn && !name) {
      return NextResponse.json(
        {
          verified: false,
          error: "Must provide either 'nzbn' or 'name' query parameter. Example: /api/public/verify?nzbn=9429041234567",
        },
        { status: 400 }
      );
    }

    // If NZBN provided, validate format
    if (nzbn && !NZBN_REGEX.test(nzbn)) {
      return NextResponse.json(
        {
          verified: false,
          error: "Invalid NZBN format. NZBN must be exactly 13 digits.",
        },
        { status: 400 }
      );
    }

    // Build query based on provided parameter
    const organization = nzbn
      ? await db.organization.findFirst({
          where: { nzbn: nzbn },
          include: {
            insurancePolicies: {
              where: { expiryDate: { gt: new Date() } },
              select: { policyType: true },
            },
            audits: {
              where: { status: "COMPLETED" },
              orderBy: { completedAt: "desc" },
              take: 1,
              select: { completedAt: true, rating: true },
            },
          },
        })
      : await db.organization.findFirst({
          where: {
            OR: [
              { name: { equals: name!, mode: 'insensitive' } },
              { tradingName: { equals: name!, mode: 'insensitive' } },
            ],
          },
          include: {
            insurancePolicies: {
              where: { expiryDate: { gt: new Date() } },
              select: { policyType: true },
            },
            audits: {
              where: { status: "COMPLETED" },
              orderBy: { completedAt: "desc" },
              take: 1,
              select: { completedAt: true, rating: true },
            },
          },
        });

    if (!organization) {
      return NextResponse.json(
        { verified: false, error: "Business not found" },
        { status: 404 }
      );
    }

    const hasRequiredInsurance =
      organization.insurancePolicies.some(
        (p) => p.policyType === "PUBLIC_LIABILITY"
      ) &&
      organization.insurancePolicies.some(
        (p) => p.policyType === "PROFESSIONAL_INDEMNITY"
      );

    const response = {
      verified: true,
      nzbn: organization.nzbn,
      businessName: organization.name,
      tradingName: organization.tradingName,
      certificationTier: organization.certificationTier,
      certifiedSince: organization.certifiedSince?.toISOString() || null,
      complianceScore: organization.complianceScore,
      insuranceValid: hasRequiredInsurance,
      lastAudit: organization.audits[0]
        ? {
            date: organization.audits[0].completedAt,
            rating: organization.audits[0].rating,
          }
        : null,
      lastVerified: new Date().toISOString(),
      // Badge URL uses NZBN if available, otherwise internal ID for backwards compat
      badgeUrl: organization.nzbn
        ? `${process.env.NEXT_PUBLIC_APP_URL || ""}/api/public/badge/${organization.id}/image`
        : `${process.env.NEXT_PUBLIC_APP_URL || ""}/api/public/badge/${organization.id}/image`,
    };

    return NextResponse.json(response, {
      headers: {
        "Access-Control-Allow-Origin": "*",
        "Access-Control-Allow-Methods": "GET",
        "Cache-Control": "public, max-age=300",
      },
    });
  } catch (error) {
    console.error("Verification failed:", error);
    return NextResponse.json(
      { verified: false, error: "Verification failed" },
      { status: 500 }
    );
  }
}

export async function OPTIONS() {
  return new NextResponse(null, {
    status: 204,
    headers: {
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Methods": "GET, OPTIONS",
      "Access-Control-Allow-Headers": "Content-Type",
    },
  });
}
```

Key differences from old endpoint:
1. Uses query parameters (?nzbn=... or ?name=...) not path parameter
2. Does NOT expose internal organization ID in response
3. Validates NZBN format before querying
4. Case-insensitive name search
5. Returns 400 for missing/invalid parameters
  </action>
  <verify>Test the new endpoint:
```bash
# Should return 400 (no parameters)
curl -s "http://localhost:3000/api/public/verify" | jq .

# Should return 400 (invalid NZBN format)
curl -s "http://localhost:3000/api/public/verify?nzbn=123" | jq .
```
Both should return error responses with helpful messages.</verify>
  <done>Query-parameter verification endpoint created at /api/public/verify with NZBN and name search support</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Constants exist in types/index.ts:
```bash
grep "NZBN_REGEX\|MAX_FILE_SIZE" src/types/index.ts
```

2. Database indexes applied (check Prisma schema):
```bash
grep "@@index(\[name\])\|@@index(\[tradingName\])" prisma/schema.prisma
```

3. New verification endpoint exists:
```bash
ls src/app/api/public/verify/route.ts
```

4. TypeScript compiles without errors:
```bash
npx tsc --noEmit --skipLibCheck 2>&1 | head -20
```
</verification>

<success_criteria>
- [ ] NZBN_REGEX and MAX_FILE_SIZE constants exported from src/types/index.ts
- [ ] Database indexes added for Organization.name and Organization.tradingName
- [ ] New /api/public/verify route accepts ?nzbn= and ?name= query parameters
- [ ] Missing parameters returns 400 with helpful error message
- [ ] Invalid NZBN format returns 400 with format guidance
- [ ] Non-existent business returns 404
- [ ] Internal organization ID NOT exposed in response
</success_criteria>

<output>
After completion, create `.planning/phases/04-public-api-hardening/04-01-SUMMARY.md`
</output>
