---
phase: 04-public-api-hardening
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/app/api/public/verify/[businessId]/route.ts
autonomous: true

must_haves:
  truths:
    - "Legacy endpoint with organization ID returns 400 error"
    - "Error message directs users to new query-parameter endpoint"
    - "CUID-format IDs are detected and rejected"
  artifacts:
    - path: "src/app/api/public/verify/[businessId]/route.ts"
      provides: "Deprecation handler that rejects org ID lookups"
      exports: ["GET", "OPTIONS"]
  key_links:
    - from: "src/app/api/public/verify/[businessId]/route.ts"
      to: "error response"
      via: "CUID detection regex"
      pattern: "starts.*with.*cl.*cm"
---

<objective>
Update the legacy verification endpoint to reject organization ID lookups and direct users to the new query-parameter endpoint.

Purpose: Complete the SEC-02 requirement by ensuring the old endpoint cannot be used for enumeration attacks. The old endpoint remains to provide clear migration guidance rather than a confusing 404.

Output: Legacy endpoint returns 400 Bad Request with helpful message directing to new endpoint format.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-public-api-hardening/04-RESEARCH.md
@src/app/api/public/verify/[businessId]/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update legacy endpoint to reject org ID lookups</name>
  <files>src/app/api/public/verify/[businessId]/route.ts</files>
  <action>
Replace the entire content of src/app/api/public/verify/[businessId]/route.ts to:

1. Detect if the businessId looks like an internal organization ID (CUID format starts with 'cl' or 'cm', or is not a 13-digit NZBN)
2. Return 400 error with clear migration instructions
3. If it IS a valid 13-digit NZBN, redirect to the new endpoint (optional: could just tell them to use query params)

```typescript
import { NextRequest, NextResponse } from "next/server";
import { NZBN_REGEX } from "@/types";

/**
 * DEPRECATED: Legacy verification endpoint using path parameter
 *
 * This endpoint now returns 400 for all requests and directs users to
 * the new query-parameter based endpoint at /api/public/verify?nzbn=...
 *
 * Reason: Prevent enumeration attacks via sequential organization ID guessing.
 * Internal organization IDs (CUID format) should never be exposed in public APIs.
 */
export async function GET(
  _req: NextRequest,
  { params }: { params: Promise<{ businessId: string }> }
) {
  const { businessId } = await params;

  // Check if this looks like an internal organization ID (CUID format)
  // CUIDs typically start with 'cl' (Prisma) or 'cm' and are alphanumeric
  const looksLikeOrgId = /^c[lm][a-z0-9]{20,}$/i.test(businessId);

  // Check if it's a valid NZBN format
  const isValidNzbn = NZBN_REGEX.test(businessId);

  if (looksLikeOrgId) {
    return NextResponse.json(
      {
        verified: false,
        error: "Organization ID lookups are not supported. Please use NZBN or business name.",
        migration: {
          message: "This endpoint has been deprecated to prevent enumeration attacks.",
          newEndpoint: "/api/public/verify",
          examples: [
            "GET /api/public/verify?nzbn=9429041234567",
            "GET /api/public/verify?name=Example%20Roofing%20Ltd"
          ],
          documentation: "https://portal.ranz.org.nz/api-docs"
        }
      },
      {
        status: 400,
        headers: {
          "Access-Control-Allow-Origin": "*",
        }
      }
    );
  }

  // If it's a valid NZBN, tell them to use the new endpoint
  if (isValidNzbn) {
    return NextResponse.json(
      {
        verified: false,
        error: "Please use the query parameter format for NZBN lookups.",
        redirect: `/api/public/verify?nzbn=${businessId}`,
        migration: {
          message: "Path-based lookups are deprecated. Use query parameters instead.",
          example: `GET /api/public/verify?nzbn=${businessId}`
        }
      },
      {
        status: 400,
        headers: {
          "Access-Control-Allow-Origin": "*",
        }
      }
    );
  }

  // For anything else, return a generic deprecation message
  return NextResponse.json(
    {
      verified: false,
      error: "This endpoint format is deprecated.",
      migration: {
        message: "Please use the new query parameter format.",
        newEndpoint: "/api/public/verify",
        examples: [
          "GET /api/public/verify?nzbn=9429041234567",
          "GET /api/public/verify?name=Example%20Roofing%20Ltd"
        ]
      }
    },
    {
      status: 400,
      headers: {
        "Access-Control-Allow-Origin": "*",
      }
    }
  );
}

export async function OPTIONS() {
  return new NextResponse(null, {
    status: 204,
    headers: {
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Methods": "GET, OPTIONS",
      "Access-Control-Allow-Headers": "Content-Type",
    },
  });
}
```

Key changes:
1. No longer queries the database - always returns 400
2. Detects CUID-format organization IDs and provides specific error
3. Detects valid NZBN format and redirects to new endpoint format
4. Provides clear migration examples in all error responses
5. Maintains CORS headers for public API access
  </action>
  <verify>Test the deprecated endpoint:
```bash
# Test with fake org ID (should return 400 with migration info)
curl -s "http://localhost:3000/api/public/verify/clx123abc456def789" | jq .

# Test with valid NZBN format (should return 400 directing to query params)
curl -s "http://localhost:3000/api/public/verify/9429041234567" | jq .
```
Both should return 400 with helpful migration instructions.</verify>
  <done>Legacy endpoint returns 400 with clear migration instructions for all requests</done>
</task>

</tasks>

<verification>
After task completes:

1. Legacy endpoint file updated:
```bash
grep -c "deprecated\|enumeration" src/app/api/public/verify/\[businessId\]/route.ts
```
Should show multiple matches (the deprecation comments and error messages).

2. No database imports in legacy file:
```bash
grep "from.*@/lib/db" src/app/api/public/verify/\[businessId\]/route.ts
```
Should show no matches (we removed database access).

3. TypeScript compiles:
```bash
npx tsc --noEmit --skipLibCheck 2>&1 | head -20
```
</verification>

<success_criteria>
- [ ] Legacy endpoint at /api/public/verify/[businessId] returns 400 for all requests
- [ ] Error response includes migration.newEndpoint pointing to /api/public/verify
- [ ] Error response includes example query parameter formats
- [ ] CUID-format IDs get specific "enumeration attack" explanation
- [ ] Valid NZBN format gets redirect suggestion to new endpoint
- [ ] CORS headers maintained for public API compatibility
</success_criteria>

<output>
After completion, create `.planning/phases/04-public-api-hardening/04-02-SUMMARY.md`
</output>
