---
phase: 15-team-composition
plan: 03
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/components/dashboard/team-summary.tsx
  - src/app/(dashboard)/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard shows a team composition summary card"
    - "Summary displays the number of teams and total members"
    - "Summary shows qualified-to-apprentice ratio for each team"
    - "Summary highlights teams with composition warnings"
  artifacts:
    - path: "src/components/dashboard/team-summary.tsx"
      provides: "TeamSummary component displaying team composition overview"
      min_lines: 50
    - path: "src/app/(dashboard)/dashboard/page.tsx"
      provides: "Dashboard page with TeamSummary integrated"
      contains: "TeamSummary"
  key_links:
    - from: "src/app/(dashboard)/dashboard/page.tsx"
      to: "src/components/dashboard/team-summary.tsx"
      via: "React component import and render"
      pattern: "import.*TeamSummary"
    - from: "src/app/(dashboard)/dashboard/page.tsx"
      to: "prisma.team"
      via: "Server component data fetch in page"
      pattern: "db\\.team\\."
---

<objective>
Add a team composition summary component to the organization dashboard.

Purpose: Gives org admins an at-a-glance view of their team composition, ratio indicators, and any warning flags -- completing the TEAM-06 requirement. This sits alongside existing dashboard cards (compliance, stats, programme badge).

Output: Dashboard shows a TeamSummary card with team counts, member roles, ratio indicators, and warning highlights.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-team-composition/15-01-SUMMARY.md

@src/app/(dashboard)/dashboard/page.tsx
@src/components/dashboard/programme-badge.tsx (reference for dashboard component pattern)
@src/components/dashboard/stats-cards.tsx (reference for dashboard component pattern)
@prisma/schema.prisma
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TeamSummary dashboard component</name>
  <files>src/components/dashboard/team-summary.tsx</files>
  <action>
  Create a Server Component (NOT "use client") at src/components/dashboard/team-summary.tsx.

  The component receives pre-fetched team data as props (data is queried in the dashboard page, not in this component):

  ```typescript
  interface TeamSummaryData {
    totalTeams: number;
    totalMembers: number;
    teams: Array<{
      id: string;
      name: string;
      memberCount: number;
      qualifiedCount: number;
      advancingCount: number;
      apprenticeCount: number;
      hasQualifiedRoofer: boolean;
      hasDesignatedLead: boolean;
      projectLinked: boolean;
    }>;
  }

  export function TeamSummary({ data }: { data: TeamSummaryData | null }) {
  ```

  **Rendering:**

  If `data` is null or totalTeams is 0, render a subtle empty state card:
  - "No teams created yet" with a link to /teams to create one
  - Use same card styling as other dashboard components

  If teams exist, render a card with:

  1. **Header**: "Team Composition" with UsersRound icon, total teams count, total members count

  2. **Per-team rows** (max 5 teams shown, with "View all {n} teams" link to /teams if more):
     Each row shows:
     - Team name (as a link to /teams/{id})
     - Role breakdown as small inline badges: "{n} QR" (green), "{n} AR" (blue), "{n} App" (yellow)
     - Ratio indicator: Show the qualified-to-apprentice ratio as "Q:A = {qualified}:{apprentice}"
       - If ratio is healthy (at least 1 qualified per 2 apprentices or no apprentices), show in green
       - If ratio is unhealthy (more than 2 apprentices per qualified roofer), show in amber/yellow
       - If no qualified roofers at all but has apprentices, show in red
     - Warning dot: small red/amber dot if hasQualifiedRoofer is false OR hasDesignatedLead is false

  3. **Summary footer**:
     - Total across all teams: "{n} Qualified, {n} Advancing, {n} Apprentice"
     - Count of teams with warnings (if any): "{n} team(s) need attention" in amber text

  **Styling:**
  - Use Card, CardContent, CardHeader, CardTitle from @/components/ui/card
  - Use Badge from @/components/ui/badge
  - Follow the visual style of existing dashboard components (StatsCards, DimensionIndicators)
  - Import TEAM_ROLE_LABELS from @/types
  - Use Link from next/link for team name links
  - Use UsersRound from lucide-react for the header icon
  - Use AlertTriangle from lucide-react for warning indicators
  </action>
  <verify>
  Run `npx tsc --noEmit` -- component type-checks correctly.
  Visually inspect: component renders with provided data (will verify in Task 2 integration).
  </verify>
  <done>
  TeamSummary component renders team composition overview with per-team role breakdowns, ratio indicators, and warning highlights. Handles empty state gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate TeamSummary into dashboard page</name>
  <files>src/app/(dashboard)/dashboard/page.tsx</files>
  <action>
  Modify the existing dashboard page (Server Component) to fetch team data and render the TeamSummary component.

  **Data fetching additions** (add to the existing organization query or as a separate query):

  After the existing organization fetch, add a team composition query:

  ```typescript
  const teams = await db.team.findMany({
    where: { organizationId: organization.id },
    include: {
      members: {
        select: { role: true, isLead: true },
      },
      project: {
        select: { id: true },
      },
    },
    orderBy: { name: "asc" },
  });
  ```

  Transform the query result into TeamSummaryData:

  ```typescript
  const teamSummaryData = {
    totalTeams: teams.length,
    totalMembers: teams.reduce((sum, t) => sum + t.members.length, 0),
    teams: teams.map((t) => ({
      id: t.id,
      name: t.name,
      memberCount: t.members.length,
      qualifiedCount: t.members.filter((m) => m.role === "QUALIFIED_ROOFER").length,
      advancingCount: t.members.filter((m) => m.role === "ADVANCING_ROOFER").length,
      apprenticeCount: t.members.filter((m) => m.role === "APPRENTICE").length,
      hasQualifiedRoofer: t.members.some((m) => m.role === "QUALIFIED_ROOFER"),
      hasDesignatedLead: t.members.some((m) => m.isLead),
      projectLinked: !!t.project,
    })),
  };
  ```

  **Render placement:**

  Add the TeamSummary component AFTER the ActionItems section at the bottom of the dashboard (it's supplementary info, not primary):

  ```tsx
  import { TeamSummary } from "@/components/dashboard/team-summary";

  // ... existing JSX ...
  <ActionItems items={actionItems} />

  <TeamSummary data={teamSummaryData} />
  ```

  If the org has no teams (totalTeams === 0), pass `null` to hide it entirely (don't clutter the dashboard for orgs that haven't started using teams). Actually, pass the data object regardless -- the component handles the empty/null state internally with a subtle prompt.

  Wait -- reconsider: orgs that haven't adopted team tracking shouldn't see anything. Only show TeamSummary if org has at least 1 team. Pass `null` when totalTeams === 0:

  ```tsx
  <TeamSummary data={teamSummaryData.totalTeams > 0 ? teamSummaryData : null} />
  ```

  Actually, keep it simpler: always render the component, but inside TeamSummary, if data is null or totalTeams is 0, return null (render nothing). This keeps the dashboard page clean.
  </action>
  <verify>
  1. `npx tsc --noEmit` passes
  2. Dashboard page loads without errors
  3. If org has no teams: no team summary section visible (clean)
  4. If org has teams: team summary card appears showing team names, role counts, ratio indicators
  5. Teams with warnings show warning indicators
  6. Team names link to /teams/{id}
  7. Existing dashboard components (ProgrammeBadge, StatsCards, etc.) still render correctly
  </verify>
  <done>
  Dashboard page fetches team data and renders TeamSummary component. Shows team composition with role breakdowns and ratio indicators for orgs with teams. Hidden for orgs without teams.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Dashboard loads correctly for org with no teams (no team section visible)
3. Dashboard loads correctly for org with teams (team summary card visible)
4. Per-team role counts are accurate
5. Ratio indicators show correct qualified-to-apprentice ratios
6. Warning indicators highlight teams needing attention
7. All existing dashboard functionality unaffected
</verification>

<success_criteria>
- TeamSummary component exists and renders team composition overview
- Dashboard page integrates TeamSummary with server-side data fetching
- Per-team qualified-to-apprentice ratio indicators displayed
- Teams with composition issues highlighted with warning indicators
- No visual clutter for orgs that haven't created teams
- Existing dashboard components unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/15-team-composition/15-03-SUMMARY.md`
</output>
