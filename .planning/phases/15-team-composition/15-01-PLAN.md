---
phase: 15-team-composition
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/types/index.ts
  - src/app/api/teams/route.ts
  - src/app/(dashboard)/teams/page.tsx
  - src/components/layout/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Org admin can see a Teams page listing all their teams"
    - "Org admin can create a new named team"
    - "Teams nav item appears in the sidebar between Credentials and Help"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Team and TeamMember models with TeamRole enum"
      contains: "model Team"
    - path: "src/types/index.ts"
      provides: "TeamRole type and label exports"
      contains: "TeamRole"
    - path: "src/app/api/teams/route.ts"
      provides: "GET (list) and POST (create) team endpoints"
      exports: ["GET", "POST"]
    - path: "src/app/(dashboard)/teams/page.tsx"
      provides: "Teams list page with create form"
      min_lines: 80
    - path: "src/components/layout/sidebar.tsx"
      provides: "Teams nav item in sidebar"
      contains: "Teams"
  key_links:
    - from: "src/app/(dashboard)/teams/page.tsx"
      to: "/api/teams"
      via: "fetch calls for list and create"
      pattern: "fetch.*api/teams"
    - from: "src/app/api/teams/route.ts"
      to: "prisma.team"
      via: "database queries"
      pattern: "db\\.team\\."
---

<objective>
Create the Team and TeamMember database models, TypeScript types, Teams CRUD API, teams list page, and sidebar navigation entry.

Purpose: Establish the data foundation and primary UI for team management. This is the prerequisite for all other team composition features (member assignment, warnings, project linking, dashboard summary).

Output: Working teams list page where org admin can create named teams and see them listed. Sidebar includes a "Teams" navigation item.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@prisma/schema.prisma
@src/types/index.ts
@src/components/layout/sidebar.tsx
@src/app/api/credentials/route.ts (reference pattern for org-scoped API route)
@src/app/(dashboard)/credentials/page.tsx (reference pattern for "use client" list page)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database schema, migration, and TypeScript types</name>
  <files>prisma/schema.prisma, src/types/index.ts</files>
  <action>
  Add the following to prisma/schema.prisma:

  1. New enum `TeamRole` with values: `QUALIFIED_ROOFER`, `ADVANCING_ROOFER`, `APPRENTICE`

  2. New model `Team`:
     - `id` String @id @default(cuid())
     - `organizationId` String
     - `name` String (team name, e.g., "Team Alpha")
     - `description` String? (optional notes about the team)
     - `projectId` String? (optional link to an existing Project for TEAM-05)
     - `createdAt` DateTime @default(now())
     - `updatedAt` DateTime @updatedAt
     - Relation: `organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)`
     - Relation: `members TeamMember[]`
     - Relation: `project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)`
     - Index: `@@index([organizationId])`
     - Unique: `@@unique([organizationId, name])` (no duplicate team names per org)

  3. New model `TeamMember`:
     - `id` String @id @default(cuid())
     - `teamId` String
     - `memberId` String (references OrganizationMember.id)
     - `role` TeamRole
     - `isLead` Boolean @default(false) (designates team lead for TEAM-04 supervision check)
     - `createdAt` DateTime @default(now())
     - Relation: `team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)`
     - Relation: `member OrganizationMember @relation(fields: [memberId], references: [id], onDelete: Cascade)`
     - Unique: `@@unique([teamId, memberId])` (each staff member once per team)
     - Index: `@@index([teamId])`
     - Index: `@@index([memberId])`

  4. Add reverse relations:
     - On Organization model: add `teams Team[]` to relations
     - On OrganizationMember model: add `teamMemberships TeamMember[]` to relations
     - On Project model: add `teams Team[]` to relations (a project can have multiple teams)

  5. Run `npx prisma db push` to apply schema changes.

  6. In src/types/index.ts, add:
     - `TeamRole` type: `"QUALIFIED_ROOFER" | "ADVANCING_ROOFER" | "APPRENTICE"`
     - `TEAM_ROLE_LABELS` constant: `{ QUALIFIED_ROOFER: "Qualified Roofer", ADVANCING_ROOFER: "Advancing Roofer", APPRENTICE: "Apprentice" }`
     - These should go in a new section comment `// Team Composition Types (Phase 15)` after the Micro-Credential section.
  </action>
  <verify>
  Run `npx prisma db push` -- should succeed without errors.
  Run `npx tsc --noEmit` -- should pass typecheck (or at least no NEW errors introduced).
  Verify Team and TeamMember models exist in generated Prisma client.
  </verify>
  <done>
  Team and TeamMember models exist in schema with all fields, enums, relations, and indexes. TypeScript types exported. Database migrated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Teams API endpoints, list page, and sidebar navigation</name>
  <files>src/app/api/teams/route.ts, src/app/(dashboard)/teams/page.tsx, src/components/layout/sidebar.tsx</files>
  <action>
  **API (src/app/api/teams/route.ts):**

  Create GET and POST handlers following the pattern in src/app/api/credentials/route.ts:

  GET handler:
  - Auth check via `auth()` for orgId
  - Look up organization by clerkOrgId
  - Fetch all teams for the org with `include: { members: { include: { member: true } }, project: { select: { id: true, projectNumber: true, clientName: true } } }`
  - Order by name ascending
  - Return `{ teams: [...] }`

  POST handler:
  - Auth check
  - Parse body with Zod schema: `{ name: string (min 3, max 100), description?: string }`
  - Use `z` from `"zod/v4"` (project convention from projects/route.ts)
  - Create team linked to organization
  - Handle unique constraint violation (duplicate team name) with 409 status and friendly message
  - Return created team with 201 status

  **List Page (src/app/(dashboard)/teams/page.tsx):**

  Create a "use client" page following the credentials page pattern:
  - State: `teams` array, `loading` boolean, `creating` boolean
  - Fetch teams from `/api/teams` on mount via useEffect
  - Display a card-based list showing each team's name, member count, project link (if any)
  - Each team card should be a Link to `/teams/{team.id}` (detail page created in Plan 02)
  - Show member count with role breakdown as small badges (e.g., "2 Qualified, 1 Apprentice")
  - Include a create form at the top: input for team name, optional description textarea, submit button
  - On successful create, refresh the teams list
  - Empty state: "No teams yet. Create your first team above."
  - Use Card, CardContent, CardHeader, CardTitle from @/components/ui/card
  - Use Badge from @/components/ui/badge
  - Use Button from @/components/ui/button
  - Import `Users` icon from lucide-react for the page header
  - Use `TEAM_ROLE_LABELS` from @/types for role display

  **Sidebar (src/components/layout/sidebar.tsx):**

  Add a "Teams" navigation item to the `navigation` array. Place it after "Credentials" (last in the primary nav group, before the secondary nav). Use the `Users` icon from lucide-react (already imported) -- but since Users is already used for Staff, use `UsersRound` from lucide-react for Teams instead. Add `UsersRound` to the import.

  The entry: `{ name: "Teams", href: "/teams", icon: UsersRound }`
  </action>
  <verify>
  1. Start dev server (`pnpm dev`)
  2. Navigate to /teams -- page loads with empty state
  3. Create a team via the form -- team appears in the list
  4. Try creating a duplicate name -- error message shown
  5. Sidebar shows "Teams" nav item after "Credentials"
  6. Run `npx tsc --noEmit` -- no new type errors
  </verify>
  <done>
  Teams list page renders at /teams, teams can be created via the form, sidebar includes Teams nav item. API returns proper error for duplicate team names.
  </done>
</task>

</tasks>

<verification>
1. `npx prisma db push` succeeds
2. `npx tsc --noEmit` passes (no new errors)
3. GET /api/teams returns `{ teams: [] }` for an org with no teams
4. POST /api/teams with `{ "name": "Team Alpha" }` returns 201 with team object
5. POST /api/teams with duplicate name returns 409
6. /teams page renders correctly with created teams
7. Sidebar shows Teams item
</verification>

<success_criteria>
- Team and TeamMember models in database schema with all fields, relations, and indexes
- TeamRole enum with QUALIFIED_ROOFER, ADVANCING_ROOFER, APPRENTICE
- TypeScript TeamRole type and TEAM_ROLE_LABELS exported from src/types/index.ts
- GET /api/teams returns org-scoped teams with member counts
- POST /api/teams creates teams with validation
- /teams page lists teams and has a create form
- Sidebar includes Teams navigation item
</success_criteria>

<output>
After completion, create `.planning/phases/15-team-composition/15-01-SUMMARY.md`
</output>
