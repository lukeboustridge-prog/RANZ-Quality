---
phase: 15-team-composition
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/app/api/teams/[id]/route.ts
  - src/app/api/teams/[id]/members/route.ts
  - src/app/(dashboard)/teams/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Org admin can view a team detail page showing all assigned members with their roles"
    - "Org admin can assign staff members to a team with a role (Qualified Roofer / Advancing Roofer / Apprentice)"
    - "Org admin can remove a staff member from a team"
    - "Org admin can designate a team lead"
    - "Warning is displayed when team has no Qualified Roofer assigned"
    - "Warning is displayed when team lead lacks a supervision/mentoring qualification"
    - "Org admin can link a team to a project from the existing Project Evidence system"
    - "Org admin can unlink a team from a project"
  artifacts:
    - path: "src/app/api/teams/[id]/route.ts"
      provides: "GET (detail), PATCH (update name/description/project link), DELETE team endpoints"
      exports: ["GET", "PATCH", "DELETE"]
    - path: "src/app/api/teams/[id]/members/route.ts"
      provides: "POST (add member) and DELETE (remove member) endpoints"
      exports: ["POST", "DELETE"]
    - path: "src/app/(dashboard)/teams/[id]/page.tsx"
      provides: "Team detail page with member management, warnings, and project linking"
      min_lines: 150
  key_links:
    - from: "src/app/(dashboard)/teams/[id]/page.tsx"
      to: "/api/teams/[id]"
      via: "fetch for team detail, PATCH for update, DELETE for removal"
      pattern: "fetch.*api/teams"
    - from: "src/app/(dashboard)/teams/[id]/page.tsx"
      to: "/api/teams/[id]/members"
      via: "fetch POST to add member, DELETE to remove"
      pattern: "fetch.*api/teams.*members"
    - from: "src/app/api/teams/[id]/route.ts"
      to: "prisma.team"
      via: "database queries with member and credential includes"
      pattern: "db\\.team\\."
---

<objective>
Build the team detail page with member assignment, composition warnings, and project linking.

Purpose: This is the core functionality of Phase 15 -- the page where org admins manage their teams, see who's assigned with what role, get warned about composition issues, and link teams to projects. Covers TEAM-02, TEAM-03, TEAM-04, and TEAM-05.

Output: Fully functional team detail page at /teams/[id] with member management, computed warnings, and project linking.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-team-composition/15-01-SUMMARY.md

@prisma/schema.prisma
@src/types/index.ts
@src/app/api/teams/route.ts (from Plan 01)
@src/app/(dashboard)/teams/page.tsx (from Plan 01)
@src/app/(dashboard)/credentials/page.tsx (reference pattern for client page with API calls)
@src/app/api/credentials/route.ts (reference pattern for org-scoped API)
@src/app/api/projects/route.ts (reference for project lookup)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Team detail API and member management API</name>
  <files>src/app/api/teams/[id]/route.ts, src/app/api/teams/[id]/members/route.ts</files>
  <action>
  **Team Detail API (src/app/api/teams/[id]/route.ts):**

  GET handler:
  - Auth check (orgId from Clerk)
  - Fetch team by ID with includes:
    - `members` with nested `member` (OrganizationMember) and `member.microCredentials` with `definition`
    - `project` (select: id, projectNumber, clientName, siteAddress, status)
  - Verify the team belongs to the authenticated org (compare team.organizationId with org.id)
  - Return 404 if not found or not owned
  - Compute and return warnings array alongside team data:
    - Warning 1 (TEAM-03): Check if any TeamMember has role QUALIFIED_ROOFER. If none, add warning: `{ type: "NO_QUALIFIED_ROOFER", message: "This team has no Qualified Roofer assigned. At least one team member should hold the Qualified Roofer role." }`
    - Warning 2 (TEAM-04): Find the TeamMember where isLead is true. If a lead exists, check their member.microCredentials for any credential whose definition.title contains "Supervision" or "Mentoring" (case-insensitive) with status "AWARDED". If no such credential found, add warning: `{ type: "LEAD_NO_SUPERVISION", message: "Team lead {firstName} {lastName} does not hold a supervision/mentoring qualification. Consider assigning a qualified team lead or adding the relevant credential." }`
    - If no lead is designated at all but team has members, add info: `{ type: "NO_LEAD_DESIGNATED", message: "No team lead has been designated. Consider assigning a team lead." }`
  - Return `{ team: {...}, warnings: [...] }`

  PATCH handler:
  - Auth check, verify ownership
  - Zod schema: `{ name?: string (min 3, max 100), description?: string, projectId?: string | null }` -- all optional
  - When projectId is provided (not null), verify the project belongs to the same org
  - When projectId is explicitly null, unlink the project (set to null)
  - Update team, return updated team
  - Handle unique constraint on name with 409

  DELETE handler:
  - Auth check, verify ownership
  - Delete team (cascades to TeamMember records)
  - Return `{ success: true }`

  **Member Management API (src/app/api/teams/[id]/members/route.ts):**

  POST handler (add member):
  - Auth check, verify team ownership
  - Zod schema: `{ memberId: string, role: z.enum(["QUALIFIED_ROOFER", "ADVANCING_ROOFER", "APPRENTICE"]), isLead?: boolean }`
  - Verify memberId belongs to the same org (query OrganizationMember where id = memberId AND organizationId = org.id)
  - If isLead is true, first unset any existing lead on this team (update all TeamMembers for this team to isLead: false) before creating
  - Create TeamMember record
  - Handle unique constraint (member already in team) with 409
  - Return created TeamMember with 201

  DELETE handler (remove member):
  - Auth check, verify team ownership
  - Read `memberId` from request body or URL search params: use searchParams `?memberId=xxx`
  - Delete TeamMember where teamId + memberId match
  - Return `{ success: true }`

  PATCH handler (update member role/lead):
  - Auth check, verify team ownership
  - Zod schema: `{ memberId: string, role?: TeamRole, isLead?: boolean }`
  - If isLead is true, unset existing lead first
  - Update the TeamMember record
  - Return updated record

  Use `z` from `"zod/v4"` for validation (project convention).
  </action>
  <verify>
  Run `npx tsc --noEmit` -- no new type errors.
  Test manually or via curl:
  - GET /api/teams/{id} returns team with members and warnings
  - PATCH /api/teams/{id} with `{ "projectId": "..." }` links a project
  - POST /api/teams/{id}/members with member data returns 201
  - DELETE /api/teams/{id}/members?memberId=xxx removes member
  </verify>
  <done>
  All team detail and member management API endpoints working with proper auth, validation, org ownership checks, and computed warnings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Team detail page with members, warnings, and project linking</name>
  <files>src/app/(dashboard)/teams/[id]/page.tsx</files>
  <action>
  Create a "use client" page at src/app/(dashboard)/teams/[id]/page.tsx.

  **Page structure:**

  1. **Header section**: Team name (editable inline or via edit button), description, back link to /teams, delete team button (with window.confirm)

  2. **Warnings section** (rendered at top if any warnings exist):
     - Use a yellow/amber alert card for each warning
     - AlertTriangle icon from lucide-react
     - Show warning message text
     - For NO_QUALIFIED_ROOFER: amber background
     - For LEAD_NO_SUPERVISION: amber background
     - For NO_LEAD_DESIGNATED: blue/info background

  3. **Team Members section**:
     - Table/card list of current team members showing: Name, Org Role, Team Role (Qualified Roofer/Advancing Roofer/Apprentice), Lead badge (if isLead), Remove button
     - "Add Member" form: Select dropdown of org staff members NOT already in this team (fetch available members from the team detail response or a separate call), role select (QUALIFIED_ROOFER, ADVANCING_ROOFER, APPRENTICE), optional "Set as Lead" checkbox, Add button
     - Available members: fetch org members from `/api/teams/{id}` response (the API should include org members for the dropdown -- OR add a separate fetch to `/api/credentials` which returns all org members). Use the credentials endpoint which already returns all org members with their credentials.
     - Allow changing a member's role inline via a select dropdown (PATCH to /api/teams/{id}/members)
     - Allow toggling team lead status (PATCH to /api/teams/{id}/members)

  4. **Project Linking section** (TEAM-05):
     - If team has a linked project: show project number, client name, site address with a link to /projects/{projectId} and an "Unlink" button
     - If no project linked: show a "Link to Project" dropdown/select that fetches projects from `/api/projects` (the existing endpoint) and a "Link" button
     - On link: PATCH /api/teams/{id} with `{ projectId: selectedProjectId }`
     - On unlink: PATCH /api/teams/{id} with `{ projectId: null }`

  **Data fetching:**
  - On mount, fetch GET /api/teams/{id} for team detail (includes members, project, warnings)
  - Also fetch GET /api/credentials to get the list of all org members (for the add-member dropdown, filtering out those already in the team)
  - Also fetch GET /api/projects to get available projects for linking

  **UI patterns:**
  - Follow the credentials page pattern: "use client", useState for data/loading, useEffect for fetching
  - Use Card, CardContent, CardHeader, CardTitle from @/components/ui/card
  - Use Badge from @/components/ui/badge with role-specific colors:
    - QUALIFIED_ROOFER: green (bg-green-100 text-green-700)
    - ADVANCING_ROOFER: blue (bg-blue-100 text-blue-700)
    - APPRENTICE: yellow (bg-yellow-100 text-yellow-700)
  - Use Button from @/components/ui/button
  - Import TEAM_ROLE_LABELS from @/types for display
  - Use Loader2 for loading states, RefreshCw for refresh
  - Back link using Link from next/link to /teams
  </action>
  <verify>
  1. Navigate to /teams/{id} for an existing team -- page loads with team details
  2. Add a staff member to the team with a role -- member appears in the list
  3. Change a member's role -- updates correctly
  4. Designate a team lead -- lead badge appears
  5. Remove a member -- member disappears from list
  6. When no Qualified Roofer is assigned -- amber warning displayed
  7. When team lead lacks supervision credential -- amber warning displayed
  8. Link a project to the team -- project info displayed
  9. Unlink a project -- project section shows "Link to Project" dropdown
  10. Delete team -- redirects to /teams list
  </verify>
  <done>
  Team detail page fully functional with member management (add/remove/role change/lead designation), composition warnings (no qualified roofer, lead lacking supervision credential), and project linking/unlinking.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Create a team, add members with different roles -- all CRUD operations work
3. Team with no Qualified Roofer shows warning
4. Team lead without supervision/mentoring credential shows warning
5. Project linking and unlinking works
6. Deleting a team works and redirects properly
7. Member uniqueness enforced (can't add same person twice)
8. Lead designation automatically unsets previous lead
</verification>

<success_criteria>
- Team detail page at /teams/[id] renders team info, members, warnings, and project link
- Staff can be assigned to teams with QUALIFIED_ROOFER / ADVANCING_ROOFER / APPRENTICE roles
- Warning displayed when no Qualified Roofer is on the team (TEAM-03)
- Warning displayed when team lead lacks supervision/mentoring credential (TEAM-04)
- Teams can be linked to and unlinked from projects (TEAM-05)
- All API endpoints have proper auth, validation, and org ownership checks
</success_criteria>

<output>
After completion, create `.planning/phases/15-team-composition/15-02-SUMMARY.md`
</output>
