---
phase: 16-client-checklists
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/app/api/checklists/route.ts
  - src/app/api/checklists/[id]/route.ts
  - src/app/api/checklists/[id]/items/[itemId]/route.ts
  - src/app/(dashboard)/checklists/page.tsx
  - src/app/(dashboard)/checklists/[id]/page.tsx
  - src/components/layout/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Org admin can view available master templates and clone one as their company checklist"
    - "Org admin can customize their cloned template (add/remove/reorder sections and items)"
    - "Staff can create a checklist instance for a specific project"
    - "Staff can mark checklist items as complete and see progress update"
  artifacts:
    - path: "src/app/api/checklists/route.ts"
      provides: "Org-scoped checklist template and instance management"
      exports: ["GET", "POST"]
    - path: "src/app/api/checklists/[id]/route.ts"
      provides: "Checklist detail, customization, and instance operations"
      exports: ["GET", "PATCH", "DELETE"]
    - path: "src/app/api/checklists/[id]/items/[itemId]/route.ts"
      provides: "Item completion toggle and text/notes entry"
      exports: ["PATCH"]
    - path: "src/app/(dashboard)/checklists/page.tsx"
      provides: "Checklists list page with template management and instance creation"
      min_lines: 100
    - path: "src/app/(dashboard)/checklists/[id]/page.tsx"
      provides: "Checklist instance detail with item completion UI"
      min_lines: 150
  key_links:
    - from: "src/app/(dashboard)/checklists/page.tsx"
      to: "/api/checklists"
      via: "fetch on mount for templates and instances"
      pattern: "fetch.*api/checklists"
    - from: "src/app/(dashboard)/checklists/[id]/page.tsx"
      to: "/api/checklists/[id]/items/[itemId]"
      via: "PATCH on item completion toggle"
      pattern: "fetch.*api/checklists.*items"
    - from: "src/app/api/checklists/route.ts"
      to: "prisma.checklistTemplate"
      via: "database queries for templates and instances"
      pattern: "prisma\\.checklist(Template|Instance)\\.(find|create)"
---

<objective>
Build org-facing checklist management: template customization (clone and edit) and project checklist instances with item completion tracking.

Purpose: Org admins need to tailor the master checklist to their company's processes, and staff need to create and complete checklists for each project. This is the core workflow that makes checklists actionable.
Output: Org checklist customization page, project checklist instances with real-time completion tracking.
</objective>

<execution_context>
@C:/Users/LukeBoustridge/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LukeBoustridge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-client-checklists/16-01-SUMMARY.md

@prisma/schema.prisma
@src/types/index.ts
@src/components/layout/sidebar.tsx
@src/app/api/teams/route.ts
@src/app/(dashboard)/teams/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Org checklist template customization API and page</name>
  <files>
    src/app/api/checklists/route.ts
    src/app/(dashboard)/checklists/page.tsx
    src/components/layout/sidebar.tsx
  </files>
  <action>
**API: /api/checklists/route.ts** (org-scoped, NOT admin)
Auth pattern: Same as /api/teams -- auth(), get orgId, lookup organization by clerkOrgId.

- GET: Return two things:
  1. Available master templates (isMaster: true) -- for the "Use Template" button
  2. The org's customized templates (organizationId matches, isMaster: false) -- including full sections > items tree ordered by sortOrder
  3. Active checklist instances for the org, with completion counts

- POST with action: "clone":
  Body: { action: "clone", templateId: string }
  Clone a master template for this org:
  1. Load the master template with all sections and items
  2. Create a new ChecklistTemplate with isMaster: false, organizationId: org.id, sourceTemplateId: templateId, title: master.title + " (Company)", isDefault: false
  3. Deep-copy all sections and items (new IDs, preserving sortOrder, title, description, itemType, isRequired)
  4. Return the new template
  5. Guard: only one clone per master template per org (check existing before cloning, return 409 if exists)

- POST with action: "add-section":
  Body: { action: "add-section", templateId: string, title: string, description?: string }
  Add a section to an org-owned template. Verify template belongs to this org and is not a master template. Auto-set sortOrder to max+1.

- POST with action: "add-item":
  Body: { action: "add-item", sectionId: string, title: string, description?: string, itemType?: string, isRequired?: boolean }
  Add an item to a section. Verify the section's template belongs to this org. Auto-set sortOrder to max+1.

- PATCH: Update section or item on org template
  Body: { action: "update-section", sectionId, title?, description?, sortOrder? } OR { action: "update-item", itemId, title?, description?, itemType?, isRequired?, sortOrder? }
  Verify ownership.

- DELETE: Remove section or item from org template
  searchParams: action=delete-section&sectionId=xxx OR action=delete-item&itemId=xxx
  Verify ownership. Cascade handled by Prisma.

**Dashboard Page: /checklists/page.tsx**
"use client" page. Two tabs or sections:

1. "Templates" section:
   - Shows the org's customized template(s) if any
   - If no template yet: show available master templates with a "Use This Template" button that clones it
   - If template exists: show sections and items in an accordion/expandable view
   - Org admin can add/edit/remove sections and items (inline editing like admin page)
   - Show a "Reset to Default" option that deletes the org template (they can re-clone)

2. "Project Checklists" section:
   - Lists active checklist instances with: project name, template name, completion percentage (completedItems/totalItems), started date, link to detail page
   - "Start Checklist" button: select a project (from /api/projects) and template, creates a ChecklistInstance
   - Link to /checklists/[instanceId] for the detail view

**Sidebar: src/components/layout/sidebar.tsx**
Add "Checklists" nav item after "Teams" in the navigation array. Use ClipboardList icon from lucide-react. Href: "/checklists".
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Dev server runs without errors
3. Navigate to /checklists -- shows available master template(s) with "Use This Template" button
4. Clone a template -- org-specific copy appears with all sections and items
5. Can add/edit/remove sections and items on the cloned template
6. Sidebar shows "Checklists" link after Teams
  </verify>
  <done>
Org admin can clone a master template, customize sections and items (add/remove/reorder), and see their company's checklist template. Sidebar nav updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Project checklist instance creation and item completion</name>
  <files>
    src/app/api/checklists/[id]/route.ts
    src/app/api/checklists/[id]/items/[itemId]/route.ts
    src/app/(dashboard)/checklists/[id]/page.tsx
  </files>
  <action>
**API: /api/checklists/[id]/route.ts** (instance detail)
Auth: Same org-scoped pattern.

- GET: Return the checklist instance with:
  - Instance metadata (startedAt, completedAt, project info)
  - Full template tree: sections > items, each item with its completion record (if exists)
  - Completion stats: { totalItems, completedItems, requiredItems, completedRequired, percentage }
  - Verify instance belongs to the authenticated org

- POST: Create a new checklist instance (called from the list page)
  Body: { templateId: string, projectId: string }
  1. Verify template belongs to this org (or is a master template -- orgs without a custom template can use master directly)
  2. Verify project belongs to this org
  3. Check unique constraint (one instance per template per project)
  4. Create ChecklistInstance with createdBy = userId
  5. Pre-create ChecklistItemCompletion records for ALL items in the template (completed: false). This ensures every item has a completion record from the start, making progress tracking simple.
  6. Return the new instance with its ID

- PATCH: Mark instance as completed
  Body: { action: "complete" }
  Check all required items are completed. If yes, set completedAt to now(). If not, return 400 with list of incomplete required items.

- DELETE: Delete a checklist instance (soft or hard -- use hard delete since instances are operational, not audit records)
  Verify ownership. Cascade deletes completions.

**API: /api/checklists/[id]/items/[itemId]/route.ts** (item completion)
Auth: Verify the item's instance belongs to this org.

- PATCH: Toggle/update completion
  Body: { completed?: boolean, textValue?: string, notes?: string }
  1. Find or create the ChecklistItemCompletion record (upsert by instanceId + itemId)
  2. If completed = true, set completedAt and completedBy
  3. If completed = false, clear completedAt and completedBy
  4. Update textValue and notes if provided
  5. Check if all required items are now completed -- if so, auto-set instance.completedAt
  6. If instance was complete but an item is now uncompleted, clear instance.completedAt
  7. Return updated completion record + instance completion stats

**Detail Page: /checklists/[id]/page.tsx**
"use client" page. Shows a single checklist instance:

- Header: Project name, template name, started date, completion percentage bar
- If completedAt is set, show "Completed on [date]" badge
- Sections rendered as collapsible cards (all expanded by default)
- Each item shows:
  - Checkbox for CHECKBOX type (toggle sends PATCH to completion endpoint)
  - Text input for TEXT_INPUT type (debounced save on blur)
  - Photo upload placeholder for PHOTO_REQUIRED type (actual upload in Plan 03)
  - Signature placeholder for SIGNATURE type (just a checkbox for now, can be enhanced later)
  - Required indicator (red asterisk or "Required" badge)
  - Notes field (expandable textarea, saves on blur)
  - Completion timestamp and who completed it
- Progress bar updates in real-time as items are checked
- "Mark Complete" button at bottom (only enabled when all required items done) -- calls PATCH with action: "complete"
- Back link to /checklists
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. From /checklists page, start a new checklist for a project
3. Navigate to /checklists/[id] -- see all sections and items
4. Check off items -- progress bar updates, completion timestamp appears
5. Enter text values for TEXT_INPUT items -- saves on blur
6. Add notes to items -- saves on blur
7. Mark checklist as complete when all required items are done
8. Cannot mark complete with required items outstanding (400 error with list)
  </verify>
  <done>
Staff can create checklist instances for projects, mark items complete, enter text values and notes, and see real-time progress. Instances auto-complete when all required items are checked. CHKL-03 and CHKL-04 satisfied.
  </done>
</task>

</tasks>

<verification>
1. Org admin can clone master template and customize it (CHKL-03)
2. Staff can create checklist instances for projects (CHKL-04)
3. Items can be checked off with progress tracking (CHKL-04)
4. One checklist instance per template per project enforced
5. Completion percentage calculated correctly (completed/total items)
6. TypeScript compiles cleanly
</verification>

<success_criteria>
- CHKL-03 satisfied: Org admin can customize their company checklist template
- CHKL-04 satisfied: Staff can create a checklist instance for a project and complete items as work progresses
- Foundation ready for CHKL-05 (photo evidence), CHKL-06 (dashboard), and CHKL-07 (PDF generation)
</success_criteria>

<output>
After completion, create `.planning/phases/16-client-checklists/16-02-SUMMARY.md`
</output>
