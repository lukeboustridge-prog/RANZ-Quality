---
phase: 16-client-checklists
plan: 03
type: execute
wave: 3
depends_on: ["16-02"]
files_modified:
  - src/app/api/checklists/[id]/items/[itemId]/evidence/route.ts
  - src/app/(dashboard)/checklists/[id]/page.tsx
  - src/app/(dashboard)/dashboard/page.tsx
  - src/components/dashboard/checklist-summary.tsx
  - src/components/reports/pdf/procedure-document.tsx
  - src/app/api/checklists/[id]/pdf/route.ts
autonomous: true

must_haves:
  truths:
    - "Staff can upload a photo to a checklist item and see it displayed"
    - "Dashboard shows checklist completion percentage for each project"
    - "Completed checklists can generate a procedure document PDF"
    - "Generated PDF references ISO Element 12 (Process Control)"
  artifacts:
    - path: "src/app/api/checklists/[id]/items/[itemId]/evidence/route.ts"
      provides: "Photo upload and download for checklist items"
      exports: ["POST", "GET"]
    - path: "src/components/dashboard/checklist-summary.tsx"
      provides: "Dashboard widget showing checklist progress per project"
      min_lines: 40
    - path: "src/components/reports/pdf/procedure-document.tsx"
      provides: "React-PDF document component for procedure documents"
      min_lines: 100
    - path: "src/app/api/checklists/[id]/pdf/route.ts"
      provides: "PDF generation endpoint for completed checklists"
      exports: ["GET"]
  key_links:
    - from: "src/app/(dashboard)/checklists/[id]/page.tsx"
      to: "/api/checklists/[id]/items/[itemId]/evidence"
      via: "FormData POST for photo upload"
      pattern: "fetch.*evidence"
    - from: "src/app/(dashboard)/dashboard/page.tsx"
      to: "src/components/dashboard/checklist-summary.tsx"
      via: "Server Component rendering ChecklistSummary"
      pattern: "ChecklistSummary"
    - from: "src/app/api/checklists/[id]/pdf/route.ts"
      to: "src/components/reports/pdf/procedure-document.tsx"
      via: "renderToBuffer for PDF generation"
      pattern: "renderToBuffer.*ProcedureDocument"
---

<objective>
Add photo evidence uploads for checklist items, dashboard completion summary, and procedure document PDF generation linked to ISO Element 12.

Purpose: Completes the checklist feature set. Photo evidence provides proof of work, dashboard visibility drives usage, and the procedure document ties the operational checklist back to the ISO quality management system.
Output: Photo upload endpoint, dashboard checklist widget, and PDF generation for completed checklists.
</objective>

<execution_context>
@C:/Users/LukeBoustridge/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LukeBoustridge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-client-checklists/16-01-SUMMARY.md
@.planning/phases/16-client-checklists/16-02-SUMMARY.md

@src/lib/r2.ts
@src/app/api/credentials/[id]/evidence/route.ts
@src/app/(dashboard)/dashboard/page.tsx
@src/components/reports/pdf/compliance-report.tsx
@src/app/api/admin/reports/organization/[orgId]/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Photo evidence upload for checklist items and dashboard completion summary</name>
  <files>
    src/app/api/checklists/[id]/items/[itemId]/evidence/route.ts
    src/app/(dashboard)/checklists/[id]/page.tsx
    src/app/(dashboard)/dashboard/page.tsx
    src/components/dashboard/checklist-summary.tsx
  </files>
  <action>
**Photo Evidence API: /api/checklists/[id]/items/[itemId]/evidence/route.ts**
Follow the exact pattern from /api/credentials/[id]/evidence/route.ts:

- POST: Upload photo evidence
  1. Auth check (userId, orgId)
  2. Verify the checklist instance [id] belongs to this org
  3. Verify the item [itemId] belongs to this instance's template
  4. Accept FormData with "file" field
  5. Validate file: max size MAX_FILE_SIZE_BYTES, allowed types: image/jpeg, image/png, image/webp
  6. Upload to R2 with key: `checklists/{orgId}/{instanceId}/{itemId}/{Date.now()}-{fileName}`
  7. Update the ChecklistItemCompletion record: set photoKey, photoFileName. Also set completed=true, completedAt=now(), completedBy=userId (uploading a photo to a PHOTO_REQUIRED item counts as completing it)
  8. Return { success: true, fileName, storageKey }

- GET: Download photo evidence
  1. Auth check
  2. Verify ownership
  3. Look up ChecklistItemCompletion for this instance+item
  4. If no photoKey, return 404
  5. Return signed download URL via getSignedDownloadUrl()

**Update Checklist Detail Page: /checklists/[id]/page.tsx**
Enhance the PHOTO_REQUIRED item rendering (which was a placeholder in Plan 02):
- Show an upload button (styled file input) when no photo uploaded
- On file select, POST to /api/checklists/[id]/items/[itemId]/evidence as FormData
- After upload, show the photo thumbnail (use the GET endpoint for signed URL)
- Show file name and upload timestamp
- Allow re-upload (replaces existing photo)
- Also allow photo upload on CHECKBOX items optionally (the upload button appears but is not required)

**Dashboard Checklist Summary: src/components/dashboard/checklist-summary.tsx**
Create a new dashboard component (following TeamSummary pattern):

Props: `{ data: ChecklistSummaryData | null }` where ChecklistSummaryData = {
  activeChecklists: number,
  completedChecklists: number,
  checklists: Array<{
    id: string,
    projectName: string,
    templateName: string,
    percentage: number,
    completedItems: number,
    totalItems: number,
    isComplete: boolean,
    startedAt: string,
  }>
}

Render:
- Card with "Checklist Progress" title and ClipboardCheck icon
- If data is null, render nothing (return null) -- same pattern as TeamSummary
- Summary stats: "{active} active, {completed} completed"
- List of up to 5 checklists with:
  - Project name (linked to /checklists/[id])
  - Progress bar (% filled, green when complete, blue when in progress)
  - "{completedItems}/{totalItems} items" text
  - "Complete" badge in green if isComplete
- "View all checklists" link to /checklists if more than 5

**Dashboard Page: src/app/(dashboard)/dashboard/page.tsx**
Add checklist data fetching and render ChecklistSummary:

1. After the teams query, add a query for checklist instances:
```
const checklistInstances = await db.checklistInstance.findMany({
  where: { organizationId: organization.id },
  include: {
    template: { select: { title: true } },
    project: { select: { clientName: true, projectNumber: true } },
    completions: { select: { completed: true, item: { select: { isRequired: true } } } },
  },
  orderBy: { startedAt: "desc" },
});
```

2. Compute summary data:
```
const checklistSummaryData = {
  activeChecklists: checklistInstances.filter(ci => !ci.completedAt).length,
  completedChecklists: checklistInstances.filter(ci => ci.completedAt).length,
  checklists: checklistInstances.map(ci => ({
    id: ci.id,
    projectName: `${ci.project.projectNumber} - ${ci.project.clientName}`,
    templateName: ci.template.title,
    percentage: ci.completions.length > 0 ? Math.round((ci.completions.filter(c => c.completed).length / ci.completions.length) * 100) : 0,
    completedItems: ci.completions.filter(c => c.completed).length,
    totalItems: ci.completions.length,
    isComplete: !!ci.completedAt,
    startedAt: ci.startedAt.toISOString(),
  })),
};
```

3. Render ChecklistSummary after TeamSummary:
```
<ChecklistSummary data={checklistSummaryData.checklists.length > 0 ? checklistSummaryData : null} />
```

Import ChecklistSummary from "@/components/dashboard/checklist-summary".
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Navigate to a checklist instance, upload a photo to a PHOTO_REQUIRED item
3. Photo thumbnail displays after upload
4. Photo download works (signed URL)
5. Dashboard shows ChecklistSummary widget with active checklists and progress bars
6. Projects with no checklists show nothing (null data pattern)
  </verify>
  <done>
Staff can upload photo evidence to checklist items via R2. Dashboard displays checklist completion percentage per project with progress bars. CHKL-05 and CHKL-06 satisfied.
  </done>
</task>

<task type="auto">
  <name>Task 2: Procedure document PDF generation linked to ISO Element 12</name>
  <files>
    src/components/reports/pdf/procedure-document.tsx
    src/app/api/checklists/[id]/pdf/route.ts
    src/app/(dashboard)/checklists/[id]/page.tsx
  </files>
  <action>
**PDF Component: src/components/reports/pdf/procedure-document.tsx**
Follow the pattern from src/components/reports/pdf/compliance-report.tsx:

Import { Document, Page, Text, View, StyleSheet } from "@react-pdf/renderer".

Create ProcedureDocumentPDF component that accepts:
```typescript
interface ProcedureDocumentProps {
  organization: { name: string; tradingName?: string | null; nzbn?: string | null };
  template: { title: string; description?: string | null };
  instance: { startedAt: Date; completedAt: Date | null; createdBy: string };
  sections: Array<{
    title: string;
    description?: string | null;
    items: Array<{
      title: string;
      description?: string | null;
      itemType: string;
      isRequired: boolean;
      completed: boolean;
      textValue?: string | null;
      notes?: string | null;
      completedAt?: Date | null;
      completedBy?: string | null;
      hasPhoto: boolean;
    }>;
  }>;
  project: { projectNumber: string; clientName: string; siteAddress: string; startDate: Date; completionDate?: Date | null };
  completionStats: { totalItems: number; completedItems: number; percentage: number };
}
```

PDF layout:
- **Page 1 - Cover:**
  - RANZ logo text header (same style as compliance report)
  - "Company Procedure Document" title
  - "Process Control — ISO Element 12" subtitle
  - Organization name, trading name, NZBN
  - Project details: number, client, site address, dates
  - Checklist: template title, started/completed dates
  - Completion: "{percentage}% — {completedItems}/{totalItems} items completed"
  - Generated date and reference

- **Subsequent pages - Sections:**
  - For each section:
    - Section title (bold, underlined)
    - Section description if present
    - Table with columns: #, Item, Type, Required, Status, Completed By, Date, Notes
    - Each item as a row:
      - Sequential number
      - Item title
      - Item type label (Checkbox, Text Input, Photo Required, Signature)
      - Required: Yes/No
      - Status: checkmark icon text "[X]" or "[ ]"
      - Completed by (user ID or "—")
      - Date (formatted or "—")
      - Notes/text value if present
    - For TEXT_INPUT items, show the text value in the Notes column
    - For PHOTO_REQUIRED items, note "Photo attached" or "No photo" in Notes column

- **Final section - ISO Compliance Statement:**
  - "ISO Element 12 — Process Control"
  - "This document demonstrates that {organization.name} maintains documented procedures for client project processes as required by the RANZ Certified Business Programme quality management system."
  - "The procedures documented herein cover the complete client engagement lifecycle and are maintained through the RANZ Quality Programme Portal."
  - Date stamp and reference number

Styles: Match the compliance-report.tsx style conventions (page padding 40, fontSize 10, Helvetica, section headers, table rows with borders).

**PDF Generation API: /api/checklists/[id]/pdf/route.ts**
- GET: Generate and return PDF
  1. Auth check (userId, orgId)
  2. Load checklist instance with full data:
     - Instance with template (title, description), project (all details), organization (name, tradingName, nzbn)
     - All template sections ordered by sortOrder
     - All items per section ordered by sortOrder
     - All completion records for this instance
  3. Verify ownership (instance.organization.clerkOrgId === orgId)
  4. Verify instance is completed (completedAt is not null). If not completed, return 400: "Checklist must be completed before generating a procedure document"
  5. Assemble the props object for ProcedureDocumentPDF
  6. Call renderToBuffer(<ProcedureDocumentPDF {...props} />)
  7. Return the PDF as response:
     ```
     return new Response(buffer, {
       headers: {
         "Content-Type": "application/pdf",
         "Content-Disposition": `inline; filename="procedure-${instance.project.projectNumber}-${Date.now()}.pdf"`,
       },
     });
     ```

**Update Checklist Detail Page: /checklists/[id]/page.tsx**
Add a "Download Procedure Document" button that appears ONLY when the checklist is completed (completedAt is not null):
- Button styled with FileText icon and "Generate Procedure Document" text
- On click: `window.open(\`/api/checklists/${id}/pdf\`, "_blank")` to open PDF in new tab
- Add a note below the button: "This document is linked to ISO Element 12 (Process Control) and can be uploaded to your Documents section."
- Position the button in the header area next to the completion badge
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Complete a checklist instance (all required items checked)
3. Click "Generate Procedure Document" button
4. PDF opens in new tab with correct layout: cover page with org/project details, sections with items and completion status, ISO Element 12 compliance statement
5. Incomplete checklist instances do NOT show the PDF button
6. API returns 400 if checklist is not completed
  </verify>
  <done>
Completed checklists generate a procedure document PDF with full section/item breakdown, completion details, and ISO Element 12 (Process Control) compliance statement. PDF downloads in browser. CHKL-07 satisfied.
  </done>
</task>

</tasks>

<verification>
1. Photo upload works for checklist items (R2 storage, signed download URLs)
2. Dashboard shows checklist completion percentage per project with progress bars
3. Procedure document PDF generates for completed checklists
4. PDF contains ISO Element 12 reference and full completion details
5. All 7 CHKL requirements satisfied across plans 01-03
6. TypeScript compiles cleanly
</verification>

<success_criteria>
- CHKL-05 satisfied: Staff can attach photo evidence to individual checklist items
- CHKL-06 satisfied: Dashboard shows checklist completion percentage per project
- CHKL-07 satisfied: Completed checklists generate a company procedure document linked to ISO Element 12
- Phase 16 complete: All 7 requirements fulfilled
</success_criteria>

<output>
After completion, create `.planning/phases/16-client-checklists/16-03-SUMMARY.md`
</output>
