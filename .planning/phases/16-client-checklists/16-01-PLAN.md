---
phase: 16-client-checklists
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/types/index.ts
  - src/app/api/admin/checklists/route.ts
  - src/app/api/admin/checklists/[id]/route.ts
  - src/app/api/admin/checklists/[id]/sections/route.ts
  - src/app/api/admin/checklists/[id]/sections/[sectionId]/items/route.ts
  - src/app/(admin)/admin/checklists/page.tsx
  - src/app/(admin)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "RANZ admin can create a new checklist template with a title and description"
    - "RANZ admin can add sections to a template and items to sections"
    - "RANZ admin can edit and delete templates, sections, and items"
    - "Portal ships with a default RoofWright client process checklist with 5 sections pre-populated"
    - "Default checklist is protected from deletion"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "ChecklistTemplate, ChecklistSection, ChecklistItem, ChecklistInstance, ChecklistItemCompletion models"
      contains: "model ChecklistTemplate"
    - path: "src/types/index.ts"
      provides: "ChecklistItemType type and labels"
      contains: "CHECKLIST_ITEM_TYPE_LABELS"
    - path: "src/app/api/admin/checklists/route.ts"
      provides: "Admin template CRUD with auto-seed"
      exports: ["GET", "POST"]
    - path: "src/app/(admin)/admin/checklists/page.tsx"
      provides: "Admin checklist management page"
      min_lines: 100
  key_links:
    - from: "src/app/(admin)/admin/checklists/page.tsx"
      to: "/api/admin/checklists"
      via: "fetch on mount and form submissions"
      pattern: "fetch.*api/admin/checklists"
    - from: "src/app/api/admin/checklists/route.ts"
      to: "prisma.checklistTemplate"
      via: "database queries"
      pattern: "prisma\\.checklistTemplate\\.(findMany|create)"
---

<objective>
Create the checklist data model, RANZ admin template management, and seed the default RoofWright client process checklist.

Purpose: Establishes the foundation for the entire checklist feature. Templates define the structure (sections and items) that organizations clone and staff instantiate against projects. The default checklist seeds the RoofWright-specific process.
Output: Prisma models for the full checklist hierarchy (Template > Section > Item > Instance > Completion), admin CRUD page, and auto-seeded default checklist.
</objective>

<execution_context>
@C:/Users/LukeBoustridge/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LukeBoustridge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@prisma/schema.prisma
@src/types/index.ts
@src/app/(admin)/layout.tsx
@src/app/api/admin/micro-credentials/route.ts
@src/app/(admin)/admin/micro-credentials/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prisma schema for checklist hierarchy and TypeScript types</name>
  <files>
    prisma/schema.prisma
    src/types/index.ts
  </files>
  <action>
Add the following models to prisma/schema.prisma in a new section "// ============================================================================ // Client Process Checklists // ============================================================================" after the Team/TeamMember section:

**ChecklistTemplate model:**
- id: String @id @default(cuid())
- title: String (e.g. "RoofWright Client Process Checklist")
- description: String?
- isDefault: Boolean @default(false) -- protects system defaults from deletion
- isMaster: Boolean @default(true) -- true for RANZ-created templates, false for org customizations
- organizationId: String? -- null for master templates, set for org-specific customizations
- sourceTemplateId: String? -- references the master template this was cloned from
- createdAt, updatedAt
- Relations: sections ChecklistSection[], instances ChecklistInstance[], organization Organization? (optional), sourceTemplate ChecklistTemplate? (self-relation for clone tracking)
- Add reverse relation: customizations ChecklistTemplate[] @relation("ChecklistTemplateClone")
- @@index([organizationId])
- @@index([isMaster])

**ChecklistSection model:**
- id: String @id @default(cuid())
- templateId: String
- title: String (e.g. "Initial Contact", "Quoting", etc.)
- description: String?
- sortOrder: Int @default(0) -- for drag-reorder
- createdAt, updatedAt
- Relations: template ChecklistTemplate, items ChecklistItem[]
- @@index([templateId])

**ChecklistItem model:**
- id: String @id @default(cuid())
- sectionId: String
- title: String (e.g. "Confirm client contact details")
- description: String? (extended guidance/instructions)
- itemType: ChecklistItemType @default(CHECKBOX) -- CHECKBOX, TEXT_INPUT, PHOTO_REQUIRED, SIGNATURE
- isRequired: Boolean @default(true)
- sortOrder: Int @default(0)
- createdAt, updatedAt
- Relations: section ChecklistSection, completions ChecklistItemCompletion[]
- @@index([sectionId])

**ChecklistInstance model:**
- id: String @id @default(cuid())
- templateId: String
- projectId: String
- organizationId: String
- startedAt: DateTime @default(now())
- completedAt: DateTime? -- set when all required items are completed
- createdBy: String -- clerkUserId who started the checklist
- createdAt, updatedAt
- Relations: template ChecklistTemplate, project Project, organization Organization, completions ChecklistItemCompletion[]
- @@unique([templateId, projectId]) -- one checklist instance per template per project
- @@index([organizationId])
- @@index([projectId])

**ChecklistItemCompletion model:**
- id: String @id @default(cuid())
- instanceId: String
- itemId: String
- completed: Boolean @default(false)
- textValue: String? -- for TEXT_INPUT items
- notes: String? -- optional notes on any item
- photoKey: String? -- R2 storage key for photo evidence
- photoFileName: String?
- completedAt: DateTime?
- completedBy: String? -- clerkUserId
- createdAt, updatedAt
- Relations: instance ChecklistInstance, item ChecklistItem
- @@unique([instanceId, itemId]) -- one completion per item per instance
- @@index([instanceId])

**ChecklistItemType enum:**
- CHECKBOX
- TEXT_INPUT
- PHOTO_REQUIRED
- SIGNATURE

Add relations on existing models:
- Organization: add `checklists ChecklistTemplate[]` and `checklistInstances ChecklistInstance[]`
- Project: add `checklistInstances ChecklistInstance[]`

In src/types/index.ts:
- Add `export type ChecklistItemType = "CHECKBOX" | "TEXT_INPUT" | "PHOTO_REQUIRED" | "SIGNATURE";`
- Add `export const CHECKLIST_ITEM_TYPE_LABELS: Record<ChecklistItemType, string> = { CHECKBOX: "Checkbox", TEXT_INPUT: "Text Input", PHOTO_REQUIRED: "Photo Required", SIGNATURE: "Signature" };`

Run `npx prisma db push` to apply schema changes (NOT prisma migrate -- this project uses db push).
  </action>
  <verify>
Run `npx prisma db push` completes without errors. Run `npx prisma generate` succeeds. Run `npx tsc --noEmit` passes with no type errors related to the new models.
  </verify>
  <done>
ChecklistTemplate, ChecklistSection, ChecklistItem, ChecklistInstance, ChecklistItemCompletion models exist in schema. ChecklistItemType enum defined. TypeScript types exported. Relations on Organization and Project added. Schema pushes cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin checklist template CRUD API, page, default seed, and nav</name>
  <files>
    src/app/api/admin/checklists/route.ts
    src/app/api/admin/checklists/[id]/route.ts
    src/app/api/admin/checklists/[id]/sections/route.ts
    src/app/api/admin/checklists/[id]/sections/[sectionId]/items/route.ts
    src/app/(admin)/admin/checklists/page.tsx
    src/app/(admin)/layout.tsx
  </files>
  <action>
**API: /api/admin/checklists/route.ts**
- GET: List all master templates (isMaster: true). On first request, check if any templates with isDefault: true exist -- if not, auto-seed the default RoofWright checklist (follow the auto-seed pattern from /api/admin/micro-credentials). Include sections and items counts.
- POST: Create new master template. Zod validate { title: string, description?: string }. Creates with isMaster: true, isDefault: false.
- Auth: Check RANZ admin role (same pattern as micro-credentials admin routes).

**Default RoofWright Checklist Seed Data:**
Title: "RoofWright Client Process Checklist"
Description: "Standard client process workflow for RoofWright programme members. Covers the complete project lifecycle from initial contact through to completion."
isDefault: true, isMaster: true

Sections (with sortOrder 0-4) and their items:

1. "Initial Contact" (sortOrder: 0):
   - "Record client name and contact details" (CHECKBOX, required)
   - "Confirm site address and access requirements" (CHECKBOX, required)
   - "Identify project scope and client expectations" (TEXT_INPUT, required)
   - "Take initial site photos" (PHOTO_REQUIRED, required)
   - "Provide estimated timeline" (CHECKBOX, required)

2. "Quoting" (sortOrder: 1):
   - "Complete site measurement and assessment" (CHECKBOX, required)
   - "Document existing roof condition" (PHOTO_REQUIRED, required)
   - "Select materials and specify product codes" (TEXT_INPUT, required)
   - "Calculate labour and material costs" (CHECKBOX, required)
   - "Issue written quote to client" (CHECKBOX, required)
   - "Record client acceptance or follow-up required" (TEXT_INPUT, not required)

3. "Site Setup" (sortOrder: 2):
   - "Verify building consent status" (CHECKBOX, required)
   - "Confirm health and safety plan in place" (CHECKBOX, required)
   - "Set up site access and scaffolding" (CHECKBOX, required)
   - "Brief team on project scope and safety" (CHECKBOX, required)
   - "Photo of site setup before work begins" (PHOTO_REQUIRED, required)

4. "Execution" (sortOrder: 3):
   - "Strip existing roof covering (if applicable)" (CHECKBOX, not required)
   - "Install underlay and flashings" (CHECKBOX, required)
   - "Install roof cladding per manufacturer spec" (CHECKBOX, required)
   - "Complete penetration and ridge details" (CHECKBOX, required)
   - "Progress photos at key milestones" (PHOTO_REQUIRED, required)
   - "Daily site cleanup and waste management" (CHECKBOX, required)

5. "Completion" (sortOrder: 4):
   - "Final quality inspection completed" (CHECKBOX, required)
   - "Photo of completed roof" (PHOTO_REQUIRED, required)
   - "Client walkthrough and sign-off" (SIGNATURE, required)
   - "Issue warranty documentation" (CHECKBOX, required)
   - "Submit Record of Work to council" (CHECKBOX, required)
   - "Request client feedback/rating" (CHECKBOX, not required)

**API: /api/admin/checklists/[id]/route.ts**
- GET: Single template with full sections + items tree (ordered by sortOrder). Include counts.
- PATCH: Update template title/description. Prevent editing isDefault/isMaster flags. Zod validate.
- DELETE: Guard against deleting default templates (isDefault: true returns 409). Cascade deletes sections and items (handled by Prisma onDelete: Cascade).

**API: /api/admin/checklists/[id]/sections/route.ts**
- POST: Add a section to a template. Zod validate { title, description?, sortOrder? }. Auto-set sortOrder to max+1 if not provided.
- PATCH: Update section (title, description, sortOrder). Expects { sectionId, title?, description?, sortOrder? }.
- DELETE: Remove a section (via searchParams sectionId). Cascades item deletion.

**API: /api/admin/checklists/[id]/sections/[sectionId]/items/route.ts**
- POST: Add item to section. Zod validate { title, description?, itemType?, isRequired?, sortOrder? }. Default itemType CHECKBOX, isRequired true, sortOrder auto-increment.
- PATCH: Update item. Expects { itemId, title?, description?, itemType?, isRequired?, sortOrder? }.
- DELETE: Remove item (via searchParams itemId).

**Admin Page: /admin/checklists/page.tsx**
Follow the admin micro-credentials page pattern:
- "use client" page with fetch-on-mount
- Template list showing title, description, section count, item count, default badge
- Inline create form (toggle visibility with "New Template" button)
- Click on template to expand/collapse showing sections with their items
- Section management: add section button, edit section title inline
- Item management per section: add item button, edit item inline, delete item
- Delete template button (disabled for defaults with tooltip)
- Toast/alert for errors

**Admin Layout: src/app/(admin)/layout.tsx**
Add "Checklists" nav item after "Micro-credentials" in the navigation array. Use ClipboardList icon from lucide-react (import it). Href: "/admin/checklists".
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Dev server runs without errors
3. Navigate to /admin/checklists -- default RoofWright checklist appears with 5 sections and all items
4. Can create a new template, add sections to it, add items to sections
5. Cannot delete the default template (409 error)
6. Admin nav shows "Checklists" link
  </verify>
  <done>
Admin can CRUD checklist templates with sections and items. Default RoofWright checklist auto-seeds with 5 sections (Initial Contact, Quoting, Site Setup, Execution, Completion) and ~28 items. Default is protected from deletion. Admin nav updated with Checklists link.
  </done>
</task>

</tasks>

<verification>
1. Schema has all 5 models (ChecklistTemplate, ChecklistSection, ChecklistItem, ChecklistInstance, ChecklistItemCompletion) with correct relations
2. Default RoofWright checklist seeds on first admin visit with exactly 5 sections
3. Admin CRUD works for templates, sections, and items
4. Default template protected from deletion
5. TypeScript compiles cleanly
</verification>

<success_criteria>
- CHKL-01 satisfied: RANZ admin can create and edit checklist templates with sections and items
- CHKL-02 satisfied: Portal ships with default RoofWright client process checklist pre-populated
- Schema foundation supports CHKL-03 through CHKL-07 (instance creation, completion, evidence, PDF generation)
</success_criteria>

<output>
After completion, create `.planning/phases/16-client-checklists/16-01-SUMMARY.md`
</output>
