---
phase: 10-staff-management
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/app/api/staff/route.ts
  - src/app/api/staff/[id]/route.ts
  - src/components/settings/staff-list.tsx
  - src/app/(dashboard)/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "Org admin can see list of all current staff members"
    - "Org admin can change a staff member's role (Admin/Staff)"
    - "Org admin can remove a staff member from the organization"
    - "Staff member sees their role reflected (OWNER protected from changes)"
    - "Current user cannot remove themselves or change their own role"
  artifacts:
    - path: "src/app/api/staff/route.ts"
      provides: "GET endpoint for listing organization members"
      exports: ["GET"]
    - path: "src/app/api/staff/[id]/route.ts"
      provides: "PUT endpoint for role change, DELETE for removal"
      exports: ["PUT", "DELETE"]
    - path: "src/components/settings/staff-list.tsx"
      provides: "Table component showing staff with role selector and remove button"
      min_lines: 80
  key_links:
    - from: "src/components/settings/staff-list.tsx"
      to: "/api/staff"
      via: "Props passed from server component"
      pattern: "members.*StaffList"
    - from: "src/components/settings/staff-list.tsx"
      to: "/api/staff/[id]"
      via: "fetch PUT for role change, DELETE for removal"
      pattern: "fetch.*api/staff/.*PUT|DELETE"
    - from: "src/app/api/staff/[id]/route.ts"
      to: "prisma.organizationMember"
      via: "database update/delete"
      pattern: "db.organizationMember.(update|delete)"
---

<objective>
Implement staff list, role management, and member removal allowing org admins to manage their existing team members.

Purpose: Satisfies ORG-04 (remove staff) and ORG-05 (change roles) requirements. Enables complete staff lifecycle management from the settings page.

Output: Staff list API endpoint + role change/removal API endpoints + staff list UI component
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-staff-management/10-RESEARCH.md
@.planning/phases/10-staff-management/10-01-PLAN.md

# Settings page updated in 10-01
@src/app/(dashboard)/settings/page.tsx

# Existing database patterns
@prisma/schema.prisma (OrganizationMember model, OrgMemberRole enum)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create staff list and member management API endpoints</name>
  <files>
    src/app/api/staff/route.ts
    src/app/api/staff/[id]/route.ts
  </files>
  <action>
Create API endpoints for listing staff members and managing individual members.

**src/app/api/staff/route.ts (GET):**
1. Import: `auth` from `@clerk/nextjs/server`, `db` from `@/lib/db`
2. GET handler:
   - Get `userId`, `orgId` from `await auth()`, return 401 if missing
   - Find organization by `clerkOrgId: orgId` with member where `clerkUserId: userId`
   - Verify member role is OWNER or ADMIN, return 403 if not (non-admins see dashboard, not settings)
   - Query all members: `db.organizationMember.findMany()` where organizationId
   - Select: id, firstName, lastName, email, role, lbpNumber, lbpVerified, clerkUserId, createdAt
   - Order by: role DESC (OWNER first, then ADMIN, then STAFF), then firstName
   - Return { members, currentUserId: userId } (currentUserId needed for UI to disable self-actions)

**src/app/api/staff/[id]/route.ts (PUT and DELETE):**

PUT handler (role change):
1. Get `userId`, `orgId` from `await auth()`, return 401 if missing
2. Get member id from params (v15 pattern: `const { id } = await params`)
3. Parse body with schema: role enum ["ADMIN", "STAFF"] (cannot set OWNER via API)
4. Find organization and verify admin role
5. Find target member by id AND organizationId (security: ensure member belongs to current org)
6. Validation:
   - Cannot change OWNER's role (return 403 "Cannot change owner role")
   - Cannot change own role (return 400 "Cannot change your own role")
7. Update member role: `db.organizationMember.update({ where: { id }, data: { role } })`
8. Import and call `revalidatePath('/settings')` from next/cache
9. Return updated member

DELETE handler (removal):
1. Get `userId`, `orgId` from `await auth()`, return 401 if missing
2. Get member id from params
3. Find organization and verify admin role
4. Find target member by id AND organizationId
5. Validation:
   - Cannot remove OWNER (return 403 "Cannot remove organization owner")
   - Cannot remove self (return 400 "Cannot remove yourself")
6. Delete member: `db.organizationMember.delete({ where: { id } })`
7. `revalidatePath('/settings')`
8. Return success: { success: true, message: "Member removed" }

NOTE: This removes from database only. Clerk org membership stays - acceptable for MVP as user loses app access.
  </action>
  <verify>
Build passes: `cd "RANZ Quality Program" && npm run build`
  </verify>
  <done>
GET /api/staff returns organization members list with roles. PUT /api/staff/[id] changes member role (except OWNER, self). DELETE /api/staff/[id] removes member (except OWNER, self).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create staff list UI component with role management</name>
  <files>
    src/components/settings/staff-list.tsx
    src/app/(dashboard)/settings/page.tsx
  </files>
  <action>
Create staff list component and integrate into settings page.

**staff-list.tsx:**
1. "use client" component
2. Props interface:
```typescript
interface StaffMember {
  id: string;
  firstName: string;
  lastName: string;
  email: string;
  role: "OWNER" | "ADMIN" | "STAFF";
  lbpNumber: string | null;
  lbpVerified: boolean;
  clerkUserId: string;
}
interface StaffListProps {
  members: StaffMember[];
  currentUserId: string;
}
```
3. State: loading (memberId | null for which member is being updated)
4. Table with columns: Name, Email, LBP Number, Role, Actions
5. For each member row:
   - Name with role icon (Shield purple for OWNER, Shield blue for ADMIN, User gray for STAFF) from lucide-react
   - Show "(You)" indicator if member.clerkUserId === currentUserId
   - LBP number or dash if null, checkmark if verified
   - Role:
     - If OWNER or isCurrentUser: display text only
     - Else: select dropdown with ADMIN/STAFF options, onChange calls handleRoleChange
   - Actions:
     - If OWNER or isCurrentUser: no actions
     - Else: red Trash2 icon button to remove
6. handleRoleChange(memberId, newRole):
   - Set loading to memberId
   - PUT to /api/staff/{memberId} with { role: newRole }
   - On error: alert with error message
   - On success: window.location.reload() to refresh server data
   - Clear loading
7. handleRemove(memberId, memberName):
   - Confirm dialog: "Remove {memberName} from the organization?"
   - Set loading to memberId
   - DELETE to /api/staff/{memberId}
   - On error: alert with error message
   - On success: window.location.reload()
   - Clear loading
8. Use Tailwind table styles consistent with existing admin tables

**Update settings/page.tsx:**
1. Import StaffList component
2. In the Staff Management section (added in 10-01), add staff list at the top:
   - Fetch members in server component by querying db directly (same query as API)
   - Pass members and currentUserId to StaffList
3. Update section structure:
```jsx
<div className="bg-white rounded-lg shadow p-6">
  <h2 className="text-lg font-semibold text-gray-900 mb-6">
    Staff Management
  </h2>
  <div className="space-y-8">
    {/* Current Staff */}
    <div>
      <h3 className="text-sm font-medium text-gray-700 mb-3">Current Staff</h3>
      <StaffList members={members} currentUserId={userId} />
    </div>

    {/* Invite New Staff - from 10-01 */}
    <div className="border-t pt-6">
      <h3 className="text-sm font-medium text-gray-700 mb-3">Invite New Staff</h3>
      <StaffInvitationForm />
    </div>

    {/* Pending Invitations - from 10-01 */}
    <div className="border-t pt-6">
      <h3 className="text-sm font-medium text-gray-700 mb-3">Pending Invitations</h3>
      <PendingInvitations />
    </div>
  </div>
</div>
```
4. Query members in page.tsx server component:
```typescript
const members = await db.organizationMember.findMany({
  where: { organizationId: organization.id },
  select: {
    id: true,
    firstName: true,
    lastName: true,
    email: true,
    role: true,
    lbpNumber: true,
    lbpVerified: true,
    clerkUserId: true,
  },
  orderBy: [
    { role: 'asc' }, // ADMIN before STAFF (OWNER handled separately)
    { firstName: 'asc' },
  ],
});
// Sort OWNER first manually since enum ordering may vary
const sortedMembers = [...members].sort((a, b) => {
  const roleOrder = { OWNER: 0, ADMIN: 1, STAFF: 2 };
  return roleOrder[a.role] - roleOrder[b.role];
});
```
  </action>
  <verify>
Build passes: `cd "RANZ Quality Program" && npm run build`
Start dev server: `cd "RANZ Quality Program" && npm run dev`
Navigate to /settings - Staff list visible with current members
  </verify>
  <done>
Settings page shows staff list table with name, email, LBP, role selector (for non-owner/non-self), and remove button (for non-owner/non-self). Role changes and removals work with confirmation and reload.
  </done>
</task>

</tasks>

<verification>
1. Build passes without errors
2. Settings page shows Current Staff section with table
3. Staff table displays all organization members
4. OWNER role protected from changes and removal
5. Current user cannot change own role or remove self
6. Role dropdown changes role when selected
7. Remove button shows confirmation and removes member
8. TypeScript compilation succeeds
</verification>

<success_criteria>
- Org admin sees list of all staff members in settings page
- Table shows name (with role icon), email, LBP number, role, and actions
- OWNER row shows role text only, no actions
- Current user row shows "(You)" indicator, no actions for self
- Other members have role dropdown (ADMIN/STAFF) that works
- Other members have remove button that confirms and removes
- After role change or removal, page refreshes to show updated data
- Non-admin users still redirected from settings page
</success_criteria>

<output>
After completion, create `.planning/phases/10-staff-management/10-02-SUMMARY.md`
</output>
