---
phase: 10-staff-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/staff/invite/route.ts
  - src/app/api/staff/invitations/route.ts
  - src/components/settings/staff-invitation-form.tsx
  - src/components/settings/pending-invitations.tsx
  - src/app/(dashboard)/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "Org admin can enter email address and role to send invitation"
    - "Invited user receives email via Clerk with join link"
    - "Org admin can see list of pending invitations"
    - "Org admin can revoke a pending invitation"
  artifacts:
    - path: "src/app/api/staff/invite/route.ts"
      provides: "POST endpoint for creating Clerk organization invitations"
      exports: ["POST"]
    - path: "src/app/api/staff/invitations/route.ts"
      provides: "GET and DELETE endpoints for pending invitations"
      exports: ["GET", "DELETE"]
    - path: "src/components/settings/staff-invitation-form.tsx"
      provides: "Form component for inviting new staff"
      min_lines: 60
    - path: "src/components/settings/pending-invitations.tsx"
      provides: "Component showing pending invitations with revoke option"
      min_lines: 50
  key_links:
    - from: "src/components/settings/staff-invitation-form.tsx"
      to: "/api/staff/invite"
      via: "fetch POST on form submit"
      pattern: "fetch.*api/staff/invite"
    - from: "src/components/settings/pending-invitations.tsx"
      to: "/api/staff/invitations"
      via: "fetch GET/DELETE for list and revoke"
      pattern: "fetch.*api/staff/invitations"
    - from: "src/app/api/staff/invite/route.ts"
      to: "clerkClient().organizations.createOrganizationInvitation"
      via: "Clerk Backend SDK"
      pattern: "createOrganizationInvitation"
---

<objective>
Implement staff invitation flow allowing org admins to invite new team members via email using Clerk's organization invitation system.

Purpose: Satisfies ORG-03 requirement - org admin can invite new staff members via email invitation. Clerk handles email delivery, invitation lifecycle, and acceptance flow automatically.

Output: Invitation API endpoints + UI components integrated into settings page
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-staff-management/10-RESEARCH.md

# Existing settings page to extend
@src/app/(dashboard)/settings/page.tsx
@src/components/settings/organization-profile-form.tsx

# Existing database patterns
@prisma/schema.prisma (OrganizationMember model, OrgMemberRole enum)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create invitation API endpoint</name>
  <files>src/app/api/staff/invite/route.ts</files>
  <action>
Create POST /api/staff/invite endpoint using Clerk Backend SDK for organization invitations.

Implementation:
1. Import: `auth`, `clerkClient` from `@clerk/nextjs/server`, `db` from `@/lib/db`, `z` from `zod/v4`
2. Create inviteSchema validating: emailAddress (email), role (ADMIN | STAFF), optional firstName, lastName
3. In POST handler:
   - Get `userId`, `orgId` from `await auth()`, return 401 if missing
   - Find organization by `clerkOrgId: orgId` with member where `clerkUserId: userId`
   - Verify member role is OWNER or ADMIN, return 403 if not
   - Parse request body with inviteSchema
   - Check if email already exists in `OrganizationMember` table, return 400 if duplicate
   - Map role: ADMIN -> "org:admin", STAFF -> "org:member"
   - Initialize client: `const client = await clerkClient()` (CRITICAL: v6 is async)
   - Call `client.organizations.createOrganizationInvitation()` with:
     - organizationId: orgId
     - inviterUserId: userId
     - emailAddress: data.emailAddress
     - role: clerkRole
     - redirectUrl: `${process.env.NEXT_PUBLIC_APP_URL}/onboarding`
     - publicMetadata: { firstName, lastName, role: data.role }
   - Return invitation details (id, emailAddress, role, status, createdAt)
4. Wrap in try/catch, handle ZodError with 400, others with 500

Role mapping is critical: Database uses OWNER/ADMIN/STAFF, Clerk uses org:owner/org:admin/org:member.
  </action>
  <verify>
Build passes: `cd "RANZ Quality Program" && npm run build`
Manual test: `curl -X POST http://localhost:3000/api/staff/invite -H "Content-Type: application/json" -d '{"emailAddress":"test@example.com","role":"STAFF"}' -v` (will return 401 without auth, confirming route exists)
  </verify>
  <done>
POST /api/staff/invite accepts email and role, validates admin access, checks for duplicate, calls Clerk createOrganizationInvitation, returns invitation object
  </done>
</task>

<task type="auto">
  <name>Task 2: Create invitations list/revoke API endpoint</name>
  <files>src/app/api/staff/invitations/route.ts</files>
  <action>
Create GET and DELETE /api/staff/invitations endpoint for listing pending invitations and revoking them.

Implementation:

GET handler:
1. Get `orgId` from `await auth()`, return 401 if missing
2. Find organization and verify admin role (same pattern as invite route)
3. Initialize client: `const client = await clerkClient()`
4. Call `client.organizations.getOrganizationInvitationList()` with:
   - organizationId: orgId
   - status: ['pending']
   - limit: 50
5. Map response to return: id, emailAddress, role (mapped back to ADMIN/STAFF), createdAt, status
6. Return { invitations, total }

DELETE handler:
1. Get `userId`, `orgId` from `await auth()`, return 401 if missing
2. Verify admin role
3. Parse body for invitationId
4. Initialize client: `const client = await clerkClient()`
5. Call `client.organizations.revokeOrganizationInvitation()` with:
   - organizationId: orgId
   - invitationId
   - requestingUserId: userId
6. Return success response

Clerk role to database role mapping for display: "org:admin" -> "ADMIN", "org:member" -> "STAFF"
  </action>
  <verify>
Build passes: `cd "RANZ Quality Program" && npm run build`
  </verify>
  <done>
GET /api/staff/invitations returns pending invitations list, DELETE /api/staff/invitations revokes specified invitation
  </done>
</task>

<task type="auto">
  <name>Task 3: Create invitation UI components and integrate into settings</name>
  <files>
    src/components/settings/staff-invitation-form.tsx
    src/components/settings/pending-invitations.tsx
    src/app/(dashboard)/settings/page.tsx
  </files>
  <action>
Create UI components for staff invitation and integrate into settings page.

**staff-invitation-form.tsx:**
1. "use client" component
2. State: email, role (default "STAFF"), firstName, lastName, loading, error, success
3. Form with:
   - Email input (required)
   - Role select (Admin / Staff)
   - Optional first name, last name inputs
   - Submit button "Send Invitation"
4. On submit:
   - Set loading true, clear error/success
   - POST to /api/staff/invite with form data
   - On success: clear form, show success message "Invitation sent to {email}"
   - On error: show error message from response
   - Set loading false
5. Use existing Tailwind patterns (input, button, select classes from other settings components)

**pending-invitations.tsx:**
1. "use client" component
2. State: invitations array, loading, revoking (invitationId or null)
3. useEffect to fetch GET /api/staff/invitations on mount
4. Display pending invitations in list:
   - Show email, role, date sent
   - Yellow background (bg-yellow-50 border-yellow-200)
   - Mail icon from lucide-react
   - X button to revoke
5. handleRevoke: confirm dialog, DELETE to /api/staff/invitations, remove from local state
6. Show "No pending invitations" if empty

**Update settings/page.tsx:**
1. Import StaffInvitationForm and PendingInvitations
2. Add new section after "Notification Preferences" div:
```jsx
<div className="bg-white rounded-lg shadow p-6">
  <h2 className="text-lg font-semibold text-gray-900 mb-6">
    Staff Management
  </h2>
  <div className="space-y-6">
    <div>
      <h3 className="text-sm font-medium text-gray-700 mb-3">Invite New Staff</h3>
      <StaffInvitationForm />
    </div>
    <div className="border-t pt-6">
      <h3 className="text-sm font-medium text-gray-700 mb-3">Pending Invitations</h3>
      <PendingInvitations />
    </div>
  </div>
</div>
```

Use icons: Mail, X, UserPlus from lucide-react
  </action>
  <verify>
Build passes: `cd "RANZ Quality Program" && npm run build`
Start dev server: `cd "RANZ Quality Program" && npm run dev`
Navigate to /settings - Staff Management section visible with invitation form and pending invitations
  </verify>
  <done>
Settings page shows Staff Management section with invitation form (email, role, names) and pending invitations list with revoke capability
  </done>
</task>

</tasks>

<verification>
1. Build passes without errors
2. Settings page shows Staff Management section for admin users
3. Invitation form accepts email and role
4. Pending invitations section loads and displays any pending invites
5. TypeScript compilation succeeds with no errors
</verification>

<success_criteria>
- Org admin can access Staff Management section on settings page
- Org admin can fill invitation form (email required, role selection, optional names)
- Invitation form submits to API and shows success/error feedback
- Pending invitations load from Clerk and display with email, role, date
- Revoke button removes invitation after confirmation
- Non-admin users cannot access settings page (redirect maintained)
</success_criteria>

<output>
After completion, create `.planning/phases/10-staff-management/10-01-SUMMARY.md`
</output>
