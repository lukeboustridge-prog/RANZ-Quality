generator client {
  provider   = "prisma-client-js"
  output     = "../node_modules/.prisma/client"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// Core Models
// ============================================================================

model Organization {
  id          String  @id @default(cuid())
  clerkOrgId  String  @unique
  name        String
  tradingName String?
  nzbn        String? @unique

  // Certification Status
  certificationTier CertificationTier @default(ACCREDITED)
  certifiedSince    DateTime?
  tierPromotedAt    DateTime?

  // Compliance
  complianceScore Float     @default(0)
  lastAuditDate   DateTime?
  nextAuditDue    DateTime?

  // Cached dimension scores for fast bulk queries
  complianceDocScore   Float     @default(0) // Documentation dimension (50% weight)
  complianceInsScore   Float     @default(0) // Insurance dimension (25% weight)
  compliancePersScore  Float     @default(0) // Personnel dimension (15% weight)
  complianceAuditScore Float     @default(0) // Audit dimension (10% weight)
  complianceLastCalc   DateTime? // Last compliance calculation timestamp

  // Contact
  email   String?
  phone   String?
  address String?
  city    String?

  // Relations
  members           OrganizationMember[]
  documents         Document[]
  insurancePolicies InsurancePolicy[]
  audits            Audit[]
  capaRecords       CAPARecord[]
  assessments       ComplianceAssessment[]
  projects          Project[]
  testimonials      Testimonial[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([certificationTier])
  @@index([complianceScore])
  @@index([name]) // For name-based verification lookup
  @@index([tradingName]) // For trading name verification lookup
}

model OrganizationMember {
  id             String @id @default(cuid())
  organizationId String
  clerkUserId    String

  // Personal Details
  firstName String
  lastName  String
  email     String
  phone     String?

  // LBP License
  lbpNumber         String?
  lbpClass          LBPClass?
  lbpVerified       Boolean    @default(false)
  lbpVerifiedAt     DateTime?
  lbpVerificationId String? // API verification reference
  lbpStatus         LBPStatus? // Status from MBIE API
  lbpLastChecked    DateTime? // Last API verification timestamp
  lbpExpiry         DateTime?

  // Role
  role OrgMemberRole @default(STAFF)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
  @@unique([organizationId, clerkUserId])
  @@index([lbpNumber])
}

model InsurancePolicy {
  id             String @id @default(cuid())
  organizationId String

  policyType   InsurancePolicyType
  policyNumber String
  insurer      String
  brokerName   String?

  // Coverage
  coverageAmount Decimal  @db.Decimal(12, 2)
  excessAmount   Decimal? @db.Decimal(10, 2)

  // Dates
  effectiveDate DateTime
  expiryDate    DateTime

  // Document reference
  certificateKey String? // R2 storage key
  verified       Boolean   @default(false)
  verifiedAt     DateTime?
  verifiedBy     String?

  // Alerts sent
  alert90Sent Boolean @default(false)
  alert60Sent Boolean @default(false)
  alert30Sent Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([expiryDate])
  @@index([organizationId, policyType])
}

model Document {
  id             String @id @default(cuid())
  organizationId String
  documentNumber String // Auto-generated (e.g., QP-001-v1.0)
  title          String

  // ISO 9000 Classification
  isoElement   ISOElement
  documentType DocumentType

  // Versioning
  currentVersion Int            @default(1)
  status         DocumentStatus @default(DRAFT)

  // Storage (Cloudflare R2)
  storageKey String?
  fileName   String?
  fileSize   Int?
  mimeType   String?
  fileHash   String? // SHA-256 integrity

  // Workflow
  reviewDueDate DateTime?
  approvedBy    String?
  approvedAt    DateTime?

  // Soft delete for compliance
  deletedAt DateTime?
  deletedBy String?

  // Metadata
  uploadedBy String
  uploadedAt DateTime @default(now())

  // Relations
  versions     DocumentVersion[]
  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, documentNumber])
  @@index([isoElement])
  @@index([organizationId, isoElement])
  @@index([status])
}

model DocumentVersion {
  id            String @id @default(cuid())
  documentId    String
  versionNumber Int // e.g., 1, 2, 3
  minorVersion  Int    @default(0) // e.g., 0, 1, 2 for 1.0, 1.1, 1.2

  // Storage
  storageKey String
  fileName   String
  fileSize   Int
  mimeType   String
  fileHash   String // SHA-256 for integrity

  // Status
  status DocumentVersionStatus @default(DRAFT)

  // Workflow
  submittedBy     String?
  submittedAt     DateTime?
  reviewedBy      String?
  reviewedAt      DateTime?
  rejectionReason String?

  // Changes
  changeNotes String? // What changed in this version

  createdAt DateTime @default(now())
  createdBy String

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, versionNumber, minorVersion])
  @@index([documentId])
  @@index([status])
}

// ============================================================================
// Compliance Assessment Models
// ============================================================================

model ComplianceAssessment {
  id             String @id @default(cuid())
  organizationId String

  isoElement ISOElement

  // Scoring
  status ComplianceStatus @default(NOT_ASSESSED)
  score  Float            @default(0) // 0-100
  weight Float            @default(1.0) // Element importance

  // Evidence
  documentIds   String[] // References to supporting documents
  auditFindings String? // Summary of audit findings

  // Assessment
  assessedBy    String?
  assessedAt    DateTime  @default(now())
  nextReviewDue DateTime?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, isoElement])
  @@index([organizationId])
  @@index([status])
}

// ============================================================================
// Audit Models
// ============================================================================

model Audit {
  id             String @id @default(cuid())
  organizationId String
  auditNumber    String // Auto-generated (e.g., AUD-2026-001)

  // Type and Status
  auditType AuditType
  status    AuditStatus @default(SCHEDULED)

  // Scheduling
  scheduledDate DateTime
  startedAt     DateTime?
  completedAt   DateTime?

  // Auditor
  auditorId    String? // Clerk user ID of auditor
  auditorName  String?
  auditorEmail String?

  // Scope
  scope       String? // Description of audit scope
  isoElements ISOElement[] // Elements being audited

  // Results
  rating  AuditRating?
  summary String? // Executive summary

  // Statistics
  conformingCount      Int @default(0)
  minorNonconformities Int @default(0)
  majorNonconformities Int @default(0)
  observations         Int @default(0)

  // Follow-up
  followUpRequired Boolean   @default(false)
  followUpDueDate  DateTime?
  followUpAuditId  String? // Link to follow-up audit

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  checklist    AuditChecklist[]
  capaRecords  CAPARecord[]

  @@unique([organizationId, auditNumber])
  @@index([organizationId])
  @@index([status])
  @@index([scheduledDate])
}

model AuditChecklist {
  id      String @id @default(cuid())
  auditId String

  isoElement     ISOElement
  questionNumber Int
  questionText   String

  // Response
  response AuditResponse?
  finding  String?
  severity FindingSeverity?

  // Evidence
  evidenceKeys String[] // R2 photo/document references
  auditorNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  audit Audit @relation(fields: [auditId], references: [id], onDelete: Cascade)

  @@unique([auditId, isoElement, questionNumber])
  @@index([auditId])
}

// ============================================================================
// CAPA (Corrective and Preventive Action) Models
// ============================================================================

model CAPARecord {
  id             String @id @default(cuid())
  organizationId String
  capaNumber     String // Auto-generated (e.g., CAPA-2026-001)

  // Source
  auditId         String? // Link to originating audit
  sourceType      CAPASourceType
  sourceReference String? // External reference if not from audit

  // Issue
  title       String
  description String
  rootCause   String?

  // Classification
  severity   FindingSeverity
  isoElement ISOElement?

  // Status
  status CAPAStatus @default(OPEN)

  // Dates
  identifiedDate DateTime  @default(now())
  dueDate        DateTime
  closedDate     DateTime?

  // Actions
  correctiveAction String? // Immediate correction
  preventiveAction String? // Action to prevent recurrence

  // Verification
  verifiedBy        String?
  verifiedAt        DateTime?
  verificationNotes String?

  // Assignment
  assignedTo     String? // Clerk user ID
  assignedToName String?

  // Evidence
  evidenceKeys String[] // R2 storage keys for evidence

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  audit        Audit?       @relation(fields: [auditId], references: [id])

  @@unique([organizationId, capaNumber])
  @@index([organizationId])
  @@index([status])
  @@index([dueDate])
}

// ============================================================================
// Audit Log (Immutable Event Sourcing)
// ============================================================================

model AuditLog {
  id      BigInt @id @default(autoincrement())
  eventId String @default(uuid())

  // Actor
  actorId    String
  actorEmail String
  actorRole  String
  ipAddress  String?
  userAgent  String?

  // Action
  action       AuditAction
  resourceType String
  resourceId   String

  // State Change
  previousState Json?
  newState      Json?
  metadata      Json?

  // Tamper Evidence
  hash         String // SHA-256
  previousHash String? // Chain to previous

  timestamp DateTime @default(now())

  @@index([resourceType, resourceId])
  @@index([actorId, timestamp])
  @@index([timestamp])
}

// ============================================================================
// Enums
// ============================================================================

enum CertificationTier {
  ACCREDITED
  CERTIFIED
  MASTER_ROOFER
}

enum OrgMemberRole {
  OWNER
  ADMIN
  STAFF
}

enum LBPClass {
  CARPENTRY
  ROOFING
  DESIGN_1
  DESIGN_2
  DESIGN_3
  SITE_1
  SITE_2
  SITE_3
}

enum LBPStatus {
  CURRENT
  SUSPENDED
  CANCELLED
  EXPIRED
  NOT_FOUND
}

enum InsurancePolicyType {
  PUBLIC_LIABILITY
  PROFESSIONAL_INDEMNITY
  STATUTORY_LIABILITY
  EMPLOYERS_LIABILITY
  MOTOR_VEHICLE
  CONTRACT_WORKS
}

enum ISOElement {
  QUALITY_POLICY
  QUALITY_OBJECTIVES
  ORG_STRUCTURE
  PROCESS_MANAGEMENT
  DOCUMENTATION
  TRAINING_COMPETENCE
  CONTRACT_REVIEW
  DOCUMENT_CONTROL
  PURCHASING
  CUSTOMER_PRODUCT
  TRACEABILITY
  PROCESS_CONTROL
  INSPECTION_TESTING
  NONCONFORMING_PRODUCT
  CORRECTIVE_ACTION
  HANDLING_STORAGE
  QUALITY_RECORDS
  INTERNAL_AUDITS
  SERVICING
}

enum DocumentType {
  POLICY
  PROCEDURE
  FORM
  RECORD
  CERTIFICATE
  OTHER
}

enum DocumentStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  SUPERSEDED
  ARCHIVED
}

enum DocumentVersionStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
  SUPERSEDED
}

enum ComplianceStatus {
  COMPLIANT
  PARTIAL
  NON_COMPLIANT
  NOT_ASSESSED
  NOT_APPLICABLE
}

enum AuditType {
  INITIAL_CERTIFICATION
  SURVEILLANCE
  RECERTIFICATION
  FOLLOW_UP
  SPECIAL
}

enum AuditStatus {
  SCHEDULED
  IN_PROGRESS
  PENDING_REVIEW
  COMPLETED
  CANCELLED
}

enum AuditRating {
  PASS
  PASS_WITH_OBSERVATIONS
  CONDITIONAL_PASS
  FAIL
}

enum AuditResponse {
  CONFORMING
  MINOR_NONCONFORMITY
  MAJOR_NONCONFORMITY
  OBSERVATION
  NOT_APPLICABLE
}

enum FindingSeverity {
  OBSERVATION
  MINOR
  MAJOR
  CRITICAL
}

enum CAPAStatus {
  OPEN
  IN_PROGRESS
  PENDING_VERIFICATION
  CLOSED
  OVERDUE
}

enum CAPASourceType {
  AUDIT
  CUSTOMER_COMPLAINT
  INTERNAL_REVIEW
  INCIDENT
  OTHER
}

enum AuditAction {
  CREATE
  READ
  UPDATE
  DELETE
  APPROVE
  REJECT
  VERIFY
  LOGIN
  LOGOUT
  EXPORT
  LBP_VERIFY
  AUDIT_START
  AUDIT_COMPLETE
}

// ============================================================================
// Phase 3: Project Evidence Repository
// ============================================================================

model Project {
  id             String @id @default(cuid())
  organizationId String
  projectNumber  String // Auto-generated (e.g., PRJ-2026-001)

  // Project Details
  clientName    String
  clientEmail   String?
  clientPhone   String?
  siteAddress   String
  city          String?
  region        String?
  consentNumber String? // Building consent reference

  // Dates
  startDate      DateTime
  completionDate DateTime?

  // Classification
  projectType   ProjectType
  roofingSystem String? // Description of roofing system used
  description   String?

  // Quality Objectives
  zeroLeaks     Boolean @default(true)
  warrantyYears Int?

  // Client Feedback
  rating         Int? // 1-5 stars
  clientFeedback String?

  // Record of Work
  rowSubmitted Boolean   @default(false)
  rowDate      DateTime?

  // Status
  status ProjectStatus @default(IN_PROGRESS)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  photos       ProjectPhoto[]
  documents    ProjectDocument[]
  productsUsed CertifiedProductUsage[]
  testimonial  Testimonial?

  @@unique([organizationId, projectNumber])
  @@index([organizationId])
  @@index([status])
  @@index([completionDate])
}

model ProjectPhoto {
  id        String @id @default(cuid())
  projectId String

  storageKey   String // R2 key
  thumbnailKey String? // Thumbnail R2 key
  fileName     String
  fileSize     Int
  mimeType     String

  category   PhotoCategory
  capturedAt DateTime?

  // GPS/EXIF metadata
  latitude   Float?
  longitude  Float?
  deviceInfo String?

  description String?
  tags        String[]

  uploadedBy String
  uploadedAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([category])
}

model ProjectDocument {
  id        String @id @default(cuid())
  projectId String

  documentType ProjectDocType
  title        String

  storageKey String // R2 key
  fileName   String
  fileSize   Int
  mimeType   String

  uploadedBy String
  uploadedAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model CertifiedProductUsage {
  id        String @id @default(cuid())
  projectId String

  productName  String
  manufacturer String
  productCode  String?
  batchNumber  String? // For traceability

  // APEX Certification
  apexCertified Boolean @default(false)
  apexCertId    String? // APEX certification ID if applicable

  // Non-certified justification
  justification String? // Required if not APEX certified

  quantity String? // e.g., "50mÂ²", "100 sheets"

  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

// ============================================================================
// Phase 3: Testimonials
// ============================================================================

model Testimonial {
  id             String  @id @default(cuid())
  organizationId String
  projectId      String? @unique // Optional link to project

  // Client details
  clientName     String
  clientEmail    String?
  clientCompany  String?
  clientLocation String? // City/region for display

  // Testimonial content
  rating  Int // 1-5 stars
  title   String?
  content String

  // Verification
  verified          Boolean   @default(false)
  verifiedAt        DateTime?
  verificationToken String?   @unique // For email verification

  // Display
  approved   Boolean   @default(false)
  approvedAt DateTime?
  approvedBy String?
  featured   Boolean   @default(false)

  // Request tracking
  requestedAt   DateTime?
  requestSentTo String? // Email sent to

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project?     @relation(fields: [projectId], references: [id])

  @@index([organizationId])
  @@index([verified, approved])
}

// ============================================================================
// Phase 3: Notification System
// ============================================================================

model Notification {
  id             String  @id @default(cuid())
  organizationId String? // Null for system-wide notifications
  userId         String? // Specific user, or null for org-wide

  type     NotificationType
  channel  NotificationChannel
  priority NotificationPriority @default(NORMAL)

  // Content
  title     String
  message   String
  actionUrl String? // Link to relevant page

  // Delivery
  status        NotificationStatus @default(PENDING)
  sentAt        DateTime?
  deliveredAt   DateTime?
  failureReason String?
  retryCount    Int                @default(0)

  // For SMS/Email
  recipient  String? // Phone number or email
  externalId String? // ID from SMS/Email provider

  // Scheduling
  scheduledFor DateTime? // For scheduled notifications

  // Retry scheduling for exponential backoff
  lastRetryAt DateTime? // Timestamp of last retry attempt
  nextRetryAt DateTime? // When next retry should occur

  // Read status
  readAt DateTime?

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@index([scheduledFor])
  @@index([type])
  @@index([nextRetryAt])
}

model NotificationPreference {
  id     String @id @default(cuid())
  userId String @unique

  // Email preferences
  emailEnabled    Boolean @default(true)
  emailInsurance  Boolean @default(true)
  emailAudit      Boolean @default(true)
  emailCompliance Boolean @default(true)
  emailNewsletter Boolean @default(true)

  // SMS preferences
  smsEnabled   Boolean @default(false)
  smsInsurance Boolean @default(true)
  smsAudit     Boolean @default(false)
  smsCritical  Boolean @default(true)

  // Phone number for SMS
  smsPhoneNumber String?

  updatedAt DateTime @updatedAt

  @@index([userId])
}

// ============================================================================
// Phase 3: Reports and Analytics
// ============================================================================

model Report {
  id String @id @default(cuid())

  reportType  ReportType
  title       String
  description String?

  // Parameters
  parameters Json? // Report generation parameters

  // Time range
  startDate DateTime?
  endDate   DateTime?

  // Generated file
  storageKey String? // R2 key for generated report
  format     ReportFormat @default(PDF)

  // Status
  status       ReportStatus @default(PENDING)
  generatedAt  DateTime?
  errorMessage String?

  // Access
  createdBy      String
  organizationId String? // Null for RANZ admin reports

  createdAt DateTime @default(now())

  @@index([reportType])
  @@index([status])
  @@index([createdBy])
}

// ============================================================================
// Phase 3: New Enums
// ============================================================================

enum ProjectType {
  NEW_BUILD
  REROOF
  REPAIR
  MAINTENANCE
  INSPECTION
  WARRANTY_CLAIM
  OTHER
}

enum ProjectStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  ON_HOLD
  CANCELLED
}

enum PhotoCategory {
  BEFORE
  DURING
  AFTER
  MATERIALS
  SAFETY
  ISSUE
  DETAIL
  TESTIMONIAL
}

enum ProjectDocType {
  QUOTE
  CONTRACT
  CONSENT
  SPECIFICATION
  WARRANTY
  SIGN_OFF
  INVOICE
  RECORD_OF_WORK
  OTHER
}

enum NotificationType {
  INSURANCE_EXPIRY
  INSURANCE_EXPIRED
  LBP_EXPIRY
  LBP_STATUS_CHANGE
  AUDIT_SCHEDULED
  AUDIT_REMINDER
  AUDIT_COMPLETED
  CAPA_DUE
  CAPA_OVERDUE
  COMPLIANCE_ALERT
  DOCUMENT_REVIEW_DUE
  TESTIMONIAL_REQUEST
  TESTIMONIAL_RECEIVED
  TIER_CHANGE
  WELCOME
  SYSTEM
}

enum NotificationChannel {
  EMAIL
  SMS
  IN_APP
  PUSH
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  CRITICAL
}

enum NotificationStatus {
  PENDING
  QUEUED
  SENT
  DELIVERED
  FAILED
  CANCELLED
}

enum ReportType {
  COMPLIANCE_SUMMARY
  MEMBER_DIRECTORY
  AUDIT_SUMMARY
  INSURANCE_STATUS
  LBP_STATUS
  CAPA_SUMMARY
  PROJECT_PORTFOLIO
  TESTIMONIAL_SUMMARY
  TIER_ANALYSIS
}

enum ReportFormat {
  PDF
  CSV
  XLSX
  JSON
}

enum ReportStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
}

// ============================================================================
// Custom Authentication Enums
// ============================================================================

enum AuthUserType {
  MEMBER_COMPANY_ADMIN // Company owner/admin
  MEMBER_COMPANY_USER // Company staff
  RANZ_ADMIN // RANZ system admin
  RANZ_STAFF // RANZ office staff
  RANZ_INSPECTOR // RANZ field inspector
  EXTERNAL_INSPECTOR // Third-party inspector
}

enum AuthUserStatus {
  PENDING_ACTIVATION // Created, awaiting first login
  ACTIVE // Normal active user
  SUSPENDED // Temporarily suspended
  DEACTIVATED // Permanently deactivated
}

enum AuthCompanyStatus {
  ACTIVE
  SUSPENDED
  DEACTIVATED
}

enum AuthApplicationType {
  QUALITY_PROGRAM
  ROOFING_REPORT
  MOBILE
}

enum AuthPermission {
  // Quality Program
  QP_VIEW_DASHBOARD
  QP_MANAGE_DOCUMENTS
  QP_MANAGE_INSURANCE
  QP_MANAGE_PERSONNEL
  QP_VIEW_AUDITS
  QP_MANAGE_PROJECTS
  QP_ADMIN_USERS
  QP_ADMIN_COMPANIES
  QP_ADMIN_AUDITS
  QP_ADMIN_REPORTS

  // Roofing Report
  RR_CREATE_REPORTS
  RR_VIEW_OWN_REPORTS
  RR_VIEW_ALL_REPORTS
  RR_MANAGE_INSPECTORS
  RR_ADMIN

  // Mobile
  MOBILE_PHOTO_CAPTURE
  MOBILE_SYNC
}

enum AuthMode {
  CLERK // User authenticates via Clerk
  CUSTOM // User authenticates via custom auth
  MIGRATING // User in transition (dual-read active)
}

// ============================================================================
// Custom Authentication Models
// ============================================================================

model AuthUser {
  id           String  @id @default(cuid())
  email        String  @unique
  passwordHash String? // Null for SSO-only users

  // Profile
  firstName String
  lastName  String
  phone     String?

  // User Type
  userType AuthUserType

  // Company Association (for Member Users)
  companyId String?
  company   AuthCompany? @relation(fields: [companyId], references: [id])

  // Status
  status             AuthUserStatus @default(PENDING_ACTIVATION)
  deactivatedAt      DateTime?
  deactivatedBy      String?
  deactivationReason String?

  // Password Management
  passwordChangedAt  DateTime?
  mustChangePassword Boolean   @default(true) // First login forced change

  // Account Security
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  lastLoginAt         DateTime?
  lastLoginIp         String?

  // SSO (future SwiftFox integration)
  ssoId       String? @unique // SwiftFox user ID when SSO active
  ssoProvider String? // 'swiftfox' when SSO active

  // Link to existing Clerk data for migration
  clerkUserId String? @unique

  // Migration Control (Phase 6)
  authMode       AuthMode  @default(CLERK)
  migratedAt     DateTime? // When user was migrated to custom auth
  migratedBy     String? // Admin who triggered migration
  migrationNotes String? // Any issues during migration
  clerkMetadata  Json? // Clerk user metadata backup for rollback

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String? // Admin who created this user

  // Relations
  sessions       AuthSession[]
  passwordResets AuthPasswordReset[]
  permissions    AuthUserPermission[]

  @@index([email])
  @@index([companyId])
  @@index([status])
  @@index([clerkUserId])
  @@index([ssoId])
  @@index([authMode])
}

model AuthCompany {
  id          String  @id @default(cuid())
  name        String
  tradingName String?

  // Link to existing Organization model (for data migration)
  organizationId String? @unique

  // Status
  status AuthCompanyStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users AuthUser[]

  @@index([name])
  @@index([organizationId])
}

model AuthSession {
  id        String @id @default(cuid())
  userId    String
  tokenHash String @unique // SHA-256 of JWT for revocation lookup

  // Device info
  userAgent String?
  ipAddress String?

  // App context
  application AuthApplicationType

  // Timestamps
  createdAt    DateTime @default(now())
  expiresAt    DateTime
  lastActiveAt DateTime @default(now())

  // Revocation
  revokedAt     DateTime?
  revokedBy     String?
  revokedReason String?

  user AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([tokenHash])
}

model AuthPasswordReset {
  id        String @id @default(cuid())
  userId    String
  tokenHash String @unique // SHA-256 of reset token

  // Request info
  requestedAt DateTime @default(now())
  requestedIp String?

  // Expiry (1 hour per requirements)
  expiresAt DateTime

  // Usage
  usedAt DateTime?
  usedIp String?

  user AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

model AuthUserPermission {
  id     String @id @default(cuid())
  userId String

  application AuthApplicationType
  permission  AuthPermission

  // Scope (optional, for company-specific permissions)
  companyId String?

  // Grant info
  grantedAt DateTime @default(now())
  grantedBy String

  user AuthUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, application, permission, companyId])
  @@index([userId])
}

model AuthAuditLog {
  id      BigInt @id @default(autoincrement())
  eventId String @default(uuid())

  // Actor
  actorId    String?
  actorEmail String?
  actorRole  String?
  ipAddress  String?
  userAgent  String?

  // Action
  action       String // e.g., "LOGIN", "LOGOUT", "PASSWORD_CHANGE", "SESSION_REVOKE"
  resourceType String // e.g., "AuthUser", "AuthSession"
  resourceId   String?

  // State Change
  previousState Json?
  newState      Json?
  metadata      Json?

  // Timestamp
  timestamp DateTime @default(now())

  @@index([resourceType, resourceId])
  @@index([actorId, timestamp])
  @@index([timestamp])
  @@index([action])
}
